<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mickey's Learning Hub - Enhanced with Tracing</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Font for Disney feel -->
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@700&family=Fredoka+One&display=swap" rel="stylesheet">
    
    <!-- OpenDyslexic Font for accessibility -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@open-dyslexic/open-dyslexic@1.0.3/css/open-dyslexic.css">
    
    <!-- MediaPipe Face Detection -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
    
    <style>
        /* MICKEY MOUSE THEME - PASTEL DISNEY STYLE */
        :root {
            --mickey-red: #d84a54; /* Pastel red/pink */
            --mickey-yellow: #e9a946; /* Pastel yellow */
            --mickey-black: #25221a; /* Dark pastel blue */
            --mickey-white: #e9e7db; /* Cream white */
            --mickey-blue: #8ac6d1; /* Pastel blue */
            --mickey-pink: #ffb8c6; /* Light pastel pink */
            --mickey-green: #95e1d3; /* Pastel green */
            --mickey-purple: #b8b8ff; /* Pastel purple */
            --mickey-bg: #fff5f5; /* Very light pastel pink */
        }

        body {
            margin: 0;
            padding: 20px;
            font-family: 'Fredoka One', cursive;
            background: linear-gradient(135deg, var(--mickey-bg) 0%, #ffe6e6 100%);
            min-height: 100vh;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(255, 255, 255, 0.8) 2px, transparent 2px),
                radial-gradient(circle at 90% 80%, rgba(255, 255, 255, 0.8) 2px, transparent 2px);
            background-size: 40px 40px;
            padding-top: 120px;
        }

        /* FIXED HEADER */
        .fixed-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(145deg, var(--mickey-pink), var(--mickey-red));
            border-bottom: 5px solid var(--mickey-black);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            z-index: 9999;
            padding: 15px 20px;
        }

        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .header-logo {
            display: flex;
            align-items: center;
            gap: 15px;
            color: var(--mickey-white);
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .header-logo:hover {
            transform: scale(1.05);
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: var(--mickey-yellow);
            border-radius: 50%;
            border: 3px solid var(--mickey-black);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--mickey-red);
        }

        .header-nav {
            display: flex;
            gap: 10px;
        }

        .nav-tab {
            padding: 12px 20px;
            background: var(--mickey-yellow);
            color: var(--mickey-black);
            border: 3px solid var(--mickey-black);
            border-radius: 15px;
            font-family: 'Fredoka One', cursive;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .nav-tab:hover {
            background: var(--mickey-white);
            transform: translateY(-3px);
            box-shadow: 0 5px 0 var(--mickey-black);
        }

        .nav-tab.active {
            background: var(--mickey-blue);
            color: var(--mickey-white);
        }

        /* CONTENT AREAS */
        .content-area {
            display: none;
            max-width: 1400px;
            margin: 0 auto;
        }

        .content-area.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .profile-content, .settings-content, .about-content {
            padding: 30px;
            background: var(--mickey-white);
            border-radius: 25px;
            border: 5px solid var(--mickey-black);
            box-shadow: 0 10px 0 var(--mickey-black);
            margin-top: 20px;
        }

        /* Form input focus styles */
        input:focus, select:focus {
            outline: none;
            border-color: var(--mickey-red);
            box-shadow: 0 0 10px rgba(255, 107, 139, 0.3);
            transform: translateY(-2px);
            transition: all 0.3s ease;
        }

        /* Demo credentials box */
        .demo-credentials {
            background: var(--mickey-yellow);
            padding: 15px;
            border-radius: 10px;
            border: 3px solid var(--mickey-black);
            margin-top: 15px;
            font-family: 'Comic Neue', cursive;
        }

        .demo-credentials code {
            background: var(--mickey-white);
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid var(--mickey-black);
            font-family: monospace;
            color: var(--mickey-red);
            margin-top: 16px;
            margin-right: 2px;
            margin-bottom: 2px;
            margin-left: 2px;
            }

        /* Dyslexia-friendly mode */
        body.dyslexia-mode {
            font-family: 'OpenDyslexic', 'Comic Sans MS', sans-serif !important;
            letter-spacing: 0.1em;
            line-height: 1.8;
            background: linear-gradient(135deg, #ffffcc 0%, #fff5cc 100%) !important;
        }

        /* DYSLEXIA-SPECIFIC STYLES */
        .dyslexia-text {
            font-family: 'OpenDyslexic', 'Comic Sans MS', sans-serif !important;
            letter-spacing: 0.15em;
            line-height: 2;
            word-spacing: 0.2em;
            font-size: 1.1em;
        }

        h1 {
            color: var(--mickey-black);
            font-size: 3rem;
            margin: 0 20px;
            text-align: center;
            letter-spacing: 2px;
            -webkit-background-clip: text;
            background-clip: text;
            position: relative;
            z-index: 2;
        }

        /* Your photo styling for agent */
        .agent-avatar img {
            width: 60px;
            object-fit: cover;
        }

        .agent-messages {
            height: 200px;
            overflow-y: auto;
            padding: 20px;
            background: linear-gradient(145deg, #fff9e6, #fff0cc);
        }

        .agent-message {
            margin-bottom: 15px;
            padding: 12px 18px;
            border-radius: 18px;
            max-width: 85%;
            position: relative;
            animation: messageSlide 0.3s ease;
        }

        .agent-message.bot {
            background: var(--mickey-blue);
            color: var(--mickey-white);
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }

        .agent-message.bot .mickey-message-avatar {
            width: 30px;
            height: 30px;
            background: var(--mickey-black);
            border-radius: 50%;
            border: 2px solid var(--mickey-red);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .agent-message.bot .mickey-message-avatar .mickey-mini-face {
            width: 20px;
            height: 20px;
            background: var(--mickey-black);
            border-radius: 50%;
            position: relative;
        }

        .agent-message.bot .mickey-message-avatar .mickey-mini-eye {
            position: absolute;
            width: 4px;
            height: 4px;
            background: white;
            border-radius: 50%;
            top: 5px;
        }

        .agent-message.bot .mickey-message-avatar .mickey-mini-eye.left {
            left: 4px;
        }

        .agent-message.bot .mickey-mini-eye.right {
            right: 4px;
        }

        .agent-message.bot .mickey-message-avatar .mickey-mini-smile {
            position: absolute;
            bottom: 3px;
            left: 4px;
            width: 12px;
            height: 6px;
            border-bottom: 2px solid white;
            border-radius: 0 0 10px 10px;
        }

        .agent-voice-controls {
            padding: 10px 15px;
            border-top: 2px solid var(--mickey-yellow);
            background: var(--mickey-white);
            display: flex;
            justify-content: center;
        }

        .voice-btn {
            padding: 8px 15px;
            background: var(--mickey-blue);
            color: var(--mickey-white);
            border: 2px solid var(--mickey-black);
            border-radius: 10px;
            font-family: 'Comic Neue', cursive;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .voice-btn:hover {
            background: var(--mickey-red);
        }

        .agent-minimize {
            position: absolute;
            top: 15px;
            right: 15px;
            background: transparent;
            border: none;
            color: var(--mickey-white);
            cursor: pointer;
            font-size: 1.2rem;
        }

        /* PROACTIVE INTERVENTION MODAL */
        .intervention-modal {
            display: none !important; /* Keep hidden by default */
            position: fixed !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
            width: 500px !important;
            background: var(--mickey-white) !important;
            border-radius: 25px !important;
            border: 5px solid var(--mickey-black) !important;
            box-shadow: 0 15px 0 var(--mickey-black), 0 25px 50px rgba(0,0,0,0.3) !important;
            z-index: 10003 !important; /* Higher than welcome screen */
            overflow: hidden !important;
            animation: interventionPop 0.5s ease !important;
        }

        .intervention-header {
            background: linear-gradient(145deg, var(--mickey-pink), var(--mickey-red));
            padding: 25px;
            text-align: center;
            color: var(--mickey-white);
        }

        .intervention-body {
            padding: 30px;
            text-align: center;
        }

        .intervention-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 25px;
        }

        .intervention-btn {
            padding: 18px;
            background: var(--mickey-yellow);
            color: var(--mickey-black);
            border: 3px solid var(--mickey-black);
            border-radius: 15px;
            font-family: 'Fredoka One', cursive;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .intervention-btn:hover {
            background: var(--mickey-blue);
            color: var(--mickey-white);
            transform: translateY(-3px);
        }

        .intervention-btn.easy {
            background: var(--mickey-green);
            color: white;
            border-color: #009900;
        }

        .intervention-btn.break {
            background: var(--mickey-yellow);
            color: var(--mickey-black);
        }

        .intervention-btn.next {
            background: var(--mickey-blue);
            color: white;
            border-color: #0055aa;
        }

        /* REAL FACE LANDMARKS VISUALIZATION */
        .face-detection-container {
            width: 100%;
            height: 200px;
            border: 4px solid var(--mickey-black);
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 15px;
            background: var(--mickey-white);
            position: relative;
        }

        #face-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }

        #face-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        /* SIDE COLLAPSIBLE */
        .side-collapsible {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 9997;
        }

        .side-toggle {
            width: 60px;
            height: 60px;
            background: var(--mickey-red);
            border-radius: 50%;
            border: 4px solid var(--mickey-black);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(255, 107, 139, 0.4);
            transition: all 0.3s;
            animation: pulse 2s infinite;
        }

        .side-toggle:hover {
            transform: scale(1.1);
        }

        .side-toggle i {
            color: var(--mickey-white);
            font-size: 1.5rem;
        }

        .side-bubbles {
            position: absolute;
            bottom: 70px;
            right: 0;
            display: none;
            flex-direction: column;
            gap: 15px;
            animation: slideUp 0.3s ease;
        }

        .side-bubbles.show {
            display: flex;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .side-bubble {
            width: 60px;
            height: 60px;
            background: var(--mickey-yellow);
            border-radius: 50%;
            border: 4px solid var(--mickey-black);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .side-bubble:hover {
            transform: scale(1.1) rotate(10deg);
            background: var(--mickey-white);
        }

        .side-bubble i {
            color: var(--mickey-red);
            font-size: 1.5rem;
        }

        .side-bubble.camera {
            background: var(--mickey-red);
        }

        .side-bubble.camera i {
            color: var(--mickey-white);
        }

        /* Speaking Bot Side Bubble */
        .side-bubble.speaking-bot {
            background: var(--mickey-pink);
            animation: pulse 2s infinite;
        }

        .side-bubble.speaking-bot i {
            color: var(--mickey-white);
        }

        /* Speaking bot animation when active */
        .side-bubble.speaking-bot.active {
            background: var(--mickey-green);
            transform: scale(1.1);
            box-shadow: 0 0 20px var(--mickey-green);
        }

        /* Speaking Bot Message Indicator */
        .bot-message-indicator {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            background: var(--mickey-red);
            border-radius: 50%;
            border: 2px solid var(--mickey-white);
            display: none;
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .side-bubble.speaking-bot.has-message .bot-message-indicator {
            display: block;
        }

        /* COLLAPSIBLE CONTROLS */
        .collapsible-controls {
            position: fixed;
            top: 120px;
            right: 30px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 9999;
        }

        .collapsible-content {
            display: none;
            position: absolute;
            top: 60px;
            right: 0;
            background: var(--mickey-white);
            border-radius: 20px;
            border: 4px solid var(--mickey-black);
            padding: 20px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            z-index: 9997;
            width: 300px;
        }

        .collapsible-content.active {
            display: block;
            animation: slideInRight 0.3s ease;
        }

        .collapsible-close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            background: var(--mickey-red);
            color: var(--mickey-white);
            border: 3px solid var(--mickey-black);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            z-index: 9998;
            transition: all 0.3s;
        }

        .collapsible-close-btn:hover {
            background: var(--mickey-blue);
            transform: rotate(90deg) scale(1.1);
        }

        .camera-container {
            width: 300px;
            position: relative;
        }

        .camera-status-indicator {
            position: fixed;
            bottom: 30px;
            right: 100px;
            width: 20px;
            height: 20px;
            background: var(--mickey-green);
            border-radius: 50%;
            border: 2px solid var(--mickey-black);
            box-shadow: 0 0 10px var(--mickey-green);
            z-index: 9995;
            animation: pulse-green 2s infinite;
            display: none;
        }

        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(149, 225, 211, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(149, 225, 211, 0); }
            100% { box-shadow: 0 0 0 0 rgba(149, 225, 211, 0); }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes interventionPop {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            70% { transform: translate(-50%, -50%) scale(1.05); }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        /* LEARNING CONTENT GRID - MICKEY STYLE */
        .modules-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 30px;
            margin-top: 40px;
        }

        .module-card {
            background: linear-gradient(145deg, var(--mickey-white), #f5f0e6);
            border-radius: 25px;
            padding: 25px;
            box-shadow: 
                0 10px 0 var(--mickey-black),
                0 15px 20px rgba(0,0,0,0.1);
            border: 5px solid var(--mickey-black);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
            min-height: 300px;
            display: flex;
            flex-direction: column;
        }

        .module-card:hover {
            transform: translateY(-10px) rotate(1deg);
            box-shadow: 
                0 15px 0 var(--mickey-black),
                0 25px 30px rgba(0,0,0,0.2);
            border-color: var(--mickey-pink);
        }

        .module-title {
            font-size: 1.6rem;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--mickey-red);
            text-shadow: 2px 2px 0 var(--mickey-yellow);
            font-family: 'Fredoka One', cursive;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .module-title i {
            color: var(--mickey-black);
            background: var(--mickey-yellow);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid var(--mickey-black);
        }

        .module-desc {
            color: var(--mickey-blue);
            font-size: 1.1rem;
            line-height: 1.6;
            font-family: 'Comic Neue', cursive;
            padding-left: 10px;
            border-left: 4px solid var(--mickey-yellow);
            flex-grow: 1;
            margin-bottom: 20px;
        }

        /* MODULE CONTROLS */
        .module-controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .module-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 20px;
            font-family: 'Fredoka One', cursive;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-grow: 1;
            justify-content: center;
        }

        .start-btn {
            background: linear-gradient(145deg, var(--mickey-pink), var(--mickey-red));
            color: var(--mickey-white);
            border: 3px solid var(--mickey-black);
        }

        .start-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(255, 107, 139, 0.4);
        }

        .view-btn {
            background: linear-gradient(145deg, var(--mickey-blue), #6aa8b5);
            color: var(--mickey-white);
            border: 3px solid var(--mickey-black);
        }

        .view-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(138, 198, 209, 0.4);
        }

        /* MODULE CONTENT AREA */
        .module-content-area {
            grid-column: 1 / -1;
            background: var(--mickey-white);
            border-radius: 25px;
            padding: 30px;
            margin-top: 40px;
            border: 5px solid var(--mickey-black);
            box-shadow: 0 10px 0 var(--mickey-black);
            display: none;
        }

        .module-content-area.active {
            display: block;
            animation: slideIn 0.5s ease;
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 4px solid var(--mickey-yellow);
        }

        .close-module {
            background: var(--mickey-red);
            color: var(--mickey-white);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            border: 3px solid var(--mickey-black);
        }

        .close-module:hover {
            transform: rotate(90deg);
        }

        .content-body {
            min-height: 400px;
        }

        /* GAME/ACTIVITY STYLES */
        .game-container {
            background: var(--mickey-yellow);
            padding: 25px;
            border-radius: 20px;
            border: 4px solid var(--mickey-black);
            margin-bottom: 30px;
        }

        .game-question {
            font-size: 1.4rem;
            color: var(--mickey-black);
            margin-bottom: 20px;
            font-family: 'Fredoka One', cursive;
        }

        .game-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .game-option {
            padding: 15px;
            background: var(--mickey-white);
            border: 3px solid var(--mickey-black);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Comic Neue', cursive;
            font-weight: 700;
            text-align: center;
        }

        .game-option:hover {
            transform: translateY(-5px);
            background: var(--mickey-red);
            color: var(--mickey-white);
        }

        .game-option.correct {
            background: var(--mickey-green);
            color: white;
            border-color: var(--mickey-green);
        }

        .game-option.wrong {
            background: var(--mickey-red);
            color: white;
            border-color: var(--mickey-red);
        }

        .game-feedback {
            padding: 15px;
            background: var(--mickey-blue);
            color: var(--mickey-white);
            border-radius: 15px;
            display: none;
            margin-bottom: 20px;
            border: 3px solid var(--mickey-black);
        }

        .game-feedback.show {
            display: block;
            animation: bounceIn 0.5s;
        }

        .game-progress {
            background: var(--mickey-white);
            padding: 20px;
            border-radius: 15px;
            border: 4px solid var(--mickey-black);
            margin-top: 30px;
        }

        .progress-bar {
            height: 30px;
            background: linear-gradient(90deg, var(--mickey-yellow), var(--mickey-pink));
            border-radius: 15px;
            width: 0%;
            transition: width 0.5s ease;
            border: 3px solid var(--mickey-black);
        }

        .progress-text {
            text-align: center;
            margin-top: 10px;
            font-family: 'Comic Neue', cursive;
            font-weight: 700;
            color: var(--mickey-blue);
        }

        /* GAME NAVIGATION */
        .game-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 3px dashed var(--mickey-red);
        }

        .game-counter {
            font-family: 'Fredoka One', cursive;
            color: var(--mickey-red);
            font-size: 1.2rem;
            background: var(--mickey-white);
            padding: 10px 20px;
            border-radius: 20px;
            border: 3px solid var(--mickey-black);
        }

        .nav-btn {
            padding: 12px 25px;
            background: var(--mickey-blue);
            color: var(--mickey-white);
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-family: 'Fredoka One', cursive;
            border: 3px solid var(--mickey-black);
        }

        .nav-btn:hover {
            background: var(--mickey-red);
            transform: scale(1.05);
        }

        .nav-btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }

        /* PROFILE CAPABILITY MODULES */
        .capability-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .capability-card {
            background: var(--mickey-yellow);
            padding: 20px;
            border-radius: 15px;
            border: 4px solid var(--mickey-black);
            transition: all 0.3s ease;
        }

        .capability-card.blue {
            background: var(--mickey-blue);
        }

        .capability-card.red {
            background: var(--mickey-red);
        }

        .capability-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .skill-tag {
            background: var(--mickey-blue);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            display: inline-block;
            margin: 2px;
        }

        .skill-tag.yellow {
            background: var(--mickey-yellow);
            color: var(--mickey-black);
        }

        .skill-tag.white {
            background: var(--mickey-white);
            color: var(--mickey-blue);
        }

        /* BREAK TIMER */
        .break-timer {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 400px;
            background: var(--mickey-white);
            border-radius: 25px;
            border: 5px solid var(--mickey-black);
            box-shadow: 
                0 15px 0 var(--mickey-black),
                0 25px 50px rgba(0,0,0,0.3);
            z-index: 10001;
            display: none;
            overflow: hidden;
        }

        .break-timer.show {
            display: block;
            animation: interventionPop 0.5s;
        }

        .timer-display {
            font-size: 4rem;
            color: var(--mickey-red);
            margin: 20px 0;
            font-family: 'Fredoka One', cursive;
            text-align: center;
        }

        .breathing-animation {
            background: var(--mickey-yellow);
            padding: 20px;
            border-radius: 15px;
            border: 3px solid var(--mickey-black);
            margin: 20px 0;
            text-align: center;
            font-size: 1.2rem;
            color: var(--mickey-red);
        }

        /* MICKEY DECORATIONS */
        .mickey-dot {
            position: fixed;
            width: 20px;
            height: 20px;
            background: var(--mickey-red);
            border-radius: 50%;
            border: 3px solid var(--mickey-black);
            z-index: -1;
            animation: float 20s infinite linear;
        }

        .polka-dot {
            position: fixed;
            width: 40px;
            height: 40px;
            background: var(--mickey-yellow);
            border-radius: 50%;
            border: 4px solid var(--mickey-white);
            z-index: -1;
            opacity: 0.3;
        }

        @keyframes float {
            0% { transform: translateY(0) rotate(0deg); }
            100% { transform: translateY(-100vh) rotate(360deg); }
        }

        @keyframes bounceIn {
            0% { transform: scale(0.5); opacity: 0; }
            70% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }

        /* TRACING MODULE STYLES */
        .tracing-game-container {
            background: var(--mickey-white);
            border-radius: 25px;
            padding: 30px;
            border: 5px solid var(--mickey-black);
            box-shadow: 0 10px 0 var(--mickey-black);
            margin: 20px 0;
        }

        .tracing-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .tracing-instructions {
            background: var(--mickey-yellow);
            padding: 10px 20px;
            border-radius: 15px;
            border: 3px solid var(--mickey-black);
            display: inline-block;
            font-family: 'Comic Neue', cursive;
            color: var(--mickey-black);
        }

        .tracing-area {
            max-width: 800px;
            margin: 0 auto;
        }

        .letter-display {
            text-align: center;
            margin-bottom: 30px;
        }

        .target-letter {
            font-size: 120px;
            font-weight: bold;
            color: var(--mickey-red);
            text-shadow: 3px 3px 0 var(--mickey-yellow);
            margin-bottom: 10px;
            font-family: 'OpenDyslexic', sans-serif;
        }

        .canvas-container {
            position: relative;
            width: 100%;
            height: 300px;
            background: #f9f9f9;
            border-radius: 15px;
            border: 4px solid var(--mickey-black);
            margin-bottom: 20px;
            touch-action: none;
        }

        #tracing-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: crosshair;
            z-index: 2;
        }

        .tracing-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            pointer-events: none;
        }

        .start-dot {
            position: absolute;
            width: 20px;
            height: 20px;
            background: var(--mickey-green);
            border-radius: 50%;
            border: 3px solid var(--mickey-black);
            transform: translate(-50%, -50%);
            animation: pulse-dot 2s infinite;
        }

        @keyframes pulse-dot {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.2); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        .trace-guide {
            position: absolute;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at center, transparent 50%, rgba(0,0,0,0.1) 100%);
            opacity: 0.3;
        }

        .tracing-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .tracing-btn {
            padding: 12px 20px;
            border: 3px solid var(--mickey-black);
            border-radius: 15px;
            font-family: 'Fredoka One', cursive;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--mickey-white);
            color: var(--mickey-black);
        }

        .tracing-btn:hover {
            transform: translateY(-3px);
        }

        .tracing-btn.success {
            background: var(--mickey-blue);
            color: var(--mickey-white);
        }

        .tracing-btn.hint {
            background: var(--mickey-yellow);
            color: var(--mickey-black);
        }

        .tracing-btn.demo {
            background: var(--mickey-red);
            color: var(--mickey-white);
        }

        .tracing-feedback {
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: none;
            border: 3px solid var(--mickey-black);
        }

        .tracing-feedback.show {
            display: block;
            animation: fadeIn 0.5s;
        }

        .tracing-feedback.success {
            background: #d4edda;
            border-color: var(--mickey-green);
        }

        .tracing-feedback.needs-improvement {
            background: #fff3cd;
            border-color: var(--mickey-yellow);
        }

        .tracing-progress {
            background: var(--mickey-white);
            padding: 15px;
            border-radius: 15px;
            border: 3px solid var(--mickey-black);
        }

        .tracing-progress-bar {
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .tracing-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--mickey-yellow), var(--mickey-pink));
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 10px;
        }

        /* WELCOME SCREEN STYLES */
        body.welcome-active {
            overflow: hidden;
        }

        body.welcome-active .fixed-header,
        body.welcome-active .content-area,
        body.welcome-active .side-collapsible,
        body.welcome-active .camera-status-indicator,
        body.welcome-active .collapsible-controls,
        body.welcome-active .polka-dot,
        body.welcome-active .mickey-dot {
            display: none !important;
        }

        body.welcome-active {
            padding: 0 !important;
            background: linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.4)), 
                        url('images/wallpaper.png') center/cover no-repeat !important;
            background-image: none !important;
        }

        .welcome-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.4)), 
                    url('images/the road in mickey mouse wallpaper.jpg') center/cover no-repeat;
            z-index: 10002;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.5s ease;
        }

        .welcome-content {
            background: rgba(255, 249, 240, 0.95);
            border-radius: 30px;
            border: 8px solid var(--mickey-black);
            box-shadow: 0 15px 0 var(--mickey-black), 0 30px 50px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow: hidden;
            animation: bounceIn 0.8s ease;
            display: flex;
            flex-direction: column;
        }

        .welcome-header {
            padding: 30px 20px;
            text-align: center;
            position: relative;
            flex-shrink: 0;
        }

        .mickey-welcome-logo {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            margin-bottom: 20px;
        }

        .mickey-welcome-logo img {
            height: 150px;
            margin-bottom: 20px;
            object-fit: cover;
        }

        .welcome-header h1 {
            font-size: 2.5rem;
            margin: 0;
        }

        .welcome-body {
            text-align: center;
            flex: 1;
            overflow-y: auto;
            max-height: calc(90vh - 200px);
            padding: 0 20px 20px 20px;
        }

        .welcome-message {
            margin-bottom: 20px;
        }

        .welcome-message p {
            color: #25221a;
            font-size: 1.4rem;
            font-family: 'Comic Neue', cursive;
            margin: 15px 0;
        }

        .welcome-features {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .feature {
            background: var(--mickey-yellow);
            padding: 12px 20px;
            border-radius: 15px;
            border: 3px solid var(--mickey-black);
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: 'Fredoka One', cursive;
            color: var(--mickey-black);
            font-size: 1rem;
        }

        .feature i {
            color: var(--mickey-red);
            font-size: 1.3rem;
        }

        /* Forms Container - NO LONGER SCROLLABLE */
        .forms-container {
            margin-top: 20px;
            padding-right: 10px;
            /* Removed: max-height and overflow-y */
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* Welcome body scrollbar */
        .welcome-body::-webkit-scrollbar {
            width: 8px;
        }

        .welcome-body::-webkit-scrollbar-track {
            background: transparent;
            border-radius: 10px;
        }

        .welcome-body::-webkit-scrollbar-thumb {
            background: var(--mickey-blue);
            border-radius: 10px;
            border: 2px solid var(--mickey-black);
        }

        .welcome-body::-webkit-scrollbar-thumb:hover {
            background: var(--mickey-green);
        }

        
        /* Forms Container */
.forms-scrollable-container {
    max-height: 400px;
    overflow-y: auto;
    padding-right: 10px;
    margin-top: 20px;
}

.forms-scrollable-container::-webkit-scrollbar {
    width: 8px;
}

.forms-scrollable-container::-webkit-scrollbar-track {
    background: var(--mickey-yellow);
    border-radius: 10px;
}

.forms-scrollable-container::-webkit-scrollbar-thumb {
    background: var(--mickey-red);
    border-radius: 10px;
    border: 2px solid var(--mickey-black);
}

.forms-scrollable-container::-webkit-scrollbar-thumb:hover {
    background: var(--mickey-pink);
}

/* Form Container */
.form-container {
    background: var(--mickey-white);
    padding: 20px;
    border-radius: 15px;
    border: 3px solid var(--mickey-black);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    margin: 20px 0;
    display: none;
}

.form-title {
    color: var(--mickey-red);
    text-align: center;
    margin-bottom: 20px;
    font-family: 'Fredoka One', cursive;
}

/* Form Fields */
.form-field {
    margin-bottom: 15px;
}

.form-label {
    display: block;
    margin-bottom: 5px;
    color: var(--mickey-black);
    font-family: 'Fredoka One', cursive;
}

.form-input {
    width: 95%;
    padding: 12px 15px;
    border-radius: 10px;
    border: 3px solid var(--mickey-black);
    font-family: 'Comic Neue', cursive;
    font-size: 1rem;
    background: var(--mickey-white);
}

.form-input:focus {
    outline: none;
    border-color: var(--mickey-red);
    box-shadow: 0 0 10px rgba(255, 107, 139, 0.3);
    transform: translateY(-2px);
    transition: all 0.3s ease;
}

.form-select {
    width: 100%;
    padding: 12px 15px;
    border-radius: 10px;
    border: 3px solid var(--mickey-black);
    font-family: 'Comic Neue', cursive;
    font-size: 1rem;
    background: var(--mickey-white);
    cursor: pointer;
}

.form-select:focus {
    outline: none;
    border-color: var(--mickey-red);
    box-shadow: 0 0 10px rgba(255, 107, 139, 0.3);
    transform: translateY(-2px);
    transition: all 0.3s ease;
}

/* Remember Me Checkbox */
.remember-me {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 15px;
}

.remember-me input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.remember-me label {
    color: var(--mickey-black);
    font-family: 'Comic Neue', cursive;
    cursor: pointer;
}

/* Form Buttons */
.form-submit-btn {
    width: 100%;
    margin-bottom: 15px;
}

/* Password Hint */
.password-hint {
    margin-top: 5px;
    font-size: 0.8rem;
    color: var(--mickey-blue);
    font-family: 'Comic Neue', cursive;
}

/* Demo Credentials */
.demo-credentials {
    background: var(--mickey-yellow);
    padding: 15px;
    border-radius: 10px;
    border: 3px solid var(--mickey-black);
    margin-top: 15px;
    font-family: 'Comic Neue', cursive;
}

.demo-title {
    padding: 2px;
    color: var(--mickey-black);
    font-size: 0.9rem;
    margin: 0 0 10px 0;
}

.credentials-list {
    margin: 8px 0;
}

.credential-item {
    align-items: center;
    gap: 5px;
    margin-bottom: 6px;
}

.credential-item:last-child {
    margin-bottom: 0;
    margin-top: 6px;
}

.credential-icon {
    font-size: 0.8rem;
}

.student-cred .credential-icon {
    color: var(--mickey-blue);
}

.teacher-cred .credential-icon {
    color: var(--mickey-red);
}

.credential-label {
    font-weight: bold;
    color: var(--mickey-black);
}

.credential-username,
.credential-password {
    background: var(--mickey-white);
    padding: 2px 6px;
    border-radius: 4px;
    border: 1px solid var(--mickey-black);
    font-family: monospace;
    color: var(--mickey-red);
}

.credential-separator {
    margin: 0 5px;
    color: var(--mickey-black);
}

/* Form Footer */
.form-footer {
    text-align: center;
    margin-top: 15px;
}

.form-footer p {
    color: var(--mickey-blue);
    font-family: 'Comic Neue', cursive;
    margin: 0;
}

.form-link {
    color: var(--mickey-red);
    text-decoration: underline;
    cursor: pointer;
    font-weight: bold;
}

.form-link:hover {
    color: var(--mickey-pink);
}

/* Welcome Actions */
.welcome-actions {
    display: flex;
    gap: 20px;
    justify-content: center;
    margin: 20px 0;
}

/* Responsive Design for Forms */
@media (max-width: 768px) {
    .forms-scrollable-container {
        max-height: 300px;
    }
    
    .form-container {
        padding: 15px;
    }
    
    .form-input,
    .form-select {
        width: 100%;
        padding: 10px 12px;
    }
    
    .welcome-actions {
        flex-direction: column;
        gap: 15px;
    }
    
    .credential-item {
        flex-wrap: wrap;
        gap: 3px;
    }
    
    .credential-separator {
        margin: 0 3px;
    }
}

        .start-learning-btn, .explore-btn {
            padding: 15px 30px;
            border: 4px solid var(--mickey-black);
            border-radius: 20px;
            font-family: 'Fredoka One', cursive;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .start-learning-btn {
            background: var(--mickey-red);
            color: var(--mickey-white);
        }

        .explore-btn {
            background: var(--mickey-blue);
            color: var(--mickey-white);
        }

        .start-learning-btn:hover, .explore-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 0 var(--mickey-black);
        }

        .start-learning-btn:hover {
            background: var(--mickey-pink);
        }

        .explore-btn:hover {
            background: #6aa8b5;
        }

        /* RESPONSIVE DESIGN */
        @media (max-width: 768px) {
            body {
                padding-top: 160px;
            }
            
            .fixed-header {
                padding: 10px;
            }
            
            .header-container {
                flex-direction: column;
                gap: 10px;
            }
            
            .header-nav {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .nav-tab {
                padding: 8px 15px;
                font-size: 0.9rem;
            }
            
            .side-collapsible {
                bottom: 20px;
                right: 20px;
            }
            
            .collapsible-controls {
                top: 160px;
                right: 20px;
            }
            
            .modules-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .game-options {
                grid-template-columns: 1fr;
            }
            
            .intervention-modal {
                width: 90vw;
            }
            
            .break-timer {
                width: 90vw;
            }
            
            .module-content-area {
                margin: 20px 10px;
                padding: 20px;
            }
            
            .capability-grid {
                grid-template-columns: 1fr;
            }
            
            .target-letter {
                font-size: 80px;
            }
            
            .canvas-container {
                height: 250px;
            }
            
            .tracing-controls {
                flex-direction: column;
                align-items: center;
            }
            
            .tracing-btn {
                width: 100%;
                justify-content: center;
            }
            
            .welcome-content {
                width: 95%;
                margin: 20px;
                max-height: 95vh;
            }
            
            .welcome-header {
                padding: 20px 10px;
            }
            
            .welcome-header h1 {
                font-size: 1.8rem;
            }
            
            .welcome-message p {
                font-size: 1.1rem;
            }
            
            .welcome-features {
                flex-direction: column;
                gap: 15px;
            }
            
            .welcome-actions {
                flex-direction: column;
            }
            
            .welcome-body {
                padding: 20px;
                max-height: calc(95vh - 150px);
            }
            
            .forms-container {
                max-height: 300px;
            }
            
            .start-learning-btn, .explore-btn {
                padding: 12px 20px;
                font-size: 1.1rem;
            }
        }

        /* INDEPENDENT SPEAKING BOT SYSTEM */
        .speaking-bot-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(26, 26, 46, 0.95);
            z-index: 10005; /* Higher than everything else */
            animation: fadeIn 0.3s ease;
        }

        .speaking-bot-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 500px;
            padding: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px;
            animation: slideUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes slideUp {
            0% { 
                transform: translate(-50%, -40%); 
                opacity: 0; 
            }
            100% { 
                transform: translate(-50%, -50%); 
                opacity: 1; 
            }
        }

        /* Bot speaker avatar */
        .bot-speaker-avatar {
            position: relative;
            width: 180px;
            height: 180px;
        }

        .bot-speaker-circle {
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 2;
            transition: all 0.3s;
            background: transparent !important; /* Ensure it's transparent */
            box-shadow: none !important; /* Remove any box shadow */
        }

        .speaking .bot-speaker-circle {
            animation: speakingPulse 1.5s infinite alternate;
        }

        @keyframes speakingPulse {
            0% { 
                transform: scale(1);
                box-shadow: 
                    0 0 30px rgba(255, 107, 139, 0.7),
                    0 0 60px rgba(255, 107, 139, 0.4);
            }
            100% { 
                transform: scale(1.05);
                box-shadow: 
                    0 0 40px rgba(255, 107, 139, 0.9),
                    0 0 80px rgba(255, 107, 139, 0.6);
            }
        }

        .bot-speaker-img {
            width: 295%;
            height: 100%;
            object-fit: cover;
            transform: translate(0px, -90px);
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
        }

        /* Speaker waves */
        .speaker-waves {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 600px;
            height: 600px;
            display: none;
        }

        .speaking .speaker-waves {
            display: block;
        }

        .speaker-wave {
            position: absolute;
            top: 60px;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px solid rgba(149, 225, 211, 0.3);
            animation: waveExpand 1.5s infinite linear;
        }

        .speaker-wave:nth-child(1) {
            animation-delay: 0s;
        }

        .speaker-wave:nth-child(2) {
            animation-delay: 0.5s;
        }

        .speaker-wave:nth-child(3) {
            animation-delay: 1s;
        }

        @keyframes waveExpand {
            0% {
                transform: scale(0.8);
                opacity: 1;
                border-width: 2px;
            }
            100% {
                transform: scale(1.5);
                opacity: 0;
                border-width: 1px;
            }
        }

        /* Bot speaker status */
        .bot-speaker-status {
            text-align: center;
            color: white;
            width: 100%;
        }

        .status-text {
            font-size: 1.3rem;
            margin-bottom: 15px;
            font-family: 'Comic Neue', cursive;
            color: #95e1d3;
            min-height: 30px;
            transition: all 0.3s;
        }

        .speaking .status-text {
            animation: textGlow 1s infinite alternate;
        }

        @keyframes textGlow {
            0% { text-shadow: 0 0 5px rgba(149, 225, 211, 0.5); }
            100% { text-shadow: 0 0 10px rgba(149, 225, 211, 0.8); }
        }

        /* VOICE WAVE VISUALIZATION */
        .voice-wave-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            height: 30px;
            margin-top: 15px;
            width: 100%;
        }

        .voice-wave-bar {
            width: 6px;
            height: 10px;
            background: linear-gradient(to top, #ff6b8b, #ffd166);
            border-radius: 3px;
            transition: all 0.3s ease;
            animation: wavePulse 1.5s infinite ease-in-out;
        }

        .voice-wave-bar:nth-child(1) { animation-delay: 0s; }
        .voice-wave-bar:nth-child(2) { animation-delay: 0.1s; }
        .voice-wave-bar:nth-child(3) { animation-delay: 0.2s; }
        .voice-wave-bar:nth-child(4) { animation-delay: 0.3s; }
        .voice-wave-bar:nth-child(5) { animation-delay: 0.4s; }

        @keyframes wavePulse {
            0%, 100% { 
                height: 10px;
                opacity: 0.5;
                transform: scaleY(1);
            }
            50% { 
                height: 25px;
                opacity: 1;
                transform: scaleY(1.3);
            }
        }

        /* Speaking state adjustments */
        .speaking .voice-wave-bar {
            animation-play-state: running;
        }

        /* Non-speaking state */
        :not(.speaking) .voice-wave-bar {
            animation-play-state: paused;
            height: 8px;
            opacity: 0.3;
        }

        /* Continue button */
        .bot-speaker-continue {
            padding: 12px 25px;
            background: rgba(255, 107, 139, 0.8);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            font-family: 'Fredoka One', cursive;
            font-size: 1.1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
            opacity: 0;
            pointer-events: none;
            transform: translate(350px, 100px);
        }

        .bot-speaker-continue.show {
            opacity: 1;
            pointer-events: all;
        }

        .bot-speaker-continue:hover {
            background: rgba(255, 107, 139, 1);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(255, 107, 139, 0.4);
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .speaking-bot-container {
                width: 95%;
                padding: 30px 20px;
            }
            
            .bot-speaker-avatar {
                width: 150px;
                height: 150px;
            }
            
            .bot-speaker-circle {
                width: 120px;
                height: 120px;
            }
            
            .speaker-waves {
                width: 180px;
                height: 180px;
            }
            
            .status-text {
                font-size: 1.1rem;
            }
        }

        @media (max-width: 480px) {
            .bot-speaker-avatar {
                width: 120px;
                height: 120px;
            }
            
            .bot-speaker-circle {
                width: 100px;
                height: 100px;
            }
            
            .speaker-waves {
                width: 150px;
                height: 150px;
            }
            
            .speaking-bot-container {
                padding: 25px 15px;
            }
        }

        /* Small notification style for quick messages */
        .bot-mini-notification {
            position: fixed;
            bottom: 100px;
            right: 20px;
            background: rgba(255, 107, 139, 0.9);
            color: white;
            padding: 10px 15px;
            border-radius: 15px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            font-family: 'Comic Neue', cursive;
            font-size: 0.9rem;
            z-index: 10006;
            display: none;
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>
    
    <!-- SPEAKING BOT OVERLAY (Full Screen) -->
    <div class="speaking-bot-overlay" id="speaking-bot-overlay">
        <div class="speaking-bot-container" id="speaking-bot-container">
            <!-- Bot speaker avatar -->
            <div class="bot-speaker-avatar">
                <div class="bot-speaker-circle" id="bot-speaker-circle">
                    <img src="images/toodles.png" alt="Speaking Bot" class="bot-speaker-img">
                </div>
                <!-- Speaker waves animation -->
                <div class="speaker-waves" id="speaker-waves">
                    <div class="speaker-wave"></div>
                    <div class="speaker-wave"></div>
                    <div class="speaker-wave"></div>
                </div>
            </div>
            
            <!-- Continue button -->
            <button class="bot-speaker-continue" id="bot-speaker-continue">
                <i class="fas fa-check"></i> Continue
            </button>
        </div>
    </div>

    <!-- WELCOME SCREEN -->
    <div class="welcome-screen" id="welcome-screen">
        <div class="welcome-content">
            <div class="welcome-header">
                <div class="mickey-welcome-logo">
                    <img src="images/Mickey_Mouse_Clubhouse_logo.png" alt="Your Photo" class="user-photo-img">
                    <h1>Welcome to Mickey's Learning Hub!</h1>
                </div>
            </div>
            <div class="welcome-body">
                
                <!-- SCROLLABLE CONTAINER FOR FORMS -->
                <div class="forms-container" id="forms-container">
                    <!-- BUTTONS ONLY - NO FORMS INITIALLY -->
                    <div class="welcome-actions" id="welcome-buttons">
                        <button class="start-learning-btn" id="show-login-btn">
                            <i class="fas fa-sign-in-alt"></i> Login Now
                        </button>
                        <button class="explore-btn" id="show-register-btn">
                            <i class="fas fa-user-plus"></i> Register Now
                        </button>
                    </div>
                    
                    <!-- LOGIN FORM (HIDDEN BY DEFAULT) -->
                    <div id="login-form-container" class="form-container">
                        <h3 class="form-title">
                            <i class="fas fa-sign-in-alt"></i> Login
                        </h3>
                        
                        <div class="form-field">
                            <label class="form-label">
                                <i class="fas fa-user"></i> Username
                            </label>
                            <input type="text" id="login-username" 
                                placeholder="Enter your username" 
                                class="form-input">
                        </div>
                        
                        <div class="form-field">
                            <label class="form-label">
                                <i class="fas fa-key"></i> Password
                            </label>
                            <input type="password" id="login-password" 
                                placeholder="Enter your password" 
                                class="form-input">
                        </div>
                        
                        <div class="remember-me">
                            <input type="checkbox" id="remember-me">
                            <label for="remember-me">Remember me</label>
                        </div>
                        
                        <button class="start-learning-btn form-submit-btn" onclick="submitLogin()">
                            <i class="fas fa-sign-in-alt"></i> Login Now
                        </button>
                        
                        <!-- Demo credentials -->
                        <div class="demo-credentials">
                            <p class="demo-title">
                                <strong><i class="fas fa-lightbulb"></i> Demo Credentials:</strong>
                            </p>
                            <div class="credentials-list">
                                <div class="credential-item student-cred">
                                    <i class="fas fa-user-graduate credential-icon"></i>
                                    <span class="credential-label">Student:</span>
                                    <code class="credential-username">student123</code>
                                    <span class="credential-separator">/</span>
                                    <code class="credential-password">student123</code>
                                </div>
                                <div class="credential-item teacher-cred">
                                    <i class="fas fa-chalkboard-teacher credential-icon"></i>
                                    <span class="credential-label">Teacher:</span>
                                    <code class="credential-username">teacher123</code>
                                    <span class="credential-separator">/</span>
                                    <code class="credential-password">teacher123</code>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-footer">
                            <p>
                                Don't have an account? 
                                <a href="#" onclick="showRegisterForm()" class="form-link">
                                    Register here
                                </a>
                            </p>
                        </div>
                    </div>
                    
                    <!-- REGISTER FORM (HIDDEN BY DEFAULT) -->
                    <div id="register-form-container" class="form-container">
                        <h3 class="form-title">
                            <i class="fas fa-user-plus"></i> Register
                        </h3>
                        
                        <div class="form-field">
                            <label class="form-label">
                                <i class="fas fa-user"></i> Full Name
                            </label>
                            <input type="text" id="register-name" 
                                placeholder="Enter your full name" 
                                class="form-input">
                        </div>
                        
                        <div class="form-field">
                            <label class="form-label">
                                <i class="fas fa-at"></i> Username
                            </label>
                            <input type="text" id="register-username" 
                                placeholder="Choose a username" 
                                class="form-input">
                        </div>
                        
                        <div class="form-field">
                            <label class="form-label">
                                <i class="fas fa-key"></i> Password
                            </label>
                            <input type="password" id="register-password" 
                                placeholder="Create a password" 
                                class="form-input">
                            <div class="password-hint">
                                <i class="fas fa-info-circle"></i> Must be at least 6 characters
                            </div>
                        </div>
                        
                        <div class="form-field">
                            <label class="form-label">
                                <i class="fas fa-user-tag"></i> I am a...
                            </label>
                            <select id="register-role" class="form-select">
                                <option value="student">Student</option>
                                <option value="teacher">Teacher</option>
                                <option value="parent">Parent</option>
                            </select>
                        </div>
                        
                        <button class="explore-btn form-submit-btn" onclick="submitRegistration()">
                            <i class="fas fa-check"></i> Create Account
                        </button>
                        
                        <div class="form-footer">
                            <p>
                                Already have an account? 
                                <a href="#" onclick="showLoginForm()" class="form-link">
                                    Login here
                                </a>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- FIXED HEADER -->
    <header class="fixed-header">
        <div class="header-container">
            <div class="header-logo">
                <div class="logo-icon">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <span>Mickey's Learning Hub</span>
            </div>
            
            <nav class="header-nav">
                <a href="#" class="nav-tab active" id="game-tab">
                    <i class="fas fa-gamepad"></i> Game Center
                </a>
                <a href="#" class="nav-tab" id="profile-tab">
                    <i class="fas fa-user"></i> Profile
                </a>
                <a href="#" class="nav-tab" id="about-tab">
                    <i class="fas fa-info-circle"></i> About Us
                </a>
                <a href="#" class="nav-tab" id="settings-tab">
                    <i class="fas fa-cog"></i> Settings
                </a>
            </nav>
        </div>
    </header>
    
    <!-- SIDE BUBBLES  (QUICK)-->
    <div class="side-collapsible" id="side-collapsible">
        <div class="side-toggle" id="side-toggle">
            <i class="fas fa-plus"></i>
        </div>
        <div class="side-bubbles" id="side-bubbles">
            <div class="side-bubble camera" id="side-camera" title="Camera Controls">
                <i class="fas fa-camera"></i>
            </div>
            <!-- Speaking Bot Bubble -->
            <div class="side-bubble speaking-bot" id="side-speaking-bot" title="Click to talk">
                <i class="fas fa-microphone"></i>
            </div>
        </div>
    </div>
    
    <!-- Camera Status Indicator -->
    <div class="camera-status-indicator" id="camera-status-indicator" title="Camera & Emotion Detection Active"></div>

    <!-- CAMERA COLLAPSIBLE CONTENT -->
    <div class="collapsible-controls" id="collapsible-controls">
        <div class="collapsible-content" id="camera-content">
            <button class="collapsible-close-btn" id="close-camera-content" title="Close camera panel (detection continues)">
                <i class="fas fa-times"></i>
            </button>
            <div class="camera-container">
                <div class="face-detection-container">
                    <video id="face-video" playsinline></video>
                    <canvas id="face-canvas"></canvas>
                </div>
                <div id="face-status">
                    <div style="color: var(--mickey-red); font-weight: bold; margin-bottom: 15px; font-size: 16px;">
                        <i class="fas fa-magic"></i> ENHANCED MEDIAPIPE FACE DETECTION
                        <span id="camera-status-badge" style="background: var(--mickey-green); color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; margin-left: 10px;">ACTIVE</span>
                    </div>
                    <div id="status-text" style="color: var(--mickey-blue);">
                        Click START to begin ENHANCED 468-point face landmark detection!
                    </div>
                </div>
                <button class="module-btn start-btn" id="start-face-detection" style="width: 100%; margin-top: 15px;">
                    <i class="fas fa-play-circle" id="btn-icon"></i>
                    <span id="btn-text">START ENHANCED MEDIAPIPE</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- GAME CENTER CONTENT AREA (DEFAULT ACTIVE) -->
    <div class="content-area active" id="game-center-content-area">
        <!-- LEARNING HUB -->
        <main class="learning-hub">
            <!-- MICKEY MOUSE DECORATIONS -->
            <div class="polka-dot" style="top: 10%; left: 5%;"></div>
            <div class="polka-dot" style="top: 20%; right: 10%;"></div>
            <div class="polka-dot" style="bottom: 30%; left: 15%;"></div>
            <div class="mickey-dot" style="top: 15%; right: 20%; animation-delay: -5s;"></div>
            <div class="mickey-dot" style="top: 40%; left: 8%; animation-delay: -10s;"></div>
            
            <!-- MICKEY MOUSE HEADER -->
            <div class="mickey-header">
                <div class="mickey-ears">
                    <div class="ear ear-left">
                        <div class="ear-inner"></div>
                    </div>
                    <div class="ear ear-right">
                        <div class="ear-inner"></div>
                    </div>
                </div>
                <h1>MICKEY'S EMPATHIC LEARNING HUB</h1>
            </div>
            
            <!-- LEARNING CONTENT GRID - UPDATED (REMOVED PHONICS AND MALAY) -->
            <div class="modules-grid">
                <!-- GAME 1: LETTER INTRODUCTION -->
                <div class="module-card" data-module="letters">
                    <div class="module-title">
                        <i class="fas fa-font"></i>
                        Letter Explorer
                    </div>
                    <div class="module-desc">
                        <strong>Multisensory Letter Learning:</strong> Introducing lowercase a-z letters with tactile feel. 
                        Learn to recognize letters by touch, color differentiation, and sound feedback when placed correctly. 
                        Special dyslexia-friendly font prevents mirror confusion.
                    </div>
                    <div class="module-controls">
                        <button class="module-btn start-btn" onclick="startGame('letters')">
                            <i class="fas fa-gamepad"></i> Play Letter Game
                        </button>
                        <button class="module-btn view-btn" onclick="viewModule('letters')">
                            <i class="fas fa-info-circle"></i> Learn More
                        </button>
                    </div>
                </div>
                
                <!-- GAME 2: VOWEL/CONSONANT DIFFERENTIATION -->
                <div class="module-card" data-module="vowels">
                    <div class="module-title">
                        <i class="fas fa-volume-up"></i>
                        Vowel & Consonant Fun
                    </div>
                    <div class="module-desc">
                        <strong>Letter Classification:</strong> Learn to differentiate vowels (a, e, i, o, u) from consonants. 
                        Tactile letter blocks with click sound feedback when correctly sorted.
                    </div>
                    <div class="module-controls">
                        <button class="module-btn start-btn" onclick="startGame('vowels')">
                            <i class="fas fa-gamepad"></i> Play Vowel Game
                        </button>
                        <button class="module-btn view-btn" onclick="viewModule('vowels')">
                            <i class="fas fa-info-circle"></i> Learn More
                        </button>
                    </div>
                </div>
                
                <!-- GAME 3: WORD SPELLING & READING -->
                <div class="module-card" data-module="spelling">
                    <div class="module-title">
                        <i class="fas fa-spell-check"></i>
                        Word Builder
                    </div>
                    <div class="module-desc">
                        <strong>Spelling & Reading:</strong> Spell English words using letter blocks on provided slots. 
                        Read words using phonics or syllable methods.
                    </div>
                    <div class="module-controls">
                        <button class="module-btn start-btn" onclick="startGame('spelling')">
                            <i class="fas fa-gamepad"></i> Play Spelling Game
                        </button>
                        <button class="module-btn view-btn" onclick="viewModule('spelling')">
                            <i class="fas fa-info-circle"></i> Learn More
                        </button>
                    </div>
                </div>
                
                <!-- NEW: TRACING MODULE -->
                <div class="module-card" data-module="tracing">
                    <div class="module-title">
                        <i class="fas fa-pen-nib"></i>
                        Letter Tracer
                    </div>
                    <div class="module-desc">
                        <strong>Kinesthetic Learning:</strong> Trace letters with mouse or finger to build muscle memory. 
                        Visual guides, audio feedback, and progressive difficulty levels.
                    </div>
                    <div class="module-controls">
                        <button class="module-btn start-btn" onclick="startGame('tracing')">
                            <i class="fas fa-pen-fancy"></i> Start Tracing
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- TRACING GAME CONTAINER -->
    <div class="tracing-game-container" id="tracing-game-container" style="display: none;">
        <div class="tracing-header">
            <h3 style="color: var(--mickey-red);">Trace the Letter</h3>
            <div class="tracing-instructions">
                <i class="fas fa-hand-point-up"></i>
                Follow the dotted line with your mouse or finger
            </div>
        </div>
        
        <div class="tracing-area">
            <!-- Letter display -->
            <div class="letter-display">
                <div class="target-letter" id="target-letter">A</div>
                <div class="letter-sound">
                    <button id="play-sound-btn" class="tracing-btn">
                        <i class="fas fa-volume-up"></i> Listen to sound
                    </button>
                </div>
            </div>
            
            <!-- Tracing canvas -->
            <div class="canvas-container">
                <canvas id="tracing-canvas"></canvas>
                <div class="tracing-overlay">
                    <div class="start-dot"></div>
                    <div class="trace-guide"></div>
                </div>
            </div>
            
            <!-- Controls -->
            <div class="tracing-controls">
                <button id="clear-trace" class="tracing-btn">
                    <i class="fas fa-eraser"></i> Clear
                </button>
                <button id="check-trace" class="tracing-btn success">
                    <i class="fas fa-check"></i> Check
                </button>
                <button id="hint-trace" class="tracing-btn hint">
                    <i class="fas fa-lightbulb"></i> Show Hint
                </button>
                <button id="auto-trace" class="tracing-btn demo">
                    <i class="fas fa-magic"></i> Show Me How
                </button>
            </div>
            
            <!-- Feedback -->
            <div class="tracing-feedback" id="tracing-feedback"></div>
            
            <!-- Progress -->
            <div class="tracing-progress">
                <div class="tracing-progress-bar">
                    <div class="tracing-progress-fill" id="trace-progress"></div>
                </div>
                <div class="progress-text">
                    Accuracy: <span id="trace-accuracy">0%</span>
                </div>
            </div>
            
            <!-- Navigation -->
            <div class="game-navigation" style="margin-top: 30px;">
                <button class="nav-btn" id="prev-tracing" onclick="prevTracingActivity()">
                    <i class="fas fa-arrow-left"></i> Previous
                </button>
                <div class="game-counter" id="tracing-counter">Activity 1 of 5</div>
                <button class="nav-btn" id="next-tracing" onclick="nextTracingActivity()">
                    Next <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>
    </div>
    
    <!-- ENHANCED PROFILE CONTENT AREA -->
    <div class="content-area" id="profile-content-area">
        <div class="profile-content">
            <h2 style="color: var(--mickey-red); text-align: center; margin-bottom: 30px;">
                <i class="fas fa-user-graduate"></i> Student Profile & Analysis
            </h2>
            
            <div class="student-profile">
                <div class="profile-header">
                    <div class="avatar" style="width: 80px; height: 80px; background: var(--mickey-yellow); 
                                             border-radius: 50%; border: 4px solid var(--mickey-black);
                                             display: flex; align-items: center; justify-content: center;
                                             font-size: 2rem; color: var(--mickey-red);">
                        <i class="fas fa-user"></i>
                    </div>
                    <div>
                        <h3 style="margin: 0; color: var(--mickey-red);">Student Progress Dashboard</h3>
                        <p style="margin: 5px 0; color: var(--mickey-blue); font-family: 'Comic Neue', cursive;">
                            <i class="fas fa-star"></i> 
                            <span id="student-points">150</span> Mickey Points
                        </p>
                    </div>
                </div>
                
                <!-- PROGRESS OVERVIEW -->
                <div class="progress-overview" style="margin: 30px 0; background: var(--mickey-white); 
                                                     padding: 20px; border-radius: 15px; border: 4px solid var(--mickey-black);">
                    <h4 style="color: var(--mickey-blue); margin-bottom: 15px;">
                        <i class="fas fa-chart-line"></i> Overall Progress
                    </h4>
                    <div class="game-progress">
                        <div class="progress-bar" id="overall-progress" style="width: 40%"></div>
                        <div class="progress-text">40% Complete</div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
                                gap: 15px; margin-top: 20px;">
                        <div class="stat-card" style="background: var(--mickey-pink); padding: 15px; 
                                                    border-radius: 10px; border: 3px solid var(--mickey-black);">
                            <div style="font-size: 2rem; color: var(--mickey-red);">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div style="font-weight: bold; color: var(--mickey-black);">Time Spent</div>
                            <div style="font-size: 1.5rem; color: var(--mickey-blue);">45 min</div>
                        </div>
                        
                        <div class="stat-card" style="background: var(--mickey-green); padding: 15px; 
                                                    border-radius: 10px; border: 3px solid var(--mickey-black);">
                            <div style="font-size: 2rem; color: var(--mickey-red);">
                                <i class="fas fa-trophy"></i>
                            </div>
                            <div style="font-weight: bold; color: var(--mickey-black);">Games Completed</div>
                            <div style="font-size: 1.5rem; color: var(--mickey-blue);" id="games-completed">2/4</div>
                        </div>
                        
                        <div class="stat-card" style="background: var(--mickey-purple); padding: 15px; 
                                                    border-radius: 10px; border: 3px solid var(--mickey-black);">
                            <div style="font-size: 2rem; color: var(--mickey-red);">
                                <i class="fas fa-bolt"></i>
                            </div>
                            <div style="font-weight: bold; color: var(--mickey-black);">Focus Level</div>
                            <div style="font-size: 1.5rem; color: var(--mickey-blue);" id="focus-level">75%</div>
                        </div>
                    </div>
                </div>
                
                <!-- MODULE-WISE ANALYSIS -->
                <div class="module-analysis" style="margin: 30px 0; background: var(--mickey-white); 
                                                   padding: 20px; border-radius: 15px; border: 4px solid var(--mickey-black);">
                    <h4 style="color: var(--mickey-blue); margin-bottom: 20px;">
                        <i class="fas fa-chart-bar"></i> Module Analysis
                    </h4>
                    <div id="module-analysis-chart"></div>
                    
                    <div style="margin-top: 20px;">
                        <h5 style="color: var(--mickey-red); margin-bottom: 10px;">
                            <i class="fas fa-lightbulb"></i> Current Understanding
                        </h5>
                        <div id="understanding-breakdown"></div>
                    </div>
                </div>
                
                <!-- RECOMMENDATIONS -->
                <div class="recommendations" style="margin: 30px 0; background: var(--mickey-white); 
                                                  padding: 20px; border-radius: 15px; border: 4px solid var(--mickey-black);">
                    <h4 style="color: var(--mickey-blue); margin-bottom: 15px;">
                        <i class="fas fa-graduation-cap"></i> Learning Recommendations
                    </h4>
                    <div id="learning-recommendations"></div>
                </div>
                
                <!-- Progress Dashboard -->
                <div id="progress-dashboard" style="margin-top: 30px;"></div>
            </div>
        </div>
    </div>
    
    <!-- ABOUT US CONTENT AREA -->
    <div class="content-area" id="about-content-area">
        <div class="about-content">
            <h2 style="color: var(--mickey-red); text-align: center; margin-bottom: 30px;">
                <i class="fas fa-info-circle"></i> About Mickey's Learning Hub
            </h2>
            
            <div style="text-align: center; max-width: 800px; margin: 0 auto;">
                <div style="font-size: 4rem; color: var(--mickey-red); margin-bottom: 20px;">
                    <i class="fas fa-heart"></i>
                </div>
                <h3 style="color: var(--mickey-blue); margin-bottom: 20px;">Our Mission</h3>
                <p style="color: var(--mickey-black); font-family: 'Comic Neue', cursive; font-size: 1.2rem; line-height: 1.6; margin-bottom: 30px;">
                    Welcome to Mickey's Enhanced Empathic Learning Hub! We're dedicated to creating a fun, engaging, and supportive learning environment for children of all abilities, with special focus on dyslexia support.
                </p>
            </div>
        </div>
    </div>
    
    <!-- SETTINGS CONTENT AREA -->
    <div class="content-area" id="settings-content-area">
        <div class="settings-content">
            <h2 style="color: var(--mickey-red); text-align: center; margin-bottom: 30px;">
                <i class="fas fa-cog"></i> Settings & Preferences
            </h2>
            
            <div style="max-width: 800px; margin: 0 auto;">
                <div style="background: var(--mickey-white); padding: 30px; border-radius: 20px; border: 4px solid var(--mickey-black); margin-bottom: 30px;">
                    <h3 style="color: var(--mickey-red); margin-bottom: 20px;">Accessibility Settings</h3>
                    
                    <div style="background: var(--mickey-yellow); padding: 20px; border-radius: 15px; border: 3px solid var(--mickey-black); margin-bottom: 20px;">
                        <h4 style="color: var(--mickey-black); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-book-reader"></i> Dyslexia Mode
                        </h4>
                        <p style="color: var(--mickey-black); font-family: 'Comic Neue', cursive; margin-bottom: 15px;">
                            Toggle dyslexia-friendly font and spacing
                        </p>
                        <button class="module-btn" id="toggle-dyslexia" style="width: 100%;">
                            <i class="fas fa-toggle-on"></i> Toggle Dyslexia Mode
                        </button>
                    </div>
                    
                    <h3 style="color: var(--mickey-red); margin-bottom: 20px;">Face Detection Settings</h3>
                    <div style="background: var(--mickey-yellow); padding: 20px; border-radius: 15px; border: 3px solid var(--mickey-black);">
                        <h4 style="color: var(--mickey-black); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-camera"></i> ENHANCED MediaPipe Detection
                        </h4>
                        <p style="color: var(--mickey-black); font-family: 'Comic Neue', cursive; margin-bottom: 15px;">
                            Status: <span id="detection-status" style="color: var(--mickey-red); font-weight: bold;">INACTIVE</span>
                        </p>
                        <button class="module-btn start-btn" id="settings-start-camera" style="width: 100%;">
                            <i class="fas fa-camera"></i> Start Camera Detection
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODULE CONTENT AREA -->
    <div class="module-content-area" id="module-content">
        <div class="content-header">
            <h2 id="module-content-title" style="color: var(--mickey-red); margin: 0;"></h2>
            <button class="close-module" id="close-module">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="content-body" id="module-content-body">
            <!-- Dynamic content will be loaded here -->
        </div>
    </div>
    
    <!-- PROACTIVE INTERVENTION MODAL -->
    <div class="intervention-modal" id="intervention-modal">
        <div class="intervention-header">
            <h2 style="margin: 0; color: var(--mickey-white);">
                <i class="fas fa-heart"></i> I notice you might need help!
            </h2>
            <p style="margin: 10px 0 0 0; color: var(--mickey-yellow); font-family: 'Comic Neue', cursive;">
                Let me help you feel better!
            </p>
        </div>
        <div class="intervention-body">
            <div style="font-size: 4rem; color: var(--mickey-red); margin-bottom: 20px;">
                <i class="fas fa-robot"></i>
            </div>
            <h3 style="color: var(--mickey-blue); margin-bottom: 10px;" id="intervention-title">
                You seem a bit frustrated...
            </h3>
            <p style="color: var(--mickey-black); font-family: 'Comic Neue', cursive; font-size: 1.1rem;">
                How would you like me to help?
            </p>
            
            <div class="intervention-options" id="intervention-options">
                <!-- Options will be dynamically added -->
            </div>
            
            <button class="module-btn start-btn" id="close-intervention" style="margin-top: 20px;">
                <i class="fas fa-times"></i> I'm okay, continue
            </button>
        </div>
    </div>
    
    <!-- BREAK TIMER MODAL -->
    <div class="break-timer" id="break-timer">
        <div class="intervention-header">
            <h2 style="margin: 0; color: var(--mickey-white);">
                <i class="fas fa-clock"></i> Break Time!
            </h2>
            <p style="margin: 10px 0 0 0; color: var(--mickey-yellow); font-family: 'Comic Neue', cursive;">
                Take a deep breath and relax
            </p>
        </div>
        <div class="intervention-body">
            <div class="timer-display" id="timer-display">00:30</div>
            <h3 style="color: var(--mickey-blue); margin-bottom: 10px;">
                Mickey says: "Take a break!"
            </h3>
            <p style="color: var(--mickey-black); font-family: 'Comic Neue', cursive; font-size: 1.1rem;">
                Stretch, take deep breaths, and come back refreshed!
            </p>
            
            <div class="breathing-animation" id="breathing-animation">
                Breathe IN... (4 seconds)
            </div>
            
            <button class="module-btn start-btn" onclick="endMickeyBreak()" style="margin-top: 20px;">
                <i class="fas fa-play"></i> End Break Early
            </button>
        </div>
    </div>

    <!-- MAIN JAVASCRIPT -->
    <script>
        // ============================================
        // ENHANCED MEDIAPIPE FACE DETECTION
        // ============================================
        
        // Initialize MediaPipe Face Mesh
        const faceMesh = new FaceMesh({
            locateFile: (file) => {
                return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
            }
        });
        
        // Configure Face Mesh
        faceMesh.setOptions({
            maxNumFaces: 1,
            refineLandmarks: true,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });
        
        // Get video and canvas elements
        const videoElement = document.getElementById('face-video');
        const canvasElement = document.getElementById('face-canvas');
        const canvasCtx = canvasElement.getContext('2d');

        // Variables for face detection
        let isDetectionActive = false;
        let isCameraStarted = false;
        let emotionHistory = [];
        const MAX_HISTORY = 10;
        
        // ============================================
        // GLOBAL STATE MANAGEMENT
        // ============================================
        
        // ENHANCED LEARNING MODULES DATA
        const learningGames = {
            letters: {
                title: "Letter Explorer Game",
                description: "Learn lowercase letters a-z with multisensory support!",
                activities: [
                    {
                        type: "letter_recognition",
                        question: "Touch and identify this letter:",
                        letter: "a",
                        options: ["a", "b", "c", "d"],
                        correct: 0,
                        explanation: "Great! This is lowercase 'a'. Feel its round shape!",
                        points: 10,
                        tactile_feature: "Round shape with a tail"
                    },
                    {
                        type: "letter_recognition",
                        question: "Which letter is different? (No mirror letters)",
                        letters: ["b", "d", "p", "a"],
                        options: ["b", "d", "p", "a"],
                        correct: 3,
                        explanation: "Correct! 'a' is not a mirror letter like b-d or p-q!",
                        points: 10,
                        tactile_feature: "Unique shape prevents confusion"
                    },
                    {
                        type: "letter_sequence",
                        question: "What comes after 'c'?",
                        sequence: ["a", "b", "c", "?"],
                        options: ["d", "e", "f", "g"],
                        correct: 0,
                        explanation: "Correct! c  d. Feel the different shapes!",
                        points: 10,
                        tactile_feature: "Different shapes for each letter"
                    }
                ],
                dyslexia_tips: [
                    "Touch and feel each letter shape",
                    "Use color coding for similar letters",
                    "Listen to the click sound when correct"
                ],
                currentActivity: 0,
                completed: false
            },
            
            vowels: {
                title: "Vowel & Consonant Fun",
                description: "Learn to differentiate vowels and consonants!",
                activities: [
                    {
                        type: "vowel_identification",
                        question: "Which of these is a vowel?",
                        letters: ["b", "a", "c", "d"],
                        options: ["b", "a", "c", "d"],
                        correct: 1,
                        explanation: "Correct! 'a' is a vowel (a, e, i, o, u)!",
                        points: 10
                    },
                    {
                        type: "consonant_identification",
                        question: "Find the consonant:",
                        letters: ["e", "i", "m", "o"],
                        options: ["e", "i", "m", "o"],
                        correct: 2,
                        explanation: "Great! 'm' is a consonant!",
                        points: 10
                    }
                ],
                dyslexia_tips: [
                    "Color code vowels and consonants differently",
                    "Use tactile feedback for differentiation",
                    "Practice with phonics sounds"
                ],
                currentActivity: 0,
                completed: false
            },
            
            spelling: {
                title: "Word Builder Game",
                description: "Spell and read words using phonics!",
                activities: [
                    {
                        type: "word_spelling",
                        question: "Spell 'cat' using letter blocks",
                        word: "cat",
                        letters: ["c", "a", "t", "b", "d", "e"],
                        correct: ["c", "a", "t"],
                        explanation: "Excellent! c-a-t spells 'cat'!",
                        points: 10,
                        phonics: "/k/ // /t/"
                    },
                    {
                        type: "malay_word",
                        question: "Spell 'buku' (book in Malay)",
                        word: "buku",
                        letters: ["b", "u", "k", "a", "e", "i"],
                        correct: ["b", "u", "k", "u"],
                        explanation: "Perfect! b-u-k-u = buku!",
                        points: 10,
                        syllable_breakdown: "bu-ku (2 syllables)"
                    }
                ],
                dyslexia_tips: [
                    "Break words into syllables",
                    "Use phonics sounds for each letter",
                    "Listen to the click sound feedback"
                ],
                currentActivity: 0,
                completed: false
            },
            
            // NEW: TRACING MODULE
            tracing: {
                title: "Letter Tracer",
                description: "Trace letters with mouse or finger to build muscle memory",
                activities: [
                    {
                        type: "uppercase_tracing",
                        letter: "A",
                        strokeOrder: [
                            {x: 50, y: 150}, // Starting point
                            {x: 100, y: 50},  // Top point
                            {x: 150, y: 150}, // Right point
                            {x: 70, y: 100},  // Crossbar start
                            {x: 130, y: 100}  // Crossbar end
                        ],
                        difficulty: "easy",
                        points: 15,
                        hint: "Start at the green dot, go up to the point, then down to the other side"
                    },
                    {
                        type: "lowercase_tracing",
                        letter: "a",
                        strokeOrder: [
                            {x: 100, y: 100, type: "circle"}, // Round part
                            {x: 100, y: 150, type: "line"}    // Tail
                        ],
                        difficulty: "easy",
                        points: 15,
                        hint: "Make a circle first, then add the tail"
                    },
                    {
                        type: "lowercase_tracing",
                        letter: "b",
                        strokeOrder: [
                            {x: 80, y: 50},   // Top of line
                            {x: 80, y: 150},  // Down stroke
                            {x: 80, y: 100},  // Back to middle
                            {x: 120, y: 150}  // Round part
                        ],
                        difficulty: "medium",
                        points: 20,
                        hint: "Straight line down, then circle"
                    },
                    {
                        type: "lowercase_tracing",
                        letter: "d",
                        strokeOrder: [
                            {x: 100, y: 100},  // Start of circle
                            {x: 140, y: 100},  // Right of circle
                            {x: 100, y: 150},  // Bottom of circle
                            {x: 60, y: 100},   // Left of circle
                            {x: 100, y: 100},  // Back to start
                            {x: 100, y: 50}    // Up stroke
                        ],
                        difficulty: "medium",
                        points: 20,
                        hint: "Circle first, then straight line up"
                    }
                ],
                dyslexia_tips: [
                    "Trace slowly and follow the guide",
                    "Say the letter sound as you trace",
                    "Start from the correct starting point",
                    "Use the starting dot as reference"
                ],
                currentActivity: 0,
                completed: false
            }
        };        

        // Empathic Agent Configuration
        const empathicAgent = {
            currentEmotion: "neutral",
            previousEmotion: "neutral",
            focusLevel: 75,
            engagementScore: 50,
            lastInteractionTime: Date.now(),
            isCameraActive: false,
            faceDetected: false,
            landmarksDetected: 0,
            emotionConfidence: 0,
            consecutiveNegativeFrames: 0
        };
        
        // ============================================
        // MICKEY MOUSE AGENT STATE
        // ============================================
        
        let mickeyAgentVisible = false;
        let breakTimerActive = false;
        let breakTimeLeft = 30;
        let breakInterval = null;
        let breathingInterval = null;
        let studentEmotion = 'neutral';
        let frustrationLevel = 0;
        const FRUSTRATION_THRESHOLD = 5;
        
        // Game State
        let currentGame = null;
        let currentActivityIndex = 0;
        let studentScore = 150;
        let isEasyMode = false;
        
        // Voice Settings
        let voiceEnabled = true;
        
        // Emotion Detection Timer
        let emotionDetectionInterval;
        let secondsCounter = 0;
        let detectionCycle = 0;
        
        // Tracing Engine
        class LetterTracingEngine {
            constructor() {
                this.canvas = null;
                this.ctx = null;
                this.isDrawing = false;
                this.lastX = 0;
                this.lastY = 0;
                this.points = [];
                this.targetPath = [];
                this.currentLetter = '';
                this.tolerance = 20;
                this.score = 0;
                this.maxScore = 100;
            }
            
            initialize(canvasId) {
                this.canvas = document.getElementById(canvasId);
                this.ctx = this.canvas.getContext('2d');
                
                const container = this.canvas.parentElement;
                this.canvas.width = container.clientWidth;
                this.canvas.height = container.clientHeight;
                
                this.setupEventListeners();
                this.setupDrawingStyle();
                
                // Mobile optimization
                if ('ontouchstart' in window) {
                    this.tolerance = 30;
                }
            }
            
            setupDrawingStyle() {
                this.ctx.lineWidth = 8;
                this.ctx.lineCap = 'round';
                this.ctx.lineJoin = 'round';
                this.ctx.strokeStyle = '#ff6b8b';
                this.ctx.fillStyle = '#ff6b8b';
            }
            
            setupEventListeners() {
                // Mouse events
                this.canvas.addEventListener('mousedown', this.startDrawing.bind(this));
                this.canvas.addEventListener('mousemove', this.draw.bind(this));
                this.canvas.addEventListener('mouseup', this.stopDrawing.bind(this));
                this.canvas.addEventListener('mouseout', this.stopDrawing.bind(this));
                
                // Touch events
                this.canvas.addEventListener('touchstart', this.handleTouchStart.bind(this));
                this.canvas.addEventListener('touchmove', this.handleTouchMove.bind(this));
                this.canvas.addEventListener('touchend', this.stopDrawing.bind(this));
                
                // Prevent scrolling on touch
                this.canvas.addEventListener('touchmove', (e) => {
                    if (e.scale !== 1) { e.preventDefault(); }
                }, { passive: false });
            }
            
            startDrawing(e) {
                this.isDrawing = true;
                const pos = this.getMousePos(e);
                [this.lastX, this.lastY] = [pos.x, pos.y];
                this.points.push({x: pos.x, y: pos.y});
                this.playSound('start');
            }
            
            draw(e) {
                if (!this.isDrawing) return;
                
                e.preventDefault();
                const pos = this.getMousePos(e);
                
                this.ctx.beginPath();
                this.ctx.moveTo(this.lastX, this.lastY);
                this.ctx.lineTo(pos.x, pos.y);
                this.ctx.stroke();
                
                this.points.push({x: pos.x, y: pos.y});
                [this.lastX, this.lastY] = [pos.x, pos.y];
            }
            
            stopDrawing() {
                if (!this.isDrawing) return;
                
                this.isDrawing = false;
                this.analyzeTrace();
                this.playSound('end');
            }
            
            handleTouchStart(e) {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent('mousedown', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                this.canvas.dispatchEvent(mouseEvent);
            }
            
            handleTouchMove(e) {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent('mousemove', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                this.canvas.dispatchEvent(mouseEvent);
            }
            
            getMousePos(e) {
                const rect = this.canvas.getBoundingClientRect();
                let x, y;
                
                if (e.type.includes('touch')) {
                    x = e.touches[0].clientX - rect.left;
                    y = e.touches[0].clientY - rect.top;
                } else {
                    x = e.clientX - rect.left;
                    y = e.clientY - rect.top;
                }
                
                const scaleX = this.canvas.width / rect.width;
                const scaleY = this.canvas.height / rect.height;
                
                return {
                    x: x * scaleX,
                    y: y * scaleY
                };
            }
            
            setTargetLetter(letter, strokePath) {
                this.currentLetter = letter;
                this.targetPath = strokePath;
                this.drawGuideLines();
                this.placeStartDot();
            }
            
            drawGuideLines() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                this.ctx.save();
                this.ctx.strokeStyle = '#CCCCCC';
                this.ctx.lineWidth = 3;
                this.ctx.setLineDash([5, 5]);
                this.ctx.lineCap = 'round';
                
                if (this.targetPath.length > 0) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(this.targetPath[0].x, this.targetPath[0].y);
                    
                    for (let i = 1; i < this.targetPath.length; i++) {
                        this.ctx.lineTo(this.targetPath[i].x, this.targetPath[i].y);
                    }
                    
                    this.ctx.stroke();
                }
                
                this.ctx.restore();
            }
            
            placeStartDot() {
                if (this.targetPath.length > 0) {
                    const startDot = document.querySelector('.start-dot');
                    const canvasRect = this.canvas.getBoundingClientRect();
                    const scaleX = canvasRect.width / this.canvas.width;
                    const scaleY = canvasRect.height / this.canvas.height;
                    
                    startDot.style.left = (this.targetPath[0].x * scaleX) + 'px';
                    startDot.style.top = (this.targetPath[0].y * scaleY) + 'px';
                }
            }
            
            analyzeTrace() {
                if (this.points.length < 2 || this.targetPath.length < 2) {
                    this.showFeedback("Try drawing something first!", "needs-improvement");
                    return;
                }
                
                let matchScore = 0;
                const totalPoints = Math.max(this.points.length, this.targetPath.length);
                
                for (let i = 0; i < Math.min(this.points.length, this.targetPath.length); i++) {
                    const tracePoint = this.points[i];
                    const targetPoint = this.targetPath[i];
                    
                    const distance = Math.sqrt(
                        Math.pow(tracePoint.x - targetPoint.x, 2) + 
                        Math.pow(tracePoint.y - targetPoint.y, 2)
                    );
                    
                    if (distance < this.tolerance) {
                        matchScore++;
                    }
                }
                
                const accuracy = Math.round((matchScore / totalPoints) * 100);
                this.score = accuracy;
                
                document.getElementById('trace-accuracy').textContent = accuracy + '%';
                document.getElementById('trace-progress').style.width = accuracy + '%';
                
                if (accuracy > 80) {
                    this.showFeedback(
                        "Excellent tracing! Perfect letter formation! ",
                        "success"
                    );
                    this.playSound('success');
                    
                    studentScore += 15;
                    document.getElementById('student-points').textContent = studentScore;
                    playMickeyAudio("correct");
                    
                } else if (accuracy > 50) {
                    this.showFeedback(
                        "Good effort! Try to stay closer to the guide lines.",
                        "needs-improvement"
                    );
                    playMickeyAudio("incorrect");
                } else {
                    this.showFeedback(
                        "Let's try again. Start from the green dot and follow the dotted line.",
                        "needs-improvement"
                    );
                    playMickeyAudio("incorrect");
                }
                
                this.points = [];
            }
            
            showFeedback(message, type) {
                const feedback = document.getElementById('tracing-feedback');
                feedback.textContent = message;
                feedback.className = `tracing-feedback show ${type}`;
                
                setTimeout(() => {
                    feedback.classList.remove('show');
                }, 3000);
            }
            
            playSound(type) {
                const sounds = {
                    start: 'https://assets.mixkit.co/sfx/preview/mixkit-pencil-writing-2444.mp3',
                    end: 'https://assets.mixkit.co/sfx/preview/mixkit-pencil-scribble-on-paper-2426.mp3',
                    success: 'https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3'
                };
                
                if (sounds[type]) {
                    const audio = new Audio(sounds[type]);
                    audio.volume = 0.3;
                    audio.play();
                }
            }
            
            clearCanvas() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.drawGuideLines();
                this.points = [];
                this.score = 0;
                
                document.getElementById('trace-accuracy').textContent = '0%';
                document.getElementById('trace-progress').style.width = '0%';
                
                const feedback = document.getElementById('tracing-feedback');
                feedback.classList.remove('show');
            }
            
            showDemo() {
                this.clearCanvas();
                
                this.ctx.save();
                this.ctx.strokeStyle = '#95e1d3';
                this.ctx.lineWidth = 6;
                this.ctx.lineCap = 'round';
                
                let i = 0;
                const animate = () => {
                    if (i < this.targetPath.length - 1) {
                        this.ctx.beginPath();
                        this.ctx.moveTo(this.targetPath[i].x, this.targetPath[i].y);
                        this.ctx.lineTo(this.targetPath[i + 1].x, this.targetPath[i + 1].y);
                        this.ctx.stroke();
                        i++;
                        setTimeout(animate, 200);
                    }
                };
                
                animate();
                this.ctx.restore();
            }
        }
        
        const tracingEngine = new LetterTracingEngine();
        
        // ============================================
        // ENHANCEMENTS FROM ANALYSIS
        // ============================================
        
        // 1. Visual-Tactile Alternatives
        function simulateTactileFeedback(element) {
            element.style.transform = 'scale(0.95)';
            element.style.boxShadow = 'inset 0 0 10px rgba(0,0,0,0.2)';
            
            const clickSound = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-select-click-1109.mp3');
            clickSound.volume = 0.3;
            clickSound.play();
            
            setTimeout(() => {
                element.style.transform = 'scale(1)';
                element.style.boxShadow = '';
            }, 200);
        }
        
        // 2. Enhanced Letter Differentiation
        const dyslexiaLetterFeatures = {
            'b': { color: '#ff6b8b', shape: 'straight-line-round', sound: '/b/' },
            'd': { color: '#8ac6d1', shape: 'round-straight-line', sound: '/d/' },
            'p': { color: '#ffd166', shape: 'straight-line-round-bottom', sound: '/p/' },
            'q': { color: '#95e1d3', shape: 'round-straight-line-tail', sound: '/k/' }
        };
        
        function createDyslexiaSafeLetter(letter) {
            const features = dyslexiaLetterFeatures[letter] || { color: '#8ac6d1' };
            
            return `
                <div class="dyslexia-letter" 
                     data-letter="${letter}"
                     style="background: ${features.color};
                            border-left: ${letter === 'b' || letter === 'd' ? '4px solid #000' : 'none'};
                            border-right: ${letter === 'p' || letter === 'q' ? '4px solid #000' : 'none'};">
                    <span class="letter-main">${letter}</span>
                    <div class="letter-guide" style="border-bottom: ${['g', 'j', 'p', 'q', 'y'].includes(letter) ? '2px dashed #000' : 'none'}"></div>
                </div>
            `;
        }
        
        // 4. Adaptive Learning Engine
        class AdaptiveLearningEngine {
            constructor() {
                this.studentProfile = {
                    dyslexiaType: null,
                    responseTimes: [],
                    errorPatterns: [],
                    preferredModalities: ['visual', 'auditory', 'kinesthetic']
                };
                
                this.moduleDifficulty = {
                    letters: 'adaptive',
                    vowels: 'adaptive',
                    spelling: 'adaptive',
                    tracing: 'adaptive'
                };
            }
            
            adjustModuleDifficulty(moduleName, performance) {
                const currentGame = learningGames[moduleName];
                
                if (performance.accuracy < 60) {
                    // Make easier
                    currentGame.activities.forEach(activity => {
                        if (activity.options && activity.options.length > 3) {
                            activity.options = activity.options.slice(0, 3);
                        }
                    });
                    this.addHints(currentGame);
                    
                } else if (performance.accuracy > 85) {
                    // Increase challenge
                    currentGame.activities.forEach(activity => {
                        if (activity.options && activity.options.length < 6) {
                            activity.options = [...activity.options, 
                                               this.generateDistractor(activity.correct)];
                        }
                    });
                }
            }
            
            addHints(game) {
                game.activities.forEach(activity => {
                    activity.hints = [
                        `Look at the shape of ${activity.options ? activity.options[activity.correct] : 'the correct answer'}`,
                        `Listen to the sound it makes`,
                        `Think about words that start with this letter`
                    ];
                });
            }
            
            generateDistractor(correct) {
                const letters = 'abcdefghijklmnopqrstuvwxyz';
                let distractor;
                do {
                    distractor = letters[Math.floor(Math.random() * letters.length)];
                } while (distractor === correct);
                return distractor;
            }
        }
        
        const adaptiveEngine = new AdaptiveLearningEngine();
        
        // 5. Progress Dashboard
        function createProgressDashboard() {
            const completedModules = Object.values(learningGames).filter(g => g.completed).length;
            const totalModules = Object.keys(learningGames).length;
            const progressPercent = Math.round((completedModules / totalModules) * 100);
            
            return {
                modulesCompleted: completedModules,
                totalModules: totalModules,
                timeSpent: "45 minutes",
                accuracyRates: {
                    letters: 85,
                    vowels: 75,
                    spelling: 65,
                    tracing: 90
                },
                interventionTriggers: frustrationLevel,
                recommendedNextSteps: generateRecommendations(),
                progressPercent: progressPercent
            };
        }
        
        function generateRecommendations() {
            const recommendations = [];
            
            if (frustrationLevel > 3) {
                recommendations.push("Take more frequent breaks");
            }
            
            const dashboard = createProgressDashboard();
            Object.entries(dashboard.accuracyRates).forEach(([module, accuracy]) => {
                if (accuracy < 70 && !learningGames[module].completed) {
                    recommendations.push(`Practice more ${module} activities`);
                }
            });
            
            return recommendations.length > 0 ? recommendations : ["Continue with current pace"];
        }
        
        // ============================================
        // INITIALIZATION FUNCTIONS
        // ============================================
        
        function initializeAll() {
            console.log(" Initializing Mickey's Enhanced Learning Hub...");
            
            // Show welcome screen with buttons only
            document.body.classList.add('welcome-active');
            document.getElementById('welcome-screen').style.display = 'flex';
            
            // Setup button click handlers
            document.getElementById('show-login-btn').addEventListener('click', showLoginForm);
            document.getElementById('show-register-btn').addEventListener('click', showRegisterForm);
            
            console.log(" System ready - showing buttons only!");
        }

        // Update these functions in the JavaScript section

        // Show login form, hide buttons
        function showLoginForm() {
            document.getElementById('welcome-buttons').style.display = 'none';
            document.getElementById('register-form-container').style.display = 'none';
            document.getElementById('login-form-container').style.display = 'block';
            
            // Scroll to login form
            const formsContainer = document.getElementById('forms-container');
            formsContainer.scrollTop = 0;
        }

        // Show register form, hide buttons
        function showRegisterForm() {
            document.getElementById('welcome-buttons').style.display = 'none';
            document.getElementById('login-form-container').style.display = 'none';
            document.getElementById('register-form-container').style.display = 'block';
            
            // Scroll to register form
            const formsContainer = document.getElementById('forms-container');
            formsContainer.scrollTop = 0;
        }

        // Login function (same as before)
        function submitLogin() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            
            if (!username || !password) {
                alert("Please enter both username and password!");
                return;
            }
            
            if (username === 'student123' && password === 'student123') {
                localStorage.setItem('userRole', 'student');
                localStorage.setItem('username', username);
                
                // Hide welcome screen, show main interface
                document.getElementById('welcome-screen').style.display = 'none';
                document.body.classList.remove('welcome-active');
                
                // Initialize main system
                initMainSystem('student');
                
                // Speak welcome message
                setTimeout(() => {
                    speakWelcomeMessage();
                }, 300);
                
            } else if (username === 'teacher123' && password === 'teacher123') {
                localStorage.setItem('userRole', 'teacher');
                localStorage.setItem('username', username);
                
                // Hide welcome screen, show main interface
                document.getElementById('welcome-screen').style.display = 'none';
                document.body.classList.remove('welcome-active');
                
                // Initialize main system
                initMainSystem('teacher');
                
                // Speak welcome message
                setTimeout(() => {
                    speakWelcomeMessage();
                }, 300);
                
            } else {
                alert("Invalid username or password!\n\nTry:\nStudent: student123 / student123\nTeacher: teacher123 / teacher123");
            }
        }

        // Registration function (same as before)
        function submitRegistration() {
            const name = document.getElementById('register-name').value;
            const username = document.getElementById('register-username').value;
            const password = document.getElementById('register-password').value;
            const role = document.getElementById('register-role').value;
            
            if (!name || !username || !password) {
                alert("Please fill in all required fields!");
                return;
            }
            
            if (password.length < 6) {
                alert("Password must be at least 6 characters!");
                return;
            }
            
            localStorage.setItem('userRole', role);
            localStorage.setItem('username', username);
            localStorage.setItem('userName', name);
            
            // Hide welcome screen, show main interface
            document.getElementById('welcome-screen').style.display = 'none';
            document.body.classList.remove('welcome-active');
            
            // Initialize main system
            initMainSystem(role);
            
            // Speak welcome message
            setTimeout(() => {
                speakWelcomeMessage();
            }, 300);
        }

        // Initialize main system after login
        function initMainSystem(role) {
            initHeaderNavigation();
            initSideToggle();
            initAccessibilityFunctions();
            initMediaPipeFaceDetection();
            initGameFunctions();
            initAgentFunctions();
            initSpeakingBot(); // Initialize speaking bot
            
            if (role === 'teacher') {
                switchContent('profile');
                setActiveNavTab('profile-tab');
            } else {
                switchContent('game-center');
                setActiveNavTab('game-tab');
            }
        }

        // ============================================
        // WELCOME SCREEN FUNCTIONS
        // ============================================
        
        function initWelcomeScreen() {
            // Show welcome screen on first load
            const hasVisited = localStorage.getItem('mickeyHubVisited');
            
            if (!hasVisited) {
                setTimeout(() => {
                    showWelcomeScreen();
                }, 1000);
            }
            
            // Header logo click handler
            const headerLogo = document.querySelector('.header-logo');
            if (headerLogo) {
                headerLogo.addEventListener('click', function(e) {
                    e.preventDefault();
                    const userRole = localStorage.getItem('userRole');
                    if (!userRole) {
                        // Only show welcome screen if not logged in
                        showWelcomeScreen();
                    }
                });
            }
            
            // Welcome screen buttons
            const startLearningBtn = document.getElementById('start-learning');
            const exploreGamesBtn = document.getElementById('explore-games');
            
            if (startLearningBtn) {
                startLearningBtn.addEventListener('click', function() {
                    hideWelcomeScreen();
                    localStorage.setItem('mickeyHubVisited', 'true');
                    showNotification("Let's start learning!", "Mickey is here to help! ", "success");
                });
            }
            
            if (exploreGamesBtn) {
                exploreGamesBtn.addEventListener('click', function() {
                    hideWelcomeScreen();
                    localStorage.setItem('mickeyHubVisited', 'true');
                    switchContent('game-center');
                    setActiveNavTab('game-tab');
                });
            }
        }
        
        function showWelcomeScreen() {
            const welcomeScreen = document.getElementById('welcome-screen');
            if (welcomeScreen) {
                welcomeScreen.style.display = 'flex';
                document.body.classList.add('welcome-active');
                
                // Play welcome audio
                playMickeyAudio("welcome");
            }
        }

        function hideWelcomeScreen() {
            const welcomeScreen = document.getElementById('welcome-screen');
            if (welcomeScreen) {
                welcomeScreen.style.display = 'none';
            }
        }

        // ============================================
        // HEADER NAVIGATION
        // ============================================
        
        function initHeaderNavigation() {
            // Game Center tab
            document.getElementById('game-tab').addEventListener('click', function(e) {
                e.preventDefault();
                switchContent('game-center');
                setActiveNavTab('game-tab');
            });
            
            // Profile tab
            document.getElementById('profile-tab').addEventListener('click', function(e) {
                e.preventDefault();
                switchContent('profile');
                setActiveNavTab('profile-tab');
                updateProfileDisplay();
            });
            
            // About Us tab
            document.getElementById('about-tab').addEventListener('click', function(e) {
                e.preventDefault();
                switchContent('about');
                setActiveNavTab('about-tab');
            });
            
            // Settings tab
            document.getElementById('settings-tab').addEventListener('click', function(e) {
                e.preventDefault();
                switchContent('settings');
                setActiveNavTab('settings-tab');
                updateSettingsDisplay();
            });
        }
        
        function setActiveNavTab(tabId) {
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            const activeTab = document.getElementById(tabId);
            if (activeTab) {
                activeTab.classList.add('active');
            }
        }
        
        function switchContent(contentType) {
            document.querySelectorAll('.content-area').forEach(area => {
                area.classList.remove('active');
            });

            if (contentType !== 'game-center' && currentGame && isCameraStarted) {
                stopCameraDetection();
                currentGame = null;
            }
            
            // Hide tracing container if showing
            document.getElementById('tracing-game-container').style.display = 'none';
            
            const targetArea = document.getElementById(`${contentType}-content-area`);
            if (targetArea) {
                targetArea.classList.add('active');
            }
            
            const moduleContent = document.getElementById('module-content');
            if (moduleContent) {
                moduleContent.classList.remove('active');
            }
        }
        
        // ============================================
        // SIDE TOGGLE FUNCTIONS
        // ============================================
        
        function initSideToggle() {
            const sideToggle = document.getElementById('side-toggle');
            const sideBubbles = document.getElementById('side-bubbles');
            
            if (!sideToggle || !sideBubbles) {
                console.warn("Side toggle elements not found, skipping initialization");
                return;
            }
            
            let sideOpen = false;
            
            sideToggle.addEventListener('click', function(event) {
                event.stopPropagation();
                sideOpen = !sideOpen;
                
                if (sideOpen) {
                    sideBubbles.classList.add('show');
                    sideToggle.innerHTML = '<i class="fas fa-times"></i>';
                    sideToggle.style.background = 'var(--mickey-blue)';
                } else {
                    sideBubbles.classList.remove('show');
                    sideToggle.innerHTML = '<i class="fas fa-plus"></i>';
                    sideToggle.style.background = 'var(--mickey-red)';
                }
            });
            
            initBubbleHandlers();
            
            document.addEventListener('click', function(event) {
                if (!event.target.closest('#side-collapsible') && sideOpen) {
                    sideBubbles.classList.remove('show');
                    sideOpen = false;
                    sideToggle.innerHTML = '<i class="fas fa-plus"></i>';
                    sideToggle.style.background = 'var(--mickey-red)';
                }
            });
        }    
                
        function initBubbleHandlers() {
            // Camera bubble
            const cameraBubble = document.getElementById('side-camera');
            if (cameraBubble) {
                cameraBubble.addEventListener('click', function(event) {
                    event.stopPropagation();
                    
                    if (!currentGame) {
                        alert("Please start a game first to use camera detection! ");
                        return;
                    }
                    
                    document.querySelectorAll('.collapsible-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    const cameraContent = document.getElementById('camera-content');
                    if (cameraContent) {
                        cameraContent.classList.add('active');
                        
                        if (!isCameraStarted && currentGame) {
                            setTimeout(() => {
                                startRealMediaPipeDetection();
                            }, 500);
                        }
                    }
                    
                    closeSideBubbles();
                });
            }
            
            // Speaking bot bubble
            const speakingBotBubble = document.getElementById('side-speaking-bot');
            if (speakingBotBubble) {
                speakingBotBubble.addEventListener('click', function(event) {
                    event.stopPropagation();
                    handleSpeakingBotClick();
                    closeSideBubbles();
                });
            }
            
            // Add message indicator to speaking bot bubble
            if (speakingBotBubble && !document.getElementById('bot-message-indicator')) {
                const messageIndicator = document.createElement('div');
                messageIndicator.className = 'bot-message-indicator';
                messageIndicator.id = 'bot-message-indicator';
                speakingBotBubble.appendChild(messageIndicator);
                speakingBotBubble.classList.add('has-message');
            }

            const closeCameraBtn = document.getElementById('close-camera-content');
            if (closeCameraBtn) {
                closeCameraBtn.addEventListener('click', function(event) {
                    event.stopPropagation();
                    closeCameraContent();
                });
            }
        }
        
        function closeSideBubbles() {
            const sideBubbles = document.getElementById('side-bubbles');
            if (sideBubbles) {
                sideBubbles.classList.remove('show');
            }
            
            const sideToggle = document.getElementById('side-toggle');
            if (sideToggle) {
                sideToggle.innerHTML = '<i class="fas fa-plus"></i>';
                sideToggle.style.background = 'var(--mickey-red)';
            }
        }
        
        // ============================================
        // ACCESSIBILITY FUNCTIONS
        // ============================================
        
        function initAccessibilityFunctions() {
            // Dyslexia mode in settings
            const settingsDyslexiaBtn = document.getElementById('toggle-dyslexia');
            if (settingsDyslexiaBtn) {
                settingsDyslexiaBtn.addEventListener('click', function() {
                    toggleDyslexiaMode();
                    this.innerHTML = `<i class="fas fa-toggle-${document.body.classList.contains('dyslexia-mode') ? 'on' : 'off'}"></i> Dyslexia Mode ${document.body.classList.contains('dyslexia-mode') ? 'ON' : 'OFF'}`;
                });
            }
            
            // Settings camera button
            const settingsCameraBtn = document.getElementById('settings-start-camera');
            if (settingsCameraBtn) {
                settingsCameraBtn.addEventListener('click', function() {
                    if (currentGame) {
                        startRealMediaPipeDetection();
                    } else {
                        alert("Please start a game first to use camera detection! ");
                    }
                });
            }
        }
        
        function toggleDyslexiaMode() {
            document.body.classList.toggle('dyslexia-mode');
            showNotification("Dyslexia Mode", 
                document.body.classList.contains('dyslexia-mode') ? 
                "Dyslexia-friendly font enabled! " : 
                "Dyslexia-friendly font disabled.", 
                "info");
        }
        
        function toggleEnhancedGuides() {
            document.body.classList.toggle('color-overlay-yellow');
            showNotification("Enhanced Guides", document.body.classList.contains('color-overlay-yellow') ? "Enabled" : "Disabled", "info");
        }
        
        // ============================================
        // MICKEY MOUSE AGENT FUNCTIONS
        // ============================================
        
        function initAgentFunctions() {
            // Agent minimize
            const minimizeBtn = document.getElementById('agent-minimize');
            if (minimizeBtn) {
                minimizeBtn.addEventListener('click', function() {
                    document.getElementById('empathic-agent').style.display = 'none';
                    mickeyAgentVisible = false;
                });
            }
            
            // Close intervention
            const closeInterventionBtn = document.getElementById('close-intervention');
            if (closeInterventionBtn) {
                closeInterventionBtn.addEventListener('click', function() {
                    document.getElementById('intervention-modal').style.display = 'none';
                    addMickeyMessage("Glad you're okay! Let's continue! ");
                    playMickeyAudio("continue");
                });
            }
            
            // Voice toggle
            const voiceToggle = document.getElementById('voice-toggle');
            if (voiceToggle) {
                voiceToggle.addEventListener('click', function() {
                    voiceEnabled = !voiceEnabled;
                    this.innerHTML = `<i class="fas fa-volume-${voiceEnabled ? 'up' : 'mute'}"></i> Voice: ${voiceEnabled ? 'ON' : 'OFF'}`;
                    showNotification("Voice Feedback", voiceEnabled ? "Mickey's voice is ON! " : "Voice is OFF", "info");
                });
            }
        }
        
        function readQuestionAloud() {
            const gameQuestion = document.querySelector('.game-question');
            if (gameQuestion) {
                const questionText = gameQuestion.innerText;
                if (voiceEnabled && questionText) {
                    speakText(questionText);
                }
            }
        }
        function showMickeyAgent() {
            const agentContainer = document.getElementById('empathic-agent');
            if (!agentContainer) return;
            
            const messagesContainer = document.getElementById('agent-messages');
            if (messagesContainer && messagesContainer.children.length === 0) {
                addMickeyMessage("Hi there! I'm Mickey! ");
                addMickeyMessage("I notice when you're feeling frustrated or need help!");
                addMickeyMessage("When I pop up, I'll give you options to feel better!");
            }
            
            agentContainer.style.display = 'block';
            mickeyAgentVisible = true;
        }
        
function addMickeyMessage(text) {
    const messagesContainer = document.getElementById('agent-messages');
    if (!messagesContainer) return;
    
    const messageDiv = document.createElement('div');
    messageDiv.className = 'agent-message bot';
    messageDiv.innerHTML = `
        <div style="display: flex; align-items: flex-start; gap: 10px;">
            <!-- YOUR PHOTO AVATAR IN MESSAGES -->
            <div style="
            width: 30px; 
            overflow: hidden; 
            flex-shrink: 0;">
                <img src="images/toodles.png" alt="Your Photo" style="width: 100%; height: 100%; object-fit: cover;">
            </div>
            <div style="flex: 1;">${text}</div>
        </div>
    `;
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    // Speak the message if voice is enabled
    if (voiceEnabled && text) {
        speakText(text);
    }
}
        
        function speakText(text) {
            if ('speechSynthesis' in window && voiceEnabled) {
                speechSynthesis.cancel(); // Cancel any ongoing speech
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 0.9; // Slightly slower for children
                utterance.pitch = 1.2; // Higher pitch for Mickey-like voice
                utterance.volume = 1;
                
                // Try to get a child-friendly voice
                const voices = speechSynthesis.getVoices();
                const childVoice = voices.find(voice => 
                    voice.name.includes('Child') || 
                    voice.name.includes('Kids') ||
                    voice.lang.includes('en')
                );
                
                if (childVoice) {
                    utterance.voice = childVoice;
                }
                
                speechSynthesis.speak(utterance);
            }
        }
        
        function playMickeyAudio(scenario) {
            if (!voiceEnabled) return;
            
            const audioMessages = {
                "welcome": "Oh boy! Welcome to Mickey's Learning Hub! I'm so excited to help you learn today!",
                "start_tracing": "Let's trace some letters! Follow the green dot and have fun!",
                "correct": "Wow! That's absolutely correct! You're doing amazing!",
                "incorrect": "That's okay! Let's try again. I know you can do it!",
                "frustrated": "I see you're feeling frustrated. How about we take a little break?",
                "happy": "You're doing great! I'm so proud of you!",
                "break_over": "Break time is over! Ready to continue our learning adventure?",
                "continue": "Great! Let's continue with our learning journey!",
                "game_complete": "Hooray! You completed the game! You're a superstar!"
            };
            
            const message = audioMessages[scenario] || "Great job! Keep going!";
            speakText(message);
        }
        
        function triggerMickeyIntervention(emotion) {
            // First show speaking bot with intervention message
            speakIntervention(emotion);
            
            // Then show regular intervention modal
            setTimeout(() => {
                showInterventionModal(emotion);
            }, 2000); // Wait for speech to complete
        }
        
        function showInterventionModal(emotion) {
            const modal = document.getElementById('intervention-modal');
            const title = document.getElementById('intervention-title');
            const optionsContainer = document.getElementById('intervention-options');
            
            const titles = {
                frustrated: "You seem frustrated with this question...",
                sad: "I notice you're feeling a bit down...",
                bored: "This might not be engaging enough...",
                confused: "This seems confusing..."
            };
            
            title.textContent = titles[emotion] || "I notice you might need help!";
            optionsContainer.innerHTML = '';
            
            const options = [
                { type: "break", text: "Take a 30-second break", icon: "fa-coffee" },
                { type: "easier", text: "Make questions easier", icon: "fa-thumbs-up" },
                { type: "next", text: "Skip to next question", icon: "fa-forward" },
                { type: "help", text: "Explain this differently", icon: "fa-question-circle" }
            ];
            
            options.forEach(option => {
                const button = document.createElement('button');
                button.className = `intervention-btn ${option.type === 'break' ? 'break' : option.type === 'easier' ? 'easy' : option.type === 'next' ? 'next' : ''}`;
                button.innerHTML = `
                    <i class="fas ${option.icon}"></i>
                    ${option.text}
                `;
                button.onclick = () => handleInterventionChoice(option.type);
                optionsContainer.appendChild(button);
            });
            
            modal.style.display = 'block';
            addMickeyMessage(`I noticed you might be feeling ${emotion}. I've popped up some options to help! `);
        }
        
        function handleInterventionChoice(choice) {
            const modal = document.getElementById('intervention-modal');
            modal.style.display = 'none';
            
            switch(choice) {
                case 'break':
                    startMickeyBreak();
                    break;
                case 'easier':
                    makeGameEasier();
                    break;
                case 'next':
                    skipToNext();
                    break;
                case 'help':
                    explainDifferently();
                    break;
            }
            
            frustrationLevel = 0;
        }
        
        // ============================================
        // BREAK TIMER FUNCTIONS
        // ============================================
        
        function startMickeyBreak() {
            document.getElementById('intervention-modal').style.display = 'none';
            
            // Speak break suggestion
            speakBreakSuggestion();
            
            // Then start break timer
            setTimeout(() => {
                const breakTimer = document.getElementById('break-timer');
                breakTimer.classList.add('show');
                
                breakTimerActive = true;
                breakTimeLeft = 30;
                updateBreakTimer();
                
                breakInterval = setInterval(() => {
                    breakTimeLeft--;
                    updateBreakTimer();
                    
                    if (breakTimeLeft <= 0) {
                        endMickeyBreak();
                    }
                }, 1000);
                
                startBreathingAnimation();
            }, 3000); // Wait for speech to complete
        }  

        function updateBreakTimer() {
            const timerDisplay = document.getElementById('timer-display');
            if (timerDisplay) {
                const minutes = Math.floor(breakTimeLeft / 60);
                const seconds = breakTimeLeft % 60;
                timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }
        
        function startBreathingAnimation() {
            const breathingText = document.getElementById('breathing-animation');
            if (!breathingText) return;
            
            let phase = 'in';
            let count = 4;
            
            clearInterval(breathingInterval);
            
            breathingInterval = setInterval(() => {
                if (count === 0) {
                    phase = phase === 'in' ? 'hold' : phase === 'hold' ? 'out' : 'in';
                    count = phase === 'in' ? 4 : phase === 'hold' ? 4 : 6;
                }
                
                let text = '';
                let emoji = '';
                
                switch(phase) {
                    case 'in':
                        text = `Breathe IN... (${count} seconds)`;
                        emoji = '';
                        break;
                    case 'hold':
                        text = `Hold... (${count} seconds)`;
                        emoji = '';
                        break;
                    case 'out':
                        text = `Breathe OUT... (${count} seconds)`;
                        emoji = '';
                        break;
                }
                
                breathingText.innerHTML = `${emoji} ${text}`;
                count--;
                
                if (!breakTimerActive) {
                    clearInterval(breathingInterval);
                }
            }, 1000);
        }
        
        function endMickeyBreak() {
            breakTimerActive = false;
            clearInterval(breakInterval);
            clearInterval(breathingInterval);
            
            const breakTimer = document.getElementById('break-timer');
            breakTimer.classList.remove('show');
            
            setTimeout(() => {
                showMickeyAgent();
                addMickeyMessage("Break time's over! Ready to continue? ");
                addMickeyMessage("You're doing great! Let's get back to it! ");
                playMickeyAudio("break_over");
            }, 500);
        }
        
        function makeGameEasier() {
            isEasyMode = true;
            addMickeyMessage("I'll make the questions easier for you! ");
            if (currentGame) {
                if (currentGame === 'tracing') {
                    // For tracing, we can adjust tolerance
                    tracingEngine.tolerance = 30;
                    addMickeyMessage("I've made the tracing more forgiving!");
                } else {
                    document.getElementById('module-content-body').innerHTML = generateGameActivity(currentGame, currentActivityIndex);
                }
            }
        }
        
        function skipToNext() {
            if (currentGame && currentActivityIndex < learningGames[currentGame].activities.length - 1) {
                currentActivityIndex++;
                
                if (currentGame === 'tracing') {
                    loadTracingActivity(currentActivityIndex);
                } else {
                    document.getElementById('module-content-body').innerHTML = generateGameActivity(currentGame, currentActivityIndex);
                }
                
                frustrationLevel = 0;
                addMickeyMessage("Let's skip to the next activity! ");
            }
        }
        
        function explainDifferently() {
            addMickeyMessage("Let me explain this in a different way! ");
            
            if (currentGame === 'tracing') {
                const activity = learningGames.tracing.activities[currentActivityIndex];
                tracingEngine.showFeedback(activity.hint || "Start from the green dot and follow the path", "needs-improvement");
            }
        }
        
        // ============================================
        // STUDENT PROFILE ANALYSIS FUNCTIONS
        // ============================================
        
        function updateProfileDisplay() {
            document.getElementById('student-points').textContent = studentScore;
            
            const completedGames = Object.values(learningGames).filter(g => g.completed).length;
            const totalGames = Object.keys(learningGames).length;
            const progressPercent = (completedGames / totalGames) * 100;
            
            document.getElementById('overall-progress').style.width = `${progressPercent}%`;
            document.querySelector('.progress-text').textContent = `${Math.round(progressPercent)}% Complete`;
            
            document.getElementById('games-completed').textContent = `${completedGames}/${totalGames}`;
            document.getElementById('focus-level').textContent = `${empathicAgent.focusLevel || 75}%`;
            
            updateModuleAnalysisChart();
            updateUnderstandingBreakdown();
            updateLearningRecommendations();
            
            const dashboard = createProgressDashboard();
            const dashboardHTML = `
                <div style="margin-top: 30px; background: var(--mickey-yellow); padding: 20px; border-radius: 15px; border: 3px solid var(--mickey-black);">
                    <h4 style="color: var(--mickey-red); margin-bottom: 15px;">Weekly Progress</h4>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <div style="background: white; padding: 10px; border-radius: 10px; border: 2px solid var(--mickey-blue);">
                            <strong style="color: var(--mickey-blue);">This Week's Progress:</strong>
                            <div style="font-size: 1.5rem; color: var(--mickey-red);">${Math.round(progressPercent/4)}%</div>
                        </div>
                        <div style="background: white; padding: 10px; border-radius: 10px; border: 2px solid var(--mickey-blue);">
                            <strong style="color: var(--mickey-blue);">Average Accuracy:</strong>
                            <div style="font-size: 1.5rem; color: var(--mickey-red);">${getAverageAccuracy()}%</div>
                        </div>
                    </div>
                    <div style="margin-top: 20px;">
                        <strong style="color: var(--mickey-blue);">Top Recommendations:</strong>
                        <ul style="margin: 10px 0 0 20px; color: var(--mickey-black);">
                            ${dashboard.recommendedNextSteps.map(step => `<li>${step}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            `;
            document.getElementById('progress-dashboard').innerHTML = dashboardHTML;
        }
        
        function updateModuleAnalysisChart() {
            const chartHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                    ${Object.entries(learningGames).map(([module, data]) => `
                        <div style="background: ${data.completed ? 'var(--mickey-green)' : 'var(--mickey-pink)'}; 
                                    padding: 10px; border-radius: 10px; border: 3px solid var(--mickey-black);
                                    text-align: center;">
                            <div style="font-weight: bold; color: var(--mickey-black);">${module.charAt(0).toUpperCase() + module.slice(1)}</div>
                            <div style="font-size: 1.2rem; color: var(--mickey-blue); margin: 5px 0;">
                                ${data.completed ? '' : ''}
                            </div>
                            <div style="font-size: 0.9rem; color: var(--mickey-black);">
                                ${getModuleProgress(module)}%
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            document.getElementById('module-analysis-chart').innerHTML = chartHTML;
        }
        
        function updateUnderstandingBreakdown() {
            const understandingData = {
                "Letter Recognition": getModuleProgress('letters'),
                "Vowel/Consonant": getModuleProgress('vowels'),
                "Word Building": getModuleProgress('spelling'),
                "Letter Tracing": getModuleProgress('tracing')
            };
            
            const understandingHTML = `
                <div style="display: grid; gap: 10px;">
                    ${Object.entries(understandingData).map(([skill, progress]) => `
                        <div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span style="color: var(--mickey-black);">${skill}</span>
                                <span style="color: var(--mickey-blue); font-weight: bold;">${progress}%</span>
                            </div>
                            <div style="height: 10px; background: var(--mickey-white); border-radius: 5px; border: 2px solid var(--mickey-black); overflow: hidden;">
                                <div style="height: 100%; width: ${progress}%; background: ${getProgressColor(progress)}; border-radius: 5px;"></div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            document.getElementById('understanding-breakdown').innerHTML = understandingHTML;
        }
        
        function updateLearningRecommendations() {
            const recommendations = generateRecommendations();
            
            const recHTML = `
                <div style="display: grid; gap: 15px;">
                    ${recommendations.map((rec, index) => `
                        <div style="background: ${index % 2 === 0 ? 'var(--mickey-yellow)' : 'var(--mickey-green)'}; 
                                    padding: 15px; border-radius: 10px; border: 3px solid var(--mickey-black);
                                    display: flex; align-items: center; gap: 10px;">
                            <div style="width: 40px; height: 40px; background: var(--mickey-red); color: white;
                                      border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                ${index + 1}
                            </div>
                            <div style="color: var(--mickey-black);">${rec}</div>
                        </div>
                    `).join('')}
                </div>
            `;
            document.getElementById('learning-recommendations').innerHTML = recHTML;
        }
        
        function getModuleProgress(module) {
            const game = learningGames[module];
            if (!game) return 0;
            
            if (game.completed) return 100;
            
            const progress = (game.currentActivity + 1) / game.activities.length * 100;
            return Math.min(Math.round(progress), 100);
        }
        
        function getAverageAccuracy() {
            const modules = Object.keys(learningGames);
            if (modules.length === 0) return 0;
            
            const total = modules.reduce((sum, module) => sum + getModuleProgress(module), 0);
            return Math.round(total / modules.length);
        }
        
        function getProgressColor(progress) {
            if (progress >= 80) return '#95e1d3';
            if (progress >= 60) return '#ffd166';
            if (progress >= 40) return '#ffb8c6';
            return '#ff6b8b';
        }
        
        function updateSettingsDisplay() {
            document.getElementById('detection-status').textContent = isCameraStarted ? 'ACTIVE' : 'INACTIVE';
            document.getElementById('detection-status').style.color = isCameraStarted ? '#95e1d3' : '#ff6b8b';
            
            const dyslexiaBtn = document.getElementById('toggle-dyslexia');
            if (dyslexiaBtn) {
                dyslexiaBtn.innerHTML = `<i class="fas fa-toggle-${document.body.classList.contains('dyslexia-mode') ? 'on' : 'off'}"></i> Dyslexia Mode ${document.body.classList.contains('dyslexia-mode') ? 'ON' : 'OFF'}`;
            }
        }
        
        // ============================================
        // GAME FUNCTIONS
        // ============================================
        
        function initGameFunctions() {
            // Start face detection button
            const startFaceDetectionBtn = document.getElementById('start-face-detection');
            if (startFaceDetectionBtn) {
                startFaceDetectionBtn.addEventListener('click', startRealMediaPipeDetection);
            }
            
            // Close module
            const closeModuleBtn = document.getElementById('close-module');
            if (closeModuleBtn) {
                closeModuleBtn.addEventListener('click', closeModule);
            }
        }
        
        function startPeriodicEmotionDetection(detectionFunction) {
            const intervalTimeMs = 10 * 1000;
            
            if (emotionDetectionInterval) {
                clearInterval(emotionDetectionInterval);
            }
            
            secondsCounter = 0;
            detectionCycle = 0;
            
            console.log(`  Emotion detection timer started at: ${getCurrentTime()}`);
            console.log(` Next detection in 10 seconds...`);
            
            const secondTimer = setInterval(() => {
                secondsCounter++;
                console.log(`   ${secondsCounter}s...`);
                
                if (secondsCounter >= 10) {
                    clearInterval(secondTimer);
                }
            }, 1000);
            
            emotionDetectionInterval = setInterval(async () => {
                detectionCycle++;
                
                console.log(`\n DETECTION CYCLE #${detectionCycle} (${getCurrentTime()})`);
                console.log(` Game Active: ${currentGame ? ' Yes' : ' No'}`);
                console.log(` Camera Active: ${isCameraStarted ? ' Yes' : ' No'}`);
                
                try {
                    if (currentGame && isCameraStarted) {
                        const emotionResult = await detectionFunction();
                        console.log(` Detected Emotion: ${emotionResult.emotion || 'neutral'}`);
                        console.log(` Confidence: ${Math.round((emotionResult.confidence || 0.5) * 100)}%`);
                        console.log(` Focus Level: ${empathicAgent.focusLevel || 75}%`);
                        
                        studentEmotion = emotionResult.emotion || 'neutral';
                        empathicAgent.currentEmotion = studentEmotion;
                        empathicAgent.emotionConfidence = emotionResult.confidence || 0.5;
                        
                        if (['frustrated', 'confused', 'bored', 'sad'].includes(studentEmotion)) {
                            frustrationLevel++;
                            console.log(`  Frustration Level: ${frustrationLevel}/${FRUSTRATION_THRESHOLD}`);
                            
                            if (frustrationLevel >= FRUSTRATION_THRESHOLD && !mickeyAgentVisible && !breakTimerActive) {
                                console.log(` Triggering Mickey intervention for: ${studentEmotion}`);
                                triggerMickeyIntervention(studentEmotion);
                                frustrationLevel = 0;
                            }
                        } else {
                            frustrationLevel = Math.max(0, frustrationLevel - 1);
                        }
                    } else {
                        console.log(`  Detection skipped: No active game or camera`);
                    }
                } catch (error) {
                    console.error(` Detection error: ${error.message}`);
                }
                
                secondsCounter = 0;
                console.log(`\n Next detection in 10 seconds...`);
                
                const secondTimer = setInterval(() => {
                    secondsCounter++;
                    console.log(`   ${secondsCounter}s...`);
                    
                    if (secondsCounter >= 10) {
                        clearInterval(secondTimer);
                    }
                }, 1000);
                
            }, intervalTimeMs);
        }
        
        function stopPeriodicEmotionDetection() {
            if (emotionDetectionInterval) {
                clearInterval(emotionDetectionInterval);
                emotionDetectionInterval = null;
                console.log(` Emotion detection stopped at: ${getCurrentTime()}`);
                console.log(` Total cycles completed: ${detectionCycle}`);
            }
        }
        
        function getCurrentTime() {
            const now = new Date();
            return now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'});
        }
        
        function startGame(gameName) {
            currentGame = gameName;
            const game = learningGames[gameName];
            currentActivityIndex = 0;
            
            if (gameName === 'tracing') {
                startTracingGame();
                return;
            }
            
            // For other games, redirect to module page
            document.getElementById('game-center-content-area').classList.remove('active');
            document.getElementById('module-content').classList.add('active');
            
            document.getElementById('module-content-title').textContent = game.title;
            document.getElementById('module-content-body').innerHTML = generateGameActivity(gameName, 0);
            
            if (!isCameraStarted) {
                startRealMediaPipeDetection();
            }
            
            showMickeyAgent();
            
            console.log(` Starting "${game.title}"`);
            startPeriodicEmotionDetection(async () => {
                if (empathicAgent.faceDetected) {
                    return {
                        emotion: empathicAgent.currentEmotion,
                        confidence: empathicAgent.emotionConfidence
                    };
                } else {
                    const emotions = ['happy', 'neutral', 'focused', 'confused', 'frustrated'];
                    const randomEmotion = emotions[Math.floor(Math.random() * emotions.length)];
                    return {
                        emotion: randomEmotion,
                        confidence: 0.7 + Math.random() * 0.2
                    };
                }
            });
        }
        
        function startTracingGame() {
            const game = learningGames.tracing;
            currentActivityIndex = 0;
            
            // Hide main content, show tracing container
            document.getElementById('game-center-content-area').classList.remove('active');
            document.getElementById('tracing-game-container').style.display = 'block';
            
            loadTracingActivity(0);
            
            if (!isCameraStarted) {
                startRealMediaPipeDetection();
            }
            
            showMickeyAgent();
            playMickeyAudio("start_tracing");
            
            startPeriodicEmotionDetection(async () => {
                if (empathicAgent.faceDetected) {
                    return {
                        emotion: empathicAgent.currentEmotion,
                        confidence: empathicAgent.emotionConfidence
                    };
                } else {
                    const emotions = ['happy', 'neutral', 'focused', 'confused', 'frustrated'];
                    const randomEmotion = emotions[Math.floor(Math.random() * emotions.length)];
                    return {
                        emotion: randomEmotion,
                        confidence: 0.7 + Math.random() * 0.2
                    };
                }
            });
        }
        
        function loadTracingActivity(activityIndex) {
            const game = learningGames.tracing;
            const activity = game.activities[activityIndex];
            
            document.getElementById('target-letter').textContent = activity.letter;
            document.getElementById('tracing-counter').textContent = `Activity ${activityIndex + 1} of ${game.activities.length}`;
            
            // Update navigation buttons
            document.getElementById('prev-tracing').disabled = activityIndex === 0;
            document.getElementById('next-tracing').disabled = activityIndex === game.activities.length - 1;
            
            // Initialize tracing engine
            setTimeout(() => {
                tracingEngine.initialize('tracing-canvas');
                tracingEngine.setTargetLetter(activity.letter, activity.strokeOrder);
            }, 100);
            
            // Setup controls
            document.getElementById('clear-trace').onclick = () => tracingEngine.clearCanvas();
            document.getElementById('check-trace').onclick = () => tracingEngine.analyzeTrace();
            document.getElementById('auto-trace').onclick = () => tracingEngine.showDemo();
            document.getElementById('hint-trace').onclick = () => {
                tracingEngine.showFeedback(activity.hint || "Start from the green dot and follow the path", "needs-improvement");
            };
            
            // Play sound button
            document.getElementById('play-sound-btn').onclick = () => {
                const utterance = new SpeechSynthesisUtterance(activity.letter);
                utterance.rate = 0.7;
                speechSynthesis.speak(utterance);
            };
        }
        
        function prevTracingActivity() {
            if (currentActivityIndex > 0) {
                currentActivityIndex--;
                loadTracingActivity(currentActivityIndex);
                frustrationLevel = 0;
            }
        }
        
        function nextTracingActivity() {
            const game = learningGames.tracing;
            if (currentActivityIndex < game.activities.length - 1) {
                currentActivityIndex++;
                loadTracingActivity(currentActivityIndex);
                frustrationLevel = 0;
            } else {
                completeGame('tracing');
            }
        }
        
        function viewModule(moduleName) {
            const game = learningGames[moduleName];
            document.getElementById('module-content-title').textContent = `${game.title} - Information`;
            document.getElementById('module-content-body').innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 4rem; color: var(--mickey-yellow); margin-bottom: 20px;">
                        <i class="fas fa-info-circle"></i>
                    </div>
                    <h3 style="color: var(--mickey-blue);">${game.description}</h3>
                    <div style="background: var(--mickey-white); padding: 25px; border-radius: 20px; border: 4px solid var(--mickey-black); margin: 30px auto; max-width: 600px;">
                        <h4 style="color: var(--mickey-red);">Enhanced Features:</h4>
                        <ul style="text-align: left; color: var(--mickey-black); font-family: 'Comic Neue', cursive; font-size: 1.1rem;">
                            <li> <strong>468-point facial landmark detection</strong></li>
                            <li> <strong>Multiple landmark emotion scoring system</strong></li>
                            <li> <strong>Real-time temporal smoothing</strong></li>
                            <li> <strong>Enhanced smile/frown detection</strong></li>
                            <li> <strong>Brow asymmetry analysis</strong></li>
                            <li> <strong>Eye squint detection</strong></li>
                            <li> <strong>Head tilt analysis</strong></li>
                            <li> <strong>Proactive interventions</strong></li>
                        </ul>
                    </div>
                    <div style="margin-top: 30px;">
                        <button class="module-btn start-btn" onclick="startGame('${moduleName}')" 
                                style="padding: 15px 30px; font-size: 1.2rem;">
                            <i class="fas fa-play"></i> Play Game Now!
                        </button>
                    </div>
                </div>
            `;
            document.getElementById('module-content').classList.add('active');
        }
        
        function generateGameActivity(gameName, activityIndex) {
            const game = learningGames[gameName];
            const activity = game.activities[activityIndex];
            
            const easyClass = isEasyMode ? 'easy-mode' : '';
            
            let contentHTML = '';
            
            // COMMON GAME HEADER
            const gameHeader = `
                <div class="game-counter">
                    Activity ${activityIndex + 1} of ${game.activities.length}
                    ${isEasyMode ? '<span style="color: var(--mickey-green); margin-left: 10px;"><i class="fas fa-child"></i> Simple Mode</span>' : ''}
                </div>
                
                <!-- DYSLEXIA SUPPORT HEADER -->
                <div class="dyslexia-support-header" style="background: #e6f7ff; padding: 15px; border-radius: 15px; border: 3px solid var(--mickey-blue); margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 10px; color: var(--mickey-blue);">
                        <i class="fas fa-lightbulb"></i>
                        <strong>Dyslexia Tips for this activity:</strong>
                    </div>
                    <ul style="margin: 10px 0 0 20px; color: var(--mickey-black); font-family: 'OpenDyslexic', sans-serif; font-size: 0.9em;">
                        ${game.dyslexia_tips.map(tip => `<li>${tip}</li>`).join('')}
                    </ul>
                </div>
            `;
            
            if (activity.type === "letter_recognition" || activity.type === "vowel_identification" || 
                activity.type === "consonant_identification" || activity.type === "letter_sequence") {
                
                const questionText = activity.question || "Identify the correct answer:";
                const optionsList = activity.options || ["Option 1", "Option 2", "Option 3", "Option 4"];
                
                contentHTML = `
                    <div class="game-container ${easyClass}">
                        ${gameHeader}
                        
                        <div class="game-question">
                            <i class="fas fa-question-circle" style="color: var(--mickey-red); margin-right: 10px;"></i>
                            ${questionText}
                            
                            ${activity.letter ? `
                                <div style="margin-top: 15px; font-size: 5rem; text-align: center; color: var(--mickey-red);">
                                    ${activity.letter}
                                </div>
                            ` : ''}
                            
                            ${activity.letters ? `
                                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 20px; font-size: 3rem;">
                                    ${activity.letters.map(letter => `<div style="background: var(--mickey-yellow); padding: 10px; border-radius: 10px; border: 3px solid var(--mickey-black);">${letter}</div>`).join('')}
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="game-options">
                            ${optionsList.map((option, index) => `
                                <div class="game-option" onclick="checkAnswer(${index}, '${gameName}')">
                                    ${option}
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="game-feedback" id="game-feedback"></div>
                        <div class="game-progress">
                            <div class="progress-bar" id="game-progress" 
                                style="width: ${((activityIndex + 1) / game.activities.length) * 100}%"></div>
                            <div class="progress-text">
                                ${activityIndex + 1} of ${game.activities.length} activities completed
                            </div>
                        </div>
                        <div class="game-navigation">
                            <button class="nav-btn" ${activityIndex === 0 ? 'disabled' : ''} 
                                    onclick="previousActivity('${gameName}')">
                                <i class="fas fa-arrow-left"></i> Previous
                            </button>
                            <button class="nav-btn" onclick="nextActivity('${gameName}')" 
                                    ${activityIndex === game.activities.length - 1 ? 'disabled' : ''}>
                                Next <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                `;
            }
            
            return contentHTML;
        }
        
        function checkAnswer(answerIndex, gameName) {
            const game = learningGames[gameName];
            const activity = game.activities[currentActivityIndex];
            const feedback = document.getElementById('game-feedback');
            const options = document.querySelectorAll('.game-option');
            
            options.forEach(opt => {
                opt.classList.remove('correct', 'wrong');
            });
            
            if (answerIndex === activity.correct) {
                // Correct answer
                options[answerIndex].classList.add('correct');
                
                feedback.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <i class="fas fa-check-circle" style="color: var(--mickey-green); font-size: 2rem;"></i>
                        <div>
                            <strong style="color: var(--mickey-green); font-family: 'OpenDyslexic', sans-serif;">Oh boy! Correct!</strong>
                            <p style="margin: 5px 0; color: var(--mickey-white); font-family: 'OpenDyslexic', sans-serif;">${activity.explanation}</p>
                            <p style="margin: 5px 0; color: var(--mickey-yellow);">
                                <i class="fas fa-star"></i> +${activity.points} Mickey Points!
                            </p>
                        </div>
                    </div>
                `;
                
                // Award points
                studentScore += activity.points;
                document.getElementById('student-points').textContent = studentScore;
                
                studentEmotion = "happy";
                frustrationLevel = 0;
                
                // Play correct audio
                playMickeyAudio("correct");
                
                // Auto-advance
                setTimeout(() => {
                    if (currentActivityIndex < game.activities.length - 1) {
                        nextActivity(gameName);
                    } else {
                        completeGame(gameName);
                    }
                }, 2500);
                
            } else {
                // Wrong answer
                options[answerIndex].classList.add('wrong');
                options[activity.correct].classList.add('correct');
                
                feedback.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <i class="fas fa-times-circle" style="color: var(--mickey-red); font-size: 2rem;"></i>
                        <div>
                            <strong style="color: var(--mickey-red); font-family: 'OpenDyslexic', sans-serif;">Let's try again!</strong>
                            <p style="margin: 5px 0; color: var(--mickey-white); font-family: 'OpenDyslexic', sans-serif;">
                                The correct answer is: ${activity.options[activity.correct]}
                            </p>
                        </div>
                    </div>
                `;
                
                // Play incorrect audio
                playMickeyAudio("incorrect");
                
                // Negative emotional feedback
                studentEmotion = "confused";
                frustrationLevel++;
                
                // Check for intervention
                if (frustrationLevel >= FRUSTRATION_THRESHOLD) {
                    triggerMickeyIntervention("confused");
                }
            }
            
            feedback.classList.add('show');
        }
        
        function nextActivity(gameName) {
            if (currentActivityIndex < learningGames[gameName].activities.length - 1) {
                currentActivityIndex++;
                document.getElementById('module-content-body').innerHTML = generateGameActivity(gameName, currentActivityIndex);
                frustrationLevel = 0;
            }
        }
        
        function previousActivity(gameName) {
            if (currentActivityIndex > 0) {
                currentActivityIndex--;
                document.getElementById('module-content-body').innerHTML = generateGameActivity(gameName, currentActivityIndex);
                frustrationLevel = 0;
            }
        }
        
        function completeGame(gameName) {
            const game = learningGames[gameName];
            game.completed = true;
            
            // Speak game completion message
            speakGameComplete();
            
            const totalPoints = game.activities.reduce((sum, activity) => sum + (activity.points || 0), 0);
            
            stopCameraDetection();
            
            // Show completion screen after speech
            setTimeout(() => {
                if (gameName === 'tracing') {
                    document.getElementById('tracing-game-container').innerHTML = `
                        <div style="text-align: center; padding: 60px 40px;">
                            <div style="font-size: 6rem; color: var(--mickey-yellow); margin-bottom: 30px;">
                                <i class="fas fa-trophy"></i>
                            </div>
                            <h2 style="color: var(--mickey-red);">Tracing Master!</h2>
                            <p style="color: var(--mickey-blue); font-family: 'Comic Neue', cursive; font-size: 1.3rem;">
                                You've mastered letter tracing!
                            </p>
                            <div style="background: var(--mickey-yellow); padding: 25px; border-radius: 20px; 
                                        border: 4px solid var(--mickey-black); margin: 30px auto; max-width: 400px;">
                                <h3 style="color: var(--mickey-black); margin: 0 0 15px 0;">
                                    <i class="fas fa-star"></i> You earned ${totalPoints} Mickey Points!
                                </h3>
                                <p style="color: var(--mickey-red); font-size: 1.2rem;">
                                    Total Score: <strong>${studentScore}</strong> points
                                </p>
                            </div>
                            <button class="module-btn start-btn" onclick="closeTracingGame()" style="padding: 15px 30px;">
                                <i class="fas fa-check"></i> Great Job! Back to Games
                            </button>
                        </div>
                    `;
                } else {
                    document.getElementById('module-content-body').innerHTML = `
                        <div style="text-align: center; padding: 60px 40px;">
                            <div style="font-size: 6rem; color: var(--mickey-yellow); margin-bottom: 30px;">
                                <i class="fas fa-trophy"></i>
                            </div>
                            <h2 style="color: var(--mickey-red);">Congratulations!</h2>
                            <p style="color: var(--mickey-blue); font-family: 'Comic Neue', cursive; font-size: 1.3rem;">
                                You've completed ${game.title}!
                            </p>
                            <div style="background: var(--mickey-yellow); padding: 25px; border-radius: 20px; 
                                        border: 4px solid var(--mickey-black); margin: 30px auto; max-width: 400px;">
                                <h3 style="color: var(--mickey-black); margin: 0 0 15px 0;">
                                    <i class="fas fa-star"></i> You earned ${totalPoints} Mickey Points!
                                </h3>
                                <p style="color: var(--mickey-red); font-size: 1.2rem;">
                                    Total Score: <strong>${studentScore}</strong> points
                                </p>
                            </div>
                            <button class="module-btn start-btn" onclick="closeModule()" style="padding: 15px 30px;">
                                <i class="fas fa-check"></i> Great Job! Play Another Game
                            </button>
                        </div>
                    `;
                }
                
                // Update progress
                updateProfileDisplay();
                
                stopPeriodicEmotionDetection();
            }, 2000); // Wait for speech to complete
        }
        
        function closeTracingGame() {
            document.getElementById('tracing-game-container').style.display = 'none';
            document.getElementById('game-center-content-area').classList.add('active');
            closeModule();
        }

        function closeModule() {
            if (currentGame && isCameraStarted) {
                stopCameraDetection();
                stopPeriodicEmotionDetection(); 
            }
            
            frustrationLevel = 0;
            studentEmotion = 'neutral';
            
            document.getElementById('module-content').classList.remove('active');
            document.getElementById('status-text').innerHTML = 
                `<span style="color: var(--mickey-blue);">Ready for more learning fun!</span>`;
            
            currentGame = null;
        }

        // ============================================
        // INDEPENDENT SPEAKING BOT SYSTEM
        // ============================================

        // Bot speaking queue system
        const botSpeakingQueue = {
            messages: [],
            isSpeaking: false,
            currentUtterance: null,
            currentCallback: null,
            autoClose: true
        };

        // Common bot phrases for different scenarios
        const botPhrases = {
            welcome: [
                "Welcome back! Ready for some learning fun?",
                "Great to see you again! Let's continue our adventure!",
                "Hello there! I'm excited to help you learn today!"
            ],
            
            intervention: {
                frustrated: [
                    "I notice you're feeling frustrated. How about we try a different approach?",
                    "This seems tricky. Would you like some help?",
                    "Let's take a deep breath and try again together!"
                ],
                confused: [
                    "I see you're confused. Let me explain this in a different way.",
                    "This can be confusing. How about I break it down for you?",
                    "I understand this is tricky. Let me help you understand better."
                ],
                bored: [
                    "Seems like we need something more exciting! Want to try a different activity?",
                    "Let's spice things up! How about we play a game instead?",
                    "I think we need a change of pace. What would you like to do?"
                ]
            },
            
            greeting: [
                "Yes! How may I help you?",
                "I'm here! What can I do for you?",
                "Hello! What would you like to know?",
                "How can I assist you today?"
            ],
            
            encouragement: [
                "You're doing amazing! Keep up the great work!",
                "Wow! I'm so impressed with your progress!",
                "You're getting better every time! I'm so proud of you!",
                "That was fantastic! You're a natural at this!"
            ],
            
            correction: [
                "That's okay! Let's try it again together.",
                "Almost there! Try one more time.",
                "Good effort! Now let me show you the right way.",
                "Not quite, but you're getting closer!"
            ],
            
            break: [
                "Time for a quick break! Let's stretch and come back refreshed!",
                "Great work so far! How about a 30-second break?",
                "You've been working hard! Let's take a moment to relax."
            ],
            
            gameComplete: [
                "Congratulations! You completed the game! You're a superstar!",
                "Amazing job! You finished all the activities!",
                "Hooray! You did it! I'm so proud of you!"
            ]
        };

        // Initialize the speaking bot system
        function initSpeakingBot() {
            // Already handled in initBubbleHandlers, just initialize the rest
            console.log("Initializing speaking bot system...");
            
            // Continue button
            const continueBtn = document.getElementById('bot-speaker-continue');
            if (continueBtn) {
                continueBtn.addEventListener('click', hideSpeakingBot);
            }
            
            // Escape key to close
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && document.getElementById('speaking-bot-overlay').style.display === 'block') {
                    hideSpeakingBot();
                }
            });
            
            // Click outside to close (only when autoClose is false)
            const overlay = document.getElementById('speaking-bot-overlay');
            if (overlay) {
                overlay.addEventListener('click', function(e) {
                    if (e.target === this && !botSpeakingQueue.autoClose) {
                        hideSpeakingBot();
                    }
                });
            }
            
            // Speak welcome message if just logged in
            const userRole = localStorage.getItem('userRole');
            if (userRole) {
                setTimeout(() => {
                    speakWelcomeMessage();
                }, 1000);
            }
            
            console.log(" Speaking bot system initialized!");
        }

        // Handle clicking on the speaking bot bubble
        function handleSpeakingBotClick() {
            // If bot is currently speaking, stop it
            if (botSpeakingQueue.isSpeaking) {
                stopBotSpeaking();
                hideSpeakingBot();
                return;
            }
            
            // If bot was just speaking and closed, show greeting
            if (document.getElementById('speaking-bot-overlay').style.display === 'none') {
                speakBotGreeting();
            }
        }

        // Show the speaking bot overlay
        function showSpeakingBot(message, options = {}) {
            const overlay = document.getElementById('speaking-bot-overlay');
            const container = document.getElementById('speaking-bot-container');
            const statusText = document.getElementById('bot-speaker-status-text');
            const continueBtn = document.getElementById('bot-speaker-continue');
            const sideBubble = document.getElementById('side-speaking-bot');
            
            // Set options
            const settings = {
                autoClose: options.autoClose !== undefined ? options.autoClose : true,
                onComplete: options.onComplete || null,
                type: options.type || 'info',
                duration: options.duration || 3000
            };
            
            botSpeakingQueue.autoClose = settings.autoClose;
            botSpeakingQueue.currentCallback = settings.onComplete;
            
            // Update side bubble state
            if (sideBubble) {
                sideBubble.classList.add('active');
            }
            
            // Hide message indicator
            hideBotMessageIndicator();
            
            // Show overlay
            overlay.style.display = 'block';
            container.classList.add('speaking');
            
            // Update status text
            if (statusText) {
                statusText.textContent = getStatusText(settings.type);
            }
            
            // Hide continue button initially
            continueBtn.classList.remove('show');
            
            // Start speaking
            speakBotMessage(message, settings);
        }

        // Hide the speaking bot
        function hideSpeakingBot() {
            const overlay = document.getElementById('speaking-bot-overlay');
            const container = document.getElementById('speaking-bot-container');
            const continueBtn = document.getElementById('bot-speaker-continue');
            const sideBubble = document.getElementById('side-speaking-bot');
            
            // Stop any ongoing speech
            stopBotSpeaking();
            
            // Update side bubble state
            if (sideBubble) {
                sideBubble.classList.remove('active');
                
                // Show message indicator if there are queued messages
                if (botSpeakingQueue.messages.length > 0) {
                    showBotMessageIndicator();
                }
            }
            
            // Hide elements
            overlay.style.display = 'none';
            container.classList.remove('speaking');
            continueBtn.classList.remove('show');
            
            // Clear queue if autoClose is true
            if (botSpeakingQueue.autoClose) {
                botSpeakingQueue.messages = [];
            }
            
            // Process next in queue
            processSpeakingQueue();
        }

        // Queue a message for the bot to speak
        function queueBotMessage(message, options = {}) {
            botSpeakingQueue.messages.push({
                message: message,
                options: options
            });
            
            // Show message indicator on side bubble
            if (!botSpeakingQueue.isSpeaking) {
                showBotMessageIndicator();
            }
            
            // Start processing if not already speaking
            if (!botSpeakingQueue.isSpeaking) {
                processSpeakingQueue();
            }
        }

        // Process the speaking queue
        function processSpeakingQueue() {
            if (botSpeakingQueue.messages.length === 0 || botSpeakingQueue.isSpeaking) {
                return;
            }
            
            const nextItem = botSpeakingQueue.messages.shift();
            showSpeakingBot(nextItem.message, nextItem.options);
        }

        // Core speaking function
        function speakBotMessage(message, settings) {
            if (!voiceEnabled) {
                // If voice is disabled, just show the bot briefly
                setTimeout(() => {
                    completeSpeaking(settings);
                }, 2000);
                return;
            }
            
            botSpeakingQueue.isSpeaking = true;
            
            // Create speech synthesis utterance
            const utterance = new SpeechSynthesisUtterance(message);
            utterance.rate = 0.9;
            utterance.pitch = 1.2;
            utterance.volume = 1;
            
            // Try to get a friendly voice
            const voices = speechSynthesis.getVoices();
            const friendlyVoice = voices.find(voice => 
                voice.name.includes('Child') || 
                voice.name.includes('Kids') ||
                voice.lang.includes('en')
            );
            
            if (friendlyVoice) {
                utterance.voice = friendlyVoice;
            }
            
            // Event handlers
            utterance.onstart = function() {
                onSpeechStart(settings);
            };
            
            utterance.onend = function() {
                completeSpeaking(settings);
            };
            
            utterance.onerror = function() {
                completeSpeaking(settings);
            };
            
            // Start speaking
            botSpeakingQueue.currentUtterance = utterance;
            speechSynthesis.speak(utterance);
            
            // Animate volume bar
            animateVoiceWaves();
        }

        // Function called when speech starts
        function onSpeechStart(settings) {
            const container = document.getElementById('speaking-bot-container');
            const waves = document.getElementById('speaker-waves');
            
            if (container) container.classList.add('speaking');
            if (waves) waves.style.display = 'block';
        }

        // Function called when speech completes
        function completeSpeaking(settings) {
            const continueBtn = document.getElementById('bot-speaker-continue');
            
            // Update UI
            const container = document.getElementById('speaking-bot-container');
            const waves = document.getElementById('speaker-waves');
            const statusText = document.getElementById('bot-speaker-status-text');
            
            if (container) container.classList.remove('speaking');
            if (waves) waves.style.display = 'none';
            if (statusText) statusText.textContent = "Ready!";
            
            // Show continue button if autoClose is false
            if (!botSpeakingQueue.autoClose && continueBtn) {
                continueBtn.classList.add('show');
            }
            
            // Call callback if provided
            if (botSpeakingQueue.currentCallback) {
                botSpeakingQueue.currentCallback();
                botSpeakingQueue.currentCallback = null;
            }
            
            // Mark as not speaking
            botSpeakingQueue.isSpeaking = false;
            botSpeakingQueue.currentUtterance = null;
            
            // Auto hide if enabled
            if (botSpeakingQueue.autoClose) {
                setTimeout(() => {
                    if (!botSpeakingQueue.isSpeaking) {
                        hideSpeakingBot();
                    }
                }, 1000);
            }
            
            // Process next in queue
            setTimeout(processSpeakingQueue, 500);
        }

        // Stop current speaking
        function stopBotSpeaking() {
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }
            
            if (botSpeakingQueue.currentUtterance) {
                speechSynthesis.cancel();
                botSpeakingQueue.currentUtterance = null;
            }
            
            botSpeakingQueue.isSpeaking = false;
        }

        // Animate volume bar during speech
        function animateVoiceWaves() {
            const voiceBars = document.querySelectorAll('.voice-wave-bar');
            if (!voiceBars.length) return;
            
            let animationInterval = setInterval(() => {
                if (!botSpeakingQueue.isSpeaking) {
                    clearInterval(animationInterval);
                    resetVoiceWaves();
                    return;
                }
                
                // Animate each bar with random heights
                voiceBars.forEach((bar, index) => {
                    const delay = index * 0.1;
                    const height = 10 + Math.random() * 20;
                    
                    setTimeout(() => {
                        bar.style.height = `${height}px`;
                        bar.style.opacity = 0.5 + Math.random() * 0.5;
                    }, delay * 100);
                });
                
            }, 200);
        }

        // Reset voice waves to initial state
        function resetVoiceWaves() {
            const voiceBars = document.querySelectorAll('.voice-wave-bar');
            voiceBars.forEach(bar => {
                bar.style.height = '10px';
                bar.style.opacity = '0.5';
            });
        }

        // Get appropriate status text based on type
        function getStatusText(type) {
            switch(type) {
                case 'welcome': return "Welcoming you...";
                case 'greeting': return "How can I help?";
                case 'intervention': return "Offering help...";
                case 'encouragement': return "Cheering you on!";
                case 'correction': return "Helping out...";
                case 'break': return "Suggesting a break...";
                case 'complete': return "Celebrating!";
                default: return "Speaking...";
            }
        }

        // Show message indicator on side bubble
        function showBotMessageIndicator() {
            const sideBubble = document.getElementById('side-speaking-bot');
            const indicator = document.getElementById('bot-message-indicator');
            
            if (sideBubble && indicator) {
                sideBubble.classList.add('has-message');
                indicator.style.display = 'block';
            }
        }

        // Hide message indicator
        function hideBotMessageIndicator() {
            const sideBubble = document.getElementById('side-speaking-bot');
            const indicator = document.getElementById('bot-message-indicator');
            
            if (sideBubble && indicator) {
                sideBubble.classList.remove('has-message');
                indicator.style.display = 'none';
            }
        }

        // ============================================
        // HELPER FUNCTIONS TO USE THE SPEAKING BOT
        // ============================================

        // Welcome message (after login)
        function speakWelcomeMessage() {
            const message = botPhrases.welcome[Math.floor(Math.random() * botPhrases.welcome.length)];
            queueBotMessage(message, {
                type: 'welcome',
                autoClose: true,
                onComplete: function() {
                    // Show regular Mickey agent after welcome
                    setTimeout(() => {
                        showMickeyAgent();
                    }, 500);
                }
            });
        }

        // Greeting message (when clicking the bot)
        function speakBotGreeting() {
            const message = botPhrases.greeting[Math.floor(Math.random() * botPhrases.greeting.length)];
            queueBotMessage(message, {
                type: 'greeting',
                autoClose: false, // Don't auto-close, wait for user interaction
                onComplete: function() {
                    // After greeting, the bot stays open for user to respond
                }
            });
        }

        // Intervention message (when frustrated/confused)
        function speakIntervention(emotion = 'frustrated') {
            const messages = botPhrases.intervention[emotion] || botPhrases.intervention.frustrated;
            const message = messages[Math.floor(Math.random() * messages.length)];
            
            queueBotMessage(message, {
                type: 'intervention',
                autoClose: false, // Don't auto-close for interventions
                onComplete: function() {
                    // Keep bot open for user response
                }
            });
        }

        // Encouragement message
        function speakEncouragement() {
            const message = botPhrases.encouragement[Math.floor(Math.random() * botPhrases.encouragement.length)];
            queueBotMessage(message, {
                type: 'encouragement',
                autoClose: true
            });
        }

        // Correction message
        function speakCorrection() {
            const message = botPhrases.correction[Math.floor(Math.random() * botPhrases.correction.length)];
            queueBotMessage(message, {
                type: 'correction',
                autoClose: true
            });
        }

        // Break suggestion
        function speakBreakSuggestion() {
            const message = botPhrases.break[Math.floor(Math.random() * botPhrases.break.length)];
            queueBotMessage(message, {
                type: 'break',
                autoClose: false
            });
        }

        // Game completion
        function speakGameComplete() {
            const message = botPhrases.gameComplete[Math.floor(Math.random() * botPhrases.gameComplete.length)];
            queueBotMessage(message, {
                type: 'complete',
                autoClose: true
            });
        }

        // Custom message with options
        function speakCustomMessage(message, options = {}) {
            queueBotMessage(message, {
                type: options.type || 'info',
                autoClose: options.autoClose !== undefined ? options.autoClose : true,
                onComplete: options.onComplete || null,
                duration: options.duration || 3000
            });
        }

        // ============================================
        // MEDIAPIPE FACE DETECTION FUNCTIONS
        // ============================================
        
        function initMediaPipeFaceDetection() {
            console.log(" Initializing Google MediaPipe Face Detection...");
            
            faceMesh.onResults((results) => {
                canvasCtx.save();
                canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
                
                canvasCtx.scale(-1, 1);
                canvasCtx.translate(-canvasElement.width, 0);
                canvasCtx.drawImage(
                    results.image, 0, 0, canvasElement.width, canvasElement.height
                );
                
                if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                    const landmarks = results.multiFaceLandmarks[0];
                    empathicAgent.faceDetected = true;
                    empathicAgent.landmarksDetected = landmarks.length;
                    
                    drawEnhancedMediaPipeLandmarks(landmarks);
                    analyzeEnhancedEmotionFromLandmarks(landmarks);
                    updateFaceDetectionStatus();
                    
                } else {
                    empathicAgent.faceDetected = false;
                    empathicAgent.landmarksDetected = 0;
                }
                
                canvasCtx.restore();
            });
            
            console.log(" Google MediaPipe initialized successfully!");
        }

        function drawEnhancedMediaPipeLandmarks(landmarks) {
            const KEY_LANDMARKS = {
                LEFT_BROW_INNER: 70,
                LEFT_BROW_MIDDLE: 63,
                LEFT_BROW_OUTER: 105,
                RIGHT_BROW_INNER: 336,
                RIGHT_BROW_MIDDLE: 296,
                RIGHT_BROW_OUTER: 334,
                
                LEFT_EYE_TOP: 159,
                LEFT_EYE_BOTTOM: 145,
                RIGHT_EYE_TOP: 386,
                RIGHT_EYE_BOTTOM: 374,
                
                MOUTH_LEFT_CORNER: 61,
                MOUTH_RIGHT_CORNER: 291,
                MOUTH_TOP_UPPER: 0,
                MOUTH_BOTTOM_LOWER: 17,
                
                NOSE_TIP: 1
            };
            
            // Draw eyes
            canvasCtx.fillStyle = '#8ac6d1';
            canvasCtx.strokeStyle = '#FFFFFF';
            canvasCtx.lineWidth = 2;
            
            drawLandmarkCircle(landmarks[KEY_LANDMARKS.LEFT_EYE_TOP], 3);
            drawLandmarkCircle(landmarks[KEY_LANDMARKS.LEFT_EYE_BOTTOM], 3);
            drawLandmarkCircle(landmarks[KEY_LANDMARKS.RIGHT_EYE_TOP], 3);
            drawLandmarkCircle(landmarks[KEY_LANDMARKS.RIGHT_EYE_BOTTOM], 3);
            
            // Draw eyebrows
            const browColor = empathicAgent.currentEmotion === 'frustrated' ? '#ff6b8b' : 
                            empathicAgent.currentEmotion === 'surprised' ? '#ffd166' : '#ffd166';
            canvasCtx.fillStyle = browColor;
            drawLandmarkCircle(landmarks[KEY_LANDMARKS.LEFT_BROW_MIDDLE], 4);
            drawLandmarkCircle(landmarks[KEY_LANDMARKS.RIGHT_BROW_MIDDLE], 4);
            
            // Draw mouth
            let mouthColor;
            switch(empathicAgent.currentEmotion) {
                case 'happy': mouthColor = '#95e1d3'; break;
                case 'sad': mouthColor = '#8ac6d1'; break;
                case 'frustrated': mouthColor = '#ff6b8b'; break;
                case 'surprised': mouthColor = '#ffd166'; break;
                default: mouthColor = '#ff6b8b';
            }
            canvasCtx.fillStyle = mouthColor;
            drawLandmarkCircle(landmarks[KEY_LANDMARKS.MOUTH_LEFT_CORNER], 5);
            drawLandmarkCircle(landmarks[KEY_LANDMARKS.MOUTH_RIGHT_CORNER], 5);
            
            // Draw nose
            canvasCtx.fillStyle = '#ffb8c6';
            drawLandmarkCircle(landmarks[KEY_LANDMARKS.NOSE_TIP], 5);
            
            drawEmotionDebug(canvasCtx, landmarks);
        }
        
        function drawLandmarkCircle(landmark, radius) {
            if (!landmark) return;
            
            const x = landmark.x * canvasElement.width;
            const y = landmark.y * canvasElement.height;
            
            canvasCtx.beginPath();
            canvasCtx.arc(x, y, radius, 0, 2 * Math.PI);
            canvasCtx.fill();
            canvasCtx.stroke();
        }
        
        function drawEmotionDebug(ctx, landmarks) {
            if (!empathicAgent.faceDetected) return;
            
            ctx.font = '14px Arial';
            ctx.fillStyle = '#FFFFFF';
            ctx.strokeStyle = '#2a2d43';
            ctx.lineWidth = 2;
            
            const text = `${empathicAgent.currentEmotion} (${Math.round(empathicAgent.emotionConfidence * 100)}%)`;
            const x = 10;
            const y = 30;
            
            ctx.fillStyle = 'rgba(42, 45, 67, 0.7)';
            ctx.fillRect(x - 5, y - 20, ctx.measureText(text).width + 10, 25);
            
            ctx.fillStyle = '#FFFFFF';
            ctx.fillText(text, x, y);
        }

        function analyzeEnhancedEmotionFromLandmarks(landmarks) {
            if (!landmarks || landmarks.length < 468) return;
            
            const LANDMARK_INDICES = {
                LEFT_BROW_INNER: 70,
                LEFT_BROW_MIDDLE: 63,
                LEFT_BROW_OUTER: 105,
                RIGHT_BROW_INNER: 336,
                RIGHT_BROW_MIDDLE: 296,
                RIGHT_BROW_OUTER: 334,
                
                LEFT_EYE_TOP: 159,
                LEFT_EYE_BOTTOM: 145,
                LEFT_EYE_LEFT: 33,
                LEFT_EYE_RIGHT: 133,
                RIGHT_EYE_TOP: 386,
                RIGHT_EYE_BOTTOM: 374,
                RIGHT_EYE_LEFT: 362,
                RIGHT_EYE_RIGHT: 263,
                
                MOUTH_LEFT_CORNER: 61,
                MOUTH_RIGHT_CORNER: 291,
                MOUTH_TOP_UPPER: 0,
                MOUTH_TOP_LOWER: 13,
                MOUTH_BOTTOM_UPPER: 14,
                MOUTH_BOTTOM_LOWER: 17,
                MOUTH_CENTER_TOP: 13,
                MOUTH_CENTER_BOTTOM: 14,
                
                NOSE_TIP: 1,
                NOSE_BRIDGE: 6,
                NOSE_BOTTOM: 2,
                
                CHIN: 152,
                FOREHEAD: 10,
            };
            
            const get = (index) => landmarks[index];
            
            const mouthLeft = get(LANDMARK_INDICES.MOUTH_LEFT_CORNER);
            const mouthRight = get(LANDMARK_INDICES.MOUTH_RIGHT_CORNER);
            const mouthTop = get(LANDMARK_INDICES.MOUTH_TOP_UPPER);
            const mouthBottom = get(LANDMARK_INDICES.MOUTH_BOTTOM_LOWER);
            const mouthCenterTop = get(LANDMARK_INDICES.MOUTH_CENTER_TOP);
            const mouthCenterBottom = get(LANDMARK_INDICES.MOUTH_CENTER_BOTTOM);
            
            const mouthWidth = Math.abs(mouthRight.x - mouthLeft.x);
            const mouthHeight = Math.abs(mouthBottom.y - mouthTop.y);
            const mouthOpenness = Math.abs(mouthCenterBottom.y - mouthCenterTop.y);
            const mouthRatio = mouthHeight / (mouthWidth + 0.001);
            
            const mouthCornersAvgY = (mouthLeft.y + mouthRight.y) / 2;
            const mouthCenterY = (mouthTop.y + mouthBottom.y) / 2;
            const mouthCurvature = mouthCornersAvgY - mouthCenterY;
            
            const leftBrowMiddle = get(LANDMARK_INDICES.LEFT_BROW_MIDDLE);
            const rightBrowMiddle = get(LANDMARK_INDICES.RIGHT_BROW_MIDDLE);
            const leftBrowInner = get(LANDMARK_INDICES.LEFT_BROW_INNER);
            const rightBrowInner = get(LANDMARK_INDICES.RIGHT_BROW_INNER);
            const leftBrowOuter = get(LANDMARK_INDICES.LEFT_BROW_OUTER);
            const rightBrowOuter = get(LANDMARK_INDICES.RIGHT_BROW_OUTER);
            
            const browHeight = (leftBrowMiddle.y + rightBrowMiddle.y) / 2;
            const browTiltLeft = leftBrowOuter.y - leftBrowInner.y;
            const browTiltRight = rightBrowOuter.y - rightBrowInner.y;
            const browAsymmetry = Math.abs(leftBrowMiddle.y - rightBrowMiddle.y);
            
            const leftEyeOpen = Math.abs(
                get(LANDMARK_INDICES.LEFT_EYE_BOTTOM).y - 
                get(LANDMARK_INDICES.LEFT_EYE_TOP).y
            );
            const rightEyeOpen = Math.abs(
                get(LANDMARK_INDICES.RIGHT_EYE_BOTTOM).y - 
                get(LANDMARK_INDICES.RIGHT_EYE_TOP).y
            );
            const eyeOpenness = (leftEyeOpen + rightEyeOpen) / 2;
            
            const noseTip = get(LANDMARK_INDICES.NOSE_TIP);
            const noseToMouth = mouthTop ? Math.abs(mouthTop.y - noseTip.y) : 0;
            
            const chin = get(LANDMARK_INDICES.CHIN);
            const forehead = get(LANDMARK_INDICES.FOREHEAD);
            const headTilt = forehead ? Math.atan2(
                chin.y - forehead.y,
                chin.x - forehead.x
            ) : 0;
            
            const emotionScores = {
                happy: 0,
                sad: 0,
                surprised: 0,
                frustrated: 0,
                focused: 0,
                confused: 0,
                bored: 0,
                neutral: 0.5
            };
            
            // HAPPY
            if (mouthCurvature > 0.04) emotionScores.happy += 0.4;
            if (mouthRatio < 0.31) emotionScores.happy += 0.3;
            if (eyeOpenness > 0.025) emotionScores.happy += 0.2;
            if (browHeight < 0.45) emotionScores.happy += 0.1;
            
            // SAD
            if (mouthCurvature < -0.015) emotionScores.sad += 0.4;
            if (browTiltLeft > 0.02 && browTiltRight > 0.02) emotionScores.sad += 0.3;
            if (eyeOpenness < 0.02) emotionScores.sad += 0.2;
            if (headTilt > 0.1) emotionScores.sad += 0.1;
            
            // SURPRISED
            if (eyeOpenness > 0.035) emotionScores.surprised += 0.3;
            if (browHeight < 0.3) emotionScores.surprised += 0.3;
            if (mouthOpenness > 0.04) emotionScores.surprised += 0.2;
            if (mouthRatio > 0.3) emotionScores.surprised += 0.2;
            
            // FRUSTRATED
            if (browHeight > 0.4 && browTiltLeft > 0 && browTiltRight > 0) emotionScores.frustrated += 0.4;
            if (eyeOpenness < 0.02) emotionScores.frustrated += 0.3;
            if (mouthRatio > 0.35 && mouthCurvature < 0) emotionScores.frustrated += 0.3;
            
            // FOCUSED
            if (Math.abs(mouthCurvature) < 0.01) emotionScores.focused += 0.3;
            if (Math.abs(headTilt) > 0.05) emotionScores.focused += 0.2;
            
            // CONFUSED
            if (browAsymmetry > 0.03) emotionScores.confused += 0.4;
            if (Math.abs(headTilt) > 0.08) emotionScores.confused += 0.3;
            
            // BORED
            if (eyeOpenness < 0.018) emotionScores.bored += 0.4;
            if (browHeight > 0.38) emotionScores.bored += 0.3;
            if (Math.abs(mouthCurvature) < 0.005 && mouthRatio < 0.25) emotionScores.bored += 0.3;
            
            // Find highest scoring emotion
            let maxScore = 0;
            let detectedEmotion = "neutral";
            let confidence = 0.5;
            
            for (const [emote, score] of Object.entries(emotionScores)) {
                if (score > maxScore) {
                    maxScore = score;
                    detectedEmotion = emote;
                    confidence = Math.min(0.95, score);
                }
            }
            
            if (maxScore < 0.6) {
                detectedEmotion = "neutral";
                confidence = 0.5;
            }
            
            updateEmotionWithSmoothing(detectedEmotion, confidence, {
                mouthCurvature,
                eyeOpenness,
                browHeight,
                headTilt
            });
        }
        
        function updateEmotionWithSmoothing(newEmotion, confidence, features) {
            const now = Date.now();
            
            emotionHistory.push({
                emotion: newEmotion,
                confidence: confidence,
                timestamp: now,
                features: features
            });
            
            while (emotionHistory.length > MAX_HISTORY) {
                emotionHistory.shift();
            }
            
            if (emotionHistory.length >= 3) {
                const recentEmotions = emotionHistory.slice(-5);
                const emotionCounts = {};
                let totalWeight = 0;
                
                recentEmotions.forEach((entry, index) => {
                    const weight = 0.7 * (index / recentEmotions.length);
                    emotionCounts[entry.emotion] = (emotionCounts[entry.emotion] || 0) + weight;
                    totalWeight += weight;
                });
                
                let smoothedEmotion = newEmotion;
                let maxCount = 0;
                for (const [emote, count] of Object.entries(emotionCounts)) {
                    if (count > maxCount) {
                        maxCount = count;
                        smoothedEmotion = emote;
                    }
                }
                
                if (maxCount > totalWeight * 0.6 && smoothedEmotion !== newEmotion) {
                    newEmotion = smoothedEmotion;
                }
            }
            
            if (empathicAgent.currentEmotion !== newEmotion) {
                empathicAgent.previousEmotion = empathicAgent.currentEmotion;
                empathicAgent.currentEmotion = newEmotion;
                empathicAgent.emotionConfidence = confidence;
                
                if (["frustrated", "sad", "bored", "confused"].includes(newEmotion)) {
                    empathicAgent.consecutiveNegativeFrames++;
                } else {
                    empathicAgent.consecutiveNegativeFrames = Math.max(0, empathicAgent.consecutiveNegativeFrames - 1);
                }
                
                if (newEmotion === "focused") {
                    empathicAgent.focusLevel = Math.min(100, empathicAgent.focusLevel + 2);
                } else if (newEmotion === "happy") {
                    empathicAgent.focusLevel = Math.min(100, empathicAgent.focusLevel + 1);
                }
            }
        }

        // ============================================
        // BACKGROUND CAMERA MANAGEMENT
        // ============================================

        function initCameraStatusIndicator() {
            updateCameraStatusDisplay();
        }

        function updateCameraStatusDisplay() {
            const cameraStatusBadge = document.getElementById('camera-status-badge');
            const cameraStatusIndicator = document.getElementById('camera-status-indicator');
            const cameraBubble = document.getElementById('side-camera');
            
            if (isCameraStarted) {
                if (cameraStatusIndicator) {
                    cameraStatusIndicator.style.display = 'block';
                }
                
                if (cameraStatusBadge) {
                    cameraStatusBadge.textContent = 'ACTIVE';
                    cameraStatusBadge.style.background = '#95e1d3';
                }
                
                if (cameraBubble) {
                    cameraBubble.innerHTML = '<i class="fas fa-camera" style="color: #95e1d3;"></i>';
                    cameraBubble.style.animation = 'pulse 2s infinite';
                    cameraBubble.title = 'Camera active (click to view)';
                }
                
            } else {
                if (cameraStatusIndicator) {
                    cameraStatusIndicator.style.display = 'none';
                }
                
                if (cameraStatusBadge) {
                    cameraStatusBadge.textContent = 'INACTIVE';
                    cameraStatusBadge.style.background = '#ff6b8b';
                }
                
                if (cameraBubble) {
                    cameraBubble.innerHTML = '<i class="fas fa-camera"></i>';
                    cameraBubble.style.animation = 'none';
                    cameraBubble.title = 'Camera Controls';
                }
            }
            
            updateSettingsDisplay();
        }

        function closeCameraContent() {
            const cameraContent = document.getElementById('camera-content');
            if (cameraContent) {
                cameraContent.classList.remove('active');
            }
        }

        function stopCameraDetection() {
            if (isCameraStarted && videoElement.srcObject) {
                videoElement.srcObject.getTracks().forEach(track => track.stop());
                videoElement.srcObject = null;
                
                isDetectionActive = false;
                isCameraStarted = false;
                empathicAgent.isCameraActive = false;
                
                const canvasCtx = canvasElement.getContext('2d');
                canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
                
                document.getElementById('btn-text').textContent = "START ENHANCED MEDIAPIPE";
                document.getElementById('btn-icon').className = "fas fa-play-circle";
                
                document.getElementById('status-text').innerHTML = 
                    `<span style="color: var(--mickey-blue);">Click START to begin ENHANCED 468-point face landmark detection!</span>`;
                
                updateCameraStatusDisplay();
                
                console.log(" Camera detection stopped (game ended)");
            }
        }

        async function startRealMediaPipeDetection() {
            try {
                console.log(" Starting camera for ENHANCED Google MediaPipe detection...");
                
                if (isCameraStarted && videoElement.srcObject) {
                    videoElement.srcObject.getTracks().forEach(track => track.stop());
                }
                
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user'
                    },
                    audio: false
                });
                
                videoElement.srcObject = stream;
                
                await new Promise((resolve) => {
                    videoElement.onloadedmetadata = () => {
                        videoElement.play().then(resolve);
                    };
                });
                
                canvasElement.width = videoElement.videoWidth;
                canvasElement.height = videoElement.videoHeight;
                
                isDetectionActive = true;
                isCameraStarted = true;
                empathicAgent.isCameraActive = true;
                
                updateCameraStatusDisplay();
                
                document.getElementById('btn-text').textContent = "MEDIAPIPE ACTIVE";
                document.getElementById('btn-icon').className = "fas fa-check-circle";
                
                detectionLoop();
                
                document.getElementById('status-text').innerHTML = 
                    `<span style="color: var(--mickey-red);">
                         <strong>ENHANCED MEDIAPIPE ACTIVE!</strong><br>
                        Advanced 468-point face landmark detection!<br>
                        <small style="color: var(--mickey-blue);">(Detection continues even when panel is closed)</small>
                    </span>`;
                
                console.log(" ENHANCED MediaPipe detection started successfully!");
                
            } catch (error) {
                console.error(" Camera access error:", error);
                
                document.getElementById('status-text').innerHTML = 
                    `<span style="color: var(--mickey-red);">
                         Camera permission denied.<br>
                        Using simulated detection for demonstration.
                    </span>`;
                
                startSimulatedDetection();
            }
        }

        async function detectionLoop() {
            if (!isDetectionActive || !isCameraStarted) return;
            
            try {
                await faceMesh.send({ image: videoElement });
                requestAnimationFrame(detectionLoop);
            } catch (error) {
                console.error("Detection loop error:", error);
                requestAnimationFrame(detectionLoop);
            }
        }

        function updateFaceDetectionStatus() {
            const statusElement = document.getElementById('status-text');
            
            if (empathicAgent.faceDetected && empathicAgent.landmarksDetected > 0) {
                statusElement.innerHTML = `
                    <span style="color: var(--mickey-red);">
                         <strong>ENHANCED FACE DETECTED!</strong><br>
                         ${empathicAgent.landmarksDetected} MediaPipe landmarks<br>
                         ${empathicAgent.currentEmotion.toUpperCase()} (${Math.round(empathicAgent.emotionConfidence * 100)}% confidence)<br>
                         Focus Level: ${empathicAgent.focusLevel}%
                    </span>
                `;
            }
        }
        
        function startSimulatedDetection() {
            console.log(" Using simulated detection (fallback)");
            
            const container = document.querySelector('.face-detection-container');
            if (container) {
                container.innerHTML = `
                    <div style="width: 100%; height: 100%; background: linear-gradient(145deg, #ffcc99, #ff9966); 
                                display: flex; align-items: center; justify-content: center; position: relative;">
                        <div style="text-align: center; padding: 20px; color: var(--mickey-black);">
                            <div style="font-size: 4rem; margin-bottom: 10px;">
                                <i class="fas fa-smile-beam"></i>
                            </div>
                            <div style="font-weight: bold; color: var(--mickey-red);">
                                Simulated Emotion Detection
                            </div>
                            <div style="margin-top: 10px; font-size: 0.9rem;">
                                (MediaPipe unavailable - using simulation)
                            </div>
                        </div>
                    </div>
                `;
            }
            
            setInterval(() => {
                if (isDetectionActive) {
                    empathicAgent.landmarksDetected = 468;
                    empathicAgent.faceDetected = true;
                    
                    const emotions = ['happy', 'neutral', 'focused', 'confused', 'frustrated'];
                    const randomEmotion = emotions[Math.floor(Math.random() * emotions.length)];
                    empathicAgent.currentEmotion = randomEmotion;
                    empathicAgent.emotionConfidence = 0.7 + Math.random() * 0.3;
                    empathicAgent.focusLevel = 60 + Math.random() * 30;
                    
                    updateFaceDetectionStatus();
                }
            }, 3000);
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        
        function showNotification(title, message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 100px;
                right: 30px;
                background: var(--mickey-white);
                color: var(--mickey-black);
                padding: 15px 20px;
                border-radius: 15px;
                border: 3px solid var(--mickey-black);
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                z-index: 10000;
                font-family: 'Comic Neue', cursive;
                max-width: 300px;
                animation: slideInRight 0.3s ease;
            `;
            
            notification.innerHTML = `
                <strong style="color: var(--mickey-red); display: block; margin-bottom: 5px;">${title}</strong>
                <div>${message}</div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 5000);
        }
        
        // ============================================
        // INITIALIZE ON LOAD
        // ============================================
        
        window.addEventListener('load', function() {
            initializeAll();
        });

        // Make functions available globally
        window.startGame = startGame;
        window.viewModule = viewModule;
        window.checkAnswer = checkAnswer;
        window.nextActivity = nextActivity;
        window.previousActivity = previousActivity;
        window.closeModule = closeModule;
        window.startMickeyBreak = startMickeyBreak;
        window.endMickeyBreak = endMickeyBreak;
        window.makeGameEasier = makeGameEasier;
        window.skipToNext = skipToNext;
        window.explainDifferently = explainDifferently;
        window.toggleDyslexiaMode = toggleDyslexiaMode;
        window.toggleEnhancedGuides = toggleEnhancedGuides;
        window.readQuestionAloud = readQuestionAloud; // Add this
        window.prevTracingActivity = prevTracingActivity;
        window.nextTracingActivity = nextTracingActivity;
        window.speakBotGreeting = speakBotGreeting; // Add this for testing
    </script>
</body>
</html>