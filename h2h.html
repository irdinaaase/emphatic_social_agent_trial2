<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learning Hub - Mickey Mouse Interactive Learning</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Font for Disney feel -->
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@700&family=Fredoka+One&display=swap" rel="stylesheet">
    
    <!-- OpenDyslexic Font for accessibility -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@open-dyslexic/open-dyslexic@1.0.3/css/open-dyslexic.css">
    
    <!-- MediaPipe Face Detection -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
    
    <style>
        /* MICKEY MOUSE THEME - DISNEY STYLE */
        :root {
            --mickey-red: #e60000;
            --mickey-yellow: #ffcc00;
            --mickey-black: #000000;
            --mickey-white: #ffffff;
            --mickey-blue: #0066cc;
            --mickey-bg: #ffcccc;
            --mickey-skin: #ffcc99;
        }
        
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Fredoka One', cursive;
            background: linear-gradient(135deg, #ffe6e6 0%, #ffcccc 100%);
            min-height: 100vh;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(255, 255, 255, 0.8) 2px, transparent 2px),
                radial-gradient(circle at 90% 80%, rgba(255, 255, 255, 0.8) 2px, transparent 2px);
            background-size: 40px 40px;
            padding-top: 120px; /* Added padding for fixed header */
        }
        
        /* FIXED HEADER */
        .fixed-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(145deg, var(--mickey-red), #cc0000);
            border-bottom: 5px solid var(--mickey-black);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 9999;
            padding: 15px 20px;
        }
        
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header-logo {
            display: flex;
            align-items: center;
            gap: 15px;
            color: var(--mickey-white);
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .logo-icon {
            width: 50px;
            height: 50px;
            background: var(--mickey-yellow);
            border-radius: 50%;
            border: 3px solid var(--mickey-black);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--mickey-red);
        }
        
        .header-nav {
            display: flex;
            gap: 10px;
        }
        
        .nav-tab {
            padding: 12px 20px;
            background: var(--mickey-yellow);
            color: var(--mickey-black);
            border: 3px solid var(--mickey-black);
            border-radius: 15px;
            font-family: 'Fredoka One', cursive;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }
        
        .nav-tab:hover {
            background: var(--mickey-white);
            transform: translateY(-3px);
            box-shadow: 0 5px 0 var(--mickey-black);
        }
        
        .nav-tab.active {
            background: var(--mickey-blue);
            color: var(--mickey-white);
        }
        
        /* CONTENT AREAS */
        .content-area {
            display: none;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .content-area.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* PROFILE CONTENT */
        .profile-content {
            padding: 30px;
            background: var(--mickey-white);
            border-radius: 25px;
            border: 5px solid var(--mickey-black);
            box-shadow: 0 10px 0 var(--mickey-black);
            margin-top: 20px;
        }
        
        /* SETTINGS CONTENT */
        .settings-content {
            padding: 30px;
            background: var(--mickey-white);
            border-radius: 25px;
            border: 5px solid var(--mickey-black);
            box-shadow: 0 10px 0 var(--mickey-black);
            margin-top: 20px;
        }
        
        /* ABOUT CONTENT */
        .about-content {
            padding: 30px;
            background: var(--mickey-white);
            border-radius: 25px;
            border: 5px solid var(--mickey-black);
            box-shadow: 0 10px 0 var(--mickey-black);
            margin-top: 20px;
        }
        
        /* LEARNING HUB CONTENT */
        .learning-hub {
            display: block;
            animation: slideIn 0.5s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Dyslexia-friendly mode */
        body.dyslexia-mode {
            font-family: 'OpenDyslexic', 'Comic Sans MS', sans-serif !important;
            letter-spacing: 0.1em;
            line-height: 1.8;
            background: linear-gradient(135deg, #ffffcc 0%, #fff5cc 100%) !important;
        }
        
        /* DYSLEXIA-SPECIFIC STYLES FOR MODULES */
        .dyslexia-option {
            padding: 8px 12px;
            background: var(--mickey-blue);
            color: white;
            border: 2px solid var(--mickey-black);
            border-radius: 8px;
            font-family: 'OpenDyslexic', sans-serif;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
        }

        .dyslexia-option:hover {
            background: var(--mickey-red);
            transform: scale(1.05);
        }

        .dyslexia-option.active {
            background: #00cc00;
            box-shadow: 0 0 8px #00cc00;
        }

        /* Dyslexia-friendly text styles */
        .dyslexia-text {
            font-family: 'OpenDyslexic', 'Comic Sans MS', sans-serif !important;
            letter-spacing: 0.15em;
            line-height: 2;
            word-spacing: 0.2em;
            font-size: 1.1em;
        }

        /* Color overlays for reading */
        .color-overlay-yellow {
            background: linear-gradient(rgba(255, 255, 200, 0.3), rgba(255, 255, 200, 0.3)) !important;
        }

        .color-overlay-blue {
            background: linear-gradient(rgba(200, 220, 255, 0.3), rgba(200, 220, 255, 0.3)) !important;
        }

        .color-overlay-green {
            background: linear-gradient(rgba(220, 255, 220, 0.3), rgba(220, 255, 220, 0.3)) !important;
        }

        /* Line reader tool */
        .line-reader {
            position: relative;
        }

        .line-reader::after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            height: 24px;
            background: rgba(255, 255, 0, 0.2);
            border-top: 2px solid #ffcc00;
            border-bottom: 2px solid #ffcc00;
            pointer-events: none;
            z-index: 1;
        }

        /* Simplified text mode */
        .simplified-text {
            font-size: 1.2em;
            line-height: 1.8;
            color: #000000;
            background: #ffffff;
            padding: 15px;
            border-radius: 10px;
            border: 3px solid #0066cc;
        }

        .simplified-text p {
            margin-bottom: 15px;
        }

        /* Text-to-speech highlight */
        .tts-highlight {
            background: #ffff00 !important;
            color: #000000 !important;
            padding: 2px 5px;
            border-radius: 3px;
            animation: pulse-tts 1s infinite;
        }

        @keyframes pulse-tts {
            0% { background-color: #ffff00; }
            50% { background-color: #ffcc00; }
            100% { background-color: #ffff00; }
        }

        .dyslexia-friendly .game-option {
            font-family: 'OpenDyslexic', sans-serif;
            font-size: 1.1em;
            line-height: 1.6;
            padding: 20px 15px;
            text-align: left;
            border-left: 5px solid var(--mickey-blue);
        }

        .dyslexia-friendly .game-question {
            font-family: 'OpenDyslexic', sans-serif;
            line-height: 1.8;
            margin-bottom: 25px;
            background: #f0f8ff;
            padding: 20px;
            border-radius: 15px;
            border: 3px solid var(--mickey-yellow);
        }

        .dyslexia-feedback {
            font-family: 'OpenDyslexic', sans-serif !important;
            line-height: 1.8 !important;
            letter-spacing: 0.1em !important;
            padding: 20px !important;
            border-left: 5px solid var(--mickey-blue) !important;
            background: linear-gradient(to right, #f0f8ff, #ffffff) !important;
        }

        .dyslexia-feedback-success {
            border-left-color: #00cc00 !important;
            background: linear-gradient(to right, #f0fff0, #ffffff) !important;
        }

        .dyslexia-feedback-help {
            border-left-color: var(--mickey-yellow) !important;
            background: linear-gradient(to right, #fff9e6, #ffffff) !important;
        }

        /* Visual Learning Aids */
        .visual-aid {
            font-size: 2.5rem;
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            border: 3px solid var(--mickey-yellow);
            animation: pulse-soft 2s infinite;
        }

        @keyframes pulse-soft {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* Step-by-Step Guides */
        .step-guide {
            counter-reset: step-counter;
            margin: 20px 0;
        }

        .step-item {
            position: relative;
            padding-left: 50px;
            margin-bottom: 15px;
            min-height: 40px;
        }

        .step-item:before {
            counter-increment: step-counter;
            content: counter(step-counter);
            position: absolute;
            left: 0;
            top: 0;
            width: 40px;
            height: 40px;
            background: var(--mickey-blue);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'OpenDyslexic', sans-serif;
            font-weight: bold;
            border: 3px solid var(--mickey-black);
        }

        /* Color-Coded Sections */
        .color-coded-math {
            border-color: var(--mickey-red) !important;
            background: linear-gradient(145deg, #ffe6e6, #ffcccc) !important;
        }

        .color-coded-reading {
            border-color: var(--mickey-blue) !important;
            background: linear-gradient(145deg, #e6f7ff, #cceeff) !important;
        }

        .color-coded-science {
            border-color: #00cc00 !important;
            background: linear-gradient(145deg, #e6ffe6, #ccffcc) !important;
        }

        /* Interactive Elements */
        .interactive-highlight {
            animation: highlight-pulse 1.5s infinite;
            cursor: pointer;
            transition: all 0.3s;
        }

        @keyframes highlight-pulse {
            0% { background-color: #ffffcc; }
            50% { background-color: #ffcc00; }
            100% { background-color: #ffffcc; }
        }

        .interactive-highlight:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        /* Audio Feedback Indicator */
        .audio-playing {
            position: relative;
            animation: audio-wave 1s infinite;
        }

        @keyframes audio-wave {
            0% { box-shadow: 0 0 0 0 rgba(0, 102, 204, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(0, 102, 204, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 102, 204, 0); }
        }

        /* MICKEY MOUSE HEADER IN LEARNING HUB */
        .mickey-header {
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
            position: relative;
        }
        
        .mickey-ears {
            position: relative;
        }
        
        .ear {
            position: absolute;
            width: 80px;
            height: 80px;
            background: var(--mickey-black);
            border-radius: 50%;
            border: 4px solid var(--mickey-red);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .ear-left {
            left: 20px;
        }
        
        .ear-right {
            right: 20px;
        }
        
        .ear-inner {
            position: absolute;
            width: 30px;
            height: 30px;
            background: var(--mickey-white);
            border-radius: 50%;
            top: 25px;
            left: 25px;
        }
        
        h1 {
            color: var(--mickey-red);
            font-size: 3rem;
            margin: 0 20px;
            text-align: center;
            text-shadow: 
                3px 3px 0 var(--mickey-black),
                6px 6px 0 rgba(230, 0, 0, 0.2);
            letter-spacing: 2px;
            background: linear-gradient(45deg, var(--mickey-red), #ff3333);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            position: relative;
            z-index: 2;
        }
        
        .subtitle {
            color: var(--mickey-blue);
            font-size: 1.4rem;
            margin-bottom: 40px;
            text-align: center;
            font-family: 'Comic Neue', cursive;
            font-weight: 700;
            text-shadow: 2px 2px 0 var(--mickey-white);
            background: var(--mickey-yellow);
            padding: 15px;
            border-radius: 50px;
            border: 4px dashed var(--mickey-red);
            max-width: 800px;
            margin: 20px auto 40px;
            box-shadow: 0 8px 0 var(--mickey-black);
        }
        
        /* EMPATHIC AGENT CHAT BOT */
        .empathic-agent {
            position: fixed;
            bottom: 30px;
            left: 30px;
            width: 350px;
            background: var(--mickey-white);
            border-radius: 25px;
            border: 5px solid var(--mickey-black);
            box-shadow: 
                0 10px 0 var(--mickey-black),
                0 15px 30px rgba(0,0,0,0.3);
            z-index: 9998;
            overflow: hidden;
            display: none;
        }
        
        .agent-header {
            background: linear-gradient(145deg, var(--mickey-red), #cc0000);
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            color: var(--mickey-white);
        }
        
        .agent-avatar {
            width: 60px;
            height: 60px;
            background: var(--mickey-yellow);
            border-radius: 50%;
            border: 4px solid var(--mickey-white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: var(--mickey-red);
        }
        
        .agent-messages {
            height: 200px;
            overflow-y: auto;
            padding: 20px;
            background: linear-gradient(145deg, #fff9e6, #fff0cc);
        }
        
        .agent-message {
            margin-bottom: 15px;
            padding: 12px 18px;
            border-radius: 18px;
            max-width: 85%;
            position: relative;
            animation: messageSlide 0.3s ease;
        }
        
        .agent-message.bot {
            background: var(--mickey-blue);
            color: var(--mickey-white);
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }
        
        .agent-message.user {
            background: var(--mickey-yellow);
            color: var(--mickey-black);
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }
        
        .agent-input {
            display: flex;
            padding: 15px;
            border-top: 3px solid var(--mickey-yellow);
            background: var(--mickey-white);
        }
        
        .agent-input input {
            flex: 1;
            padding: 12px 15px;
            border: 3px solid var(--mickey-black);
            border-radius: 15px;
            font-family: 'Comic Neue', cursive;
            font-size: 1rem;
        }
        
        .agent-input button {
            background: var(--mickey-red);
            color: var(--mickey-white);
            border: none;
            width: 50px;
            border-radius: 15px;
            margin-left: 10px;
            cursor: pointer;
            border: 3px solid var(--mickey-black);
        }
        
        .agent-minimize {
            position: absolute;
            top: 15px;
            right: 15px;
            background: transparent;
            border: none;
            color: var(--mickey-white);
            cursor: pointer;
            font-size: 1.2rem;
        }
        
        /* PROACTIVE INTERVENTION MODAL */
        .intervention-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 500px;
            background: var(--mickey-white);
            border-radius: 25px;
            border: 5px solid var(--mickey-black);
            box-shadow: 
                0 15px 0 var(--mickey-black),
                0 25px 50px rgba(0,0,0,0.4);
            z-index: 10000;
            display: none;
            overflow: hidden;
        }
        
        .intervention-header {
            background: linear-gradient(145deg, var(--mickey-red), #cc0000);
            padding: 25px;
            text-align: center;
            color: var(--mickey-white);
        }
        
        .intervention-body {
            padding: 30px;
            text-align: center;
        }
        
        .intervention-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 25px;
        }
        
        .intervention-btn {
            padding: 18px;
            background: var(--mickey-yellow);
            color: var(--mickey-black);
            border: 3px solid var(--mickey-black);
            border-radius: 15px;
            font-family: 'Fredoka One', cursive;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .intervention-btn:hover {
            background: var(--mickey-blue);
            color: var(--mickey-white);
            transform: translateY(-3px);
        }
        
        .intervention-btn.easy {
            background: #00cc00;
            color: white;
            border-color: #009900;
        }
        
        .intervention-btn.break {
            background: var(--mickey-yellow);
            color: var(--mickey-black);
        }
        
        .intervention-btn.next {
            background: var(--mickey-blue);
            color: white;
            border-color: #0055aa;
        }
        
        /* REAL FACE LANDMARKS VISUALIZATION */
        .face-detection-container {
            width: 100%;
            height: 200px;
            border: 4px solid var(--mickey-black);
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 15px;
            background: var(--mickey-white);
            position: relative;
        }
        
        #face-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }
        
        #face-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        /* KEY LANDMARK INDICATORS */
        .landmark-info {
            position: absolute;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
        }
        
        /* MOVABLE ACCESSIBILITY TOOLBAR */
        .accessibility-toolbar {
            position: fixed;
            top: 120px;
            right: 30px;
            background: var(--mickey-white);
            padding: 15px;
            border-radius: 20px;
            border: 4px solid var(--mickey-black);
            box-shadow: 0 6px 0 var(--mickey-black);
            z-index: 9997;
            display: flex; 
            gap: 10px;
            cursor: move;
            user-select: none;
            touch-action: none;
        }
        
        .accessibility-toolbar:hover {
            box-shadow: 0 6px 0 var(--mickey-black), 0 0 15px rgba(230, 0, 0, 0.3);
        }
        
        .accessibility-btn {
            background: var(--mickey-blue);
            color: var(--mickey-white);
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid var(--mickey-black);
            transition: all 0.3s;
        }
        
        .accessibility-btn:hover {
            transform: scale(1.1);
        }
        
        .accessibility-btn.active {
            background: var(--mickey-red);
            box-shadow: 0 0 15px var(--mickey-yellow);
        }
        
        /* Accessibility Tool Buttons in Collapsible */
        .accessibility-tool-btn {
            background: var(--mickey-blue);
            color: var(--mickey-white);
            border: 2px solid var(--mickey-black);
            border-radius: 10px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Comic Neue', cursive;
            font-size: 12px;
            gap: 5px;
            min-height: 70px;
        }

        .accessibility-tool-btn:hover {
            background: var(--mickey-red);
            transform: scale(1.05);
        }

        .accessibility-tool-btn.active {
            background: var(--mickey-red);
            box-shadow: 0 0 10px var(--mickey-yellow);
        }

        .accessibility-tool-btn i {
            font-size: 20px;
            margin-bottom: 5px;
        }

        .accessibility-tool-btn span {
            font-size: 11px;
            text-align: center;
            line-height: 1.2;
        }

        /* Hide the movable toolbar by default */
        .accessibility-toolbar {
            display: none !important;
        }

        /* SIDE COLLAPSIBLE FOR AGENT AND CAMERA */
        .side-collapsible {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 9997;
        }
        
        .side-toggle {
            width: 60px;
            height: 60px;
            background: var(--mickey-red);
            border-radius: 50%;
            border: 4px solid var(--mickey-black);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(230, 0, 0, 0.4);
            transition: all 0.3s;
            animation: pulse 2s infinite;
        }
        
        .side-toggle:hover {
            transform: scale(1.1);
        }
        
        .side-toggle i {
            color: var(--mickey-white);
            font-size: 1.5rem;
        }
        
        .side-bubbles {
            position: absolute;
            bottom: 70px;
            right: 0;
            display: none;
            flex-direction: column;
            gap: 15px;
            animation: slideUp 0.3s ease;
        }
        
        .side-bubbles.show {
            display: flex;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .side-bubble {
            width: 60px;
            height: 60px;
            background: var(--mickey-yellow);
            border-radius: 50%;
            border: 4px solid var(--mickey-black);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }
        
        .side-bubble:hover {
            transform: scale(1.1) rotate(10deg);
            background: var(--mickey-white);
        }
        
        .side-bubble i {
            color: var(--mickey-red);
            font-size: 1.5rem;
        }
        
        .side-bubble.agent {
            background: var(--mickey-blue);
        }
        
        .side-bubble.agent i {
            color: var(--mickey-white);
        }
        
        .side-bubble.camera {
            background: var(--mickey-red);
        }
        
        .side-bubble.camera i {
            color: var(--mickey-white);
        }
        
        .side-bubble.accessibility {
            background: var(--mickey-yellow);
        }
        
        .side-bubble.accessibility i {
            color: var(--mickey-black);
        }
        
        /* COLLAPSIBLE CONTROLS (FOR CAMERA CONTENT) */
        .collapsible-controls {
            position: fixed;
            top: 120px;
            right: 30px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 9999;
        }
        
        .collapsible-content {
            display: none;
            position: absolute;
            top: 60px;
            right: 0;
            background: var(--mickey-white);
            border-radius: 20px;
            border: 4px solid var(--mickey-black);
            padding: 20px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            z-index: 9997;
            width: 300px;
        }
        
        .collapsible-content.active {
            display: block;
            animation: slideInRight 0.3s ease;
        }
        
        /* X Button for collapsible content */
        .collapsible-close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            background: var(--mickey-red);
            color: var(--mickey-white);
            border: 3px solid var(--mickey-black);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            z-index: 9998;
            transition: all 0.3s;
        }

        .collapsible-close-btn:hover {
            background: var(--mickey-blue);
            transform: rotate(90deg) scale(1.1);
        }

        /* Camera container position relative for absolute positioning */
        .camera-container {
            width: 300px;
            position: relative;
        }

        /* Status indicator for camera running in background */
        .camera-status-indicator {
            position: fixed;
            bottom: 30px;
            right: 100px;
            width: 20px;
            height: 20px;
            background: #00cc00;
            border-radius: 50%;
            border: 2px solid var(--mickey-black);
            box-shadow: 0 0 10px #00cc00;
            z-index: 9995;
            animation: pulse-green 2s infinite;
            display: none;
        }

        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(0, 204, 0, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(0, 204, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 204, 0, 0); }
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        @keyframes interventionPop {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            70% { transform: translate(-50%, -50%) scale(1.05); }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        
        /* STUDENT PROFILE - COLLAPSIBLE */
        .student-profile {
            overflow-y: auto;
        }
        
        .profile-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .avatar {
            width: 60px;
            height: 60px;
            background: linear-gradient(145deg, var(--mickey-red), var(--mickey-yellow));
            border-radius: 50%;
            border: 4px solid var(--mickey-black);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--mickey-white);
        }
        
        /* CAMERA CONTAINER - COLLAPSIBLE */
        .camera-container {
            width: 300px;
        }
        
        #face-status {
            padding: 15px;
            background: var(--mickey-white);
            color: var(--mickey-black);
            border-radius: 15px;
            font-family: 'Fredoka One', cursive;
            font-size: 14px;
            line-height: 1.5;
            border: 3px solid var(--mickey-black);
        }
        
        /* LEARNING CONTENT GRID - MICKEY STYLE */
        .modules-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 30px;
            margin-top: 40px;
        }
        
        .module-card {
            background: linear-gradient(145deg, var(--mickey-white), #f2f2f2);
            border-radius: 25px;
            padding: 25px;
            box-shadow: 
                0 10px 0 var(--mickey-black),
                0 15px 20px rgba(0,0,0,0.2);
            border: 5px solid var(--mickey-black);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
            min-height: 300px;
            display: flex;
            flex-direction: column;
        }
        
        .module-card:hover {
            transform: translateY(-10px) rotate(1deg);
            box-shadow: 
                0 15px 0 var(--mickey-black),
                0 25px 30px rgba(0,0,0,0.3);
            border-color: var(--mickey-red);
        }
        
        .module-title {
            font-size: 1.6rem;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--mickey-red);
            text-shadow: 2px 2px 0 var(--mickey-yellow);
            font-family: 'Fredoka One', cursive;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .module-title i {
            color: var(--mickey-black);
            background: var(--mickey-yellow);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid var(--mickey-black);
        }
        
        .module-desc {
            color: var(--mickey-blue);
            font-size: 1.1rem;
            line-height: 1.6;
            font-family: 'Comic Neue', cursive;
            padding-left: 10px;
            border-left: 4px solid var(--mickey-yellow);
            flex-grow: 1;
            margin-bottom: 20px;
        }
        
        /* MODULE CONTROLS */
        .module-controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .module-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 20px;
            font-family: 'Fredoka One', cursive;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-grow: 1;
            justify-content: center;
        }
        
        .start-btn {
            background: linear-gradient(145deg, var(--mickey-red), #cc0000);
            color: var(--mickey-white);
            border: 3px solid var(--mickey-black);
        }
        
        .start-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(230, 0, 0, 0.4);
        }
        
        .view-btn {
            background: linear-gradient(145deg, var(--mickey-blue), #0055aa);
            color: var(--mickey-white);
            border: 3px solid var(--mickey-black);
        }
        
        .view-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 102, 204, 0.4);
        }
        
        /* MODULE CONTENT AREA */
        .module-content-area {
            grid-column: 1 / -1;
            background: var(--mickey-white);
            border-radius: 25px;
            padding: 30px;
            margin-top: 40px;
            border: 5px solid var(--mickey-black);
            box-shadow: 0 10px 0 var(--mickey-black);
            display: none;
        }
        
        .module-content-area.active {
            display: block;
            animation: slideIn 0.5s ease;
        }
        
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 4px solid var(--mickey-yellow);
        }
        
        .close-module {
            background: var(--mickey-red);
            color: var(--mickey-white);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            border: 3px solid var(--mickey-black);
        }
        
        .close-module:hover {
            transform: rotate(90deg);
        }
        
        .content-body {
            min-height: 400px;
        }
        
        /* GAME/ACTIVITY STYLES */
        .game-container {
            background: var(--mickey-yellow);
            padding: 25px;
            border-radius: 20px;
            border: 4px solid var(--mickey-black);
            margin-bottom: 30px;
        }
        
        .game-question {
            font-size: 1.4rem;
            color: var(--mickey-black);
            margin-bottom: 20px;
            font-family: 'Fredoka One', cursive;
        }
        
        .game-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .game-option {
            padding: 15px;
            background: var(--mickey-white);
            border: 3px solid var(--mickey-black);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Comic Neue', cursive;
            font-weight: 700;
            text-align: center;
        }
        
        .game-option:hover {
            transform: translateY(-5px);
            background: var(--mickey-red);
            color: var(--mickey-white);
        }
        
        .game-option.correct {
            background: #00cc00;
            color: white;
            border-color: #009900;
        }
        
        .game-option.wrong {
            background: #ff3333;
            color: white;
            border-color: #cc0000;
        }
        
        .game-feedback {
            padding: 15px;
            background: var(--mickey-blue);
            color: var(--mickey-white);
            border-radius: 15px;
            display: none;
            margin-bottom: 20px;
            border: 3px solid var(--mickey-black);
        }
        
        .game-feedback.show {
            display: block;
            animation: bounceIn 0.5s;
        }
        
        .game-progress {
            background: var(--mickey-white);
            padding: 20px;
            border-radius: 15px;
            border: 4px solid var(--mickey-black);
            margin-top: 30px;
        }
        
        .progress-bar {
            height: 30px;
            background: linear-gradient(90deg, var(--mickey-yellow), var(--mickey-red));
            border-radius: 15px;
            width: 0%;
            transition: width 0.5s ease;
            border: 3px solid var(--mickey-black);
        }
        
        .progress-text {
            text-align: center;
            margin-top: 10px;
            font-family: 'Comic Neue', cursive;
            font-weight: 700;
            color: var(--mickey-blue);
        }
        
        /* GAME NAVIGATION */
        .game-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 3px dashed var(--mickey-red);
        }
        
        .game-counter {
            font-family: 'Fredoka One', cursive;
            color: var(--mickey-red);
            font-size: 1.2rem;
            background: var(--mickey-white);
            padding: 10px 20px;
            border-radius: 20px;
            border: 3px solid var(--mickey-black);
        }
        
        .nav-btn {
            padding: 12px 25px;
            background: var(--mickey-blue);
            color: var(--mickey-white);
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-family: 'Fredoka One', cursive;
            border: 3px solid var(--mickey-black);
        }
        
        .nav-btn:hover {
            background: var(--mickey-red);
            transform: scale(1.05);
        }
        
        .nav-btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        
        /* EASIER QUESTIONS STYLE */
        .easy-mode .game-question {
            font-size: 1.6rem;
            color: var(--mickey-blue);
        }
        
        .easy-mode .game-options {
            grid-template-columns: 1fr;
            gap: 10px;
        }
        
        .easy-mode .game-option {
            padding: 20px;
            font-size: 1.2rem;
            background: linear-gradient(145deg, #e6f7ff, #cceeff);
        }
        
        /* PROFILE CAPABILITY MODULES */
        .capability-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .capability-card {
            background: var(--mickey-yellow);
            padding: 20px;
            border-radius: 15px;
            border: 4px solid var(--mickey-black);
            transition: all 0.3s ease;
        }
        
        .capability-card.blue {
            background: var(--mickey-blue);
        }
        
        .capability-card.red {
            background: var(--mickey-red);
        }
        
        .capability-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        .module-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .skill-tag {
            background: var(--mickey-blue);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            display: inline-block;
            margin: 2px;
        }
        
        .skill-tag.yellow {
            background: var(--mickey-yellow);
            color: var(--mickey-black);
        }
        
        .skill-tag.white {
            background: var(--mickey-white);
            color: var(--mickey-blue);
        }
        
        /* BREAK TIMER */
        .break-timer {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 400px;
            background: var(--mickey-white);
            border-radius: 25px;
            border: 5px solid var(--mickey-black);
            box-shadow: 
                0 15px 0 var(--mickey-black),
                0 25px 50px rgba(0,0,0,0.4);
            z-index: 10001;
            display: none;
            overflow: hidden;
        }
        
        .break-timer.show {
            display: block;
            animation: interventionPop 0.5s;
        }
        
        .timer-display {
            font-size: 4rem;
            color: var(--mickey-red);
            margin: 20px 0;
            font-family: 'Fredoka One', cursive;
            text-align: center;
        }
        
        .breathing-animation {
            background: var(--mickey-yellow);
            padding: 20px;
            border-radius: 15px;
            border: 3px solid var(--mickey-black);
            margin: 20px 0;
            text-align: center;
            font-size: 1.2rem;
            color: var(--mickey-red);
        }
        
        /* MICKEY DECORATIONS */
        .mickey-dot {
            position: fixed;
            width: 20px;
            height: 20px;
            background: var(--mickey-red);
            border-radius: 50%;
            border: 3px solid var(--mickey-black);
            z-index: -1;
            animation: float 20s infinite linear;
        }
        
        .polka-dot {
            position: fixed;
            width: 40px;
            height: 40px;
            background: var(--mickey-yellow);
            border-radius: 50%;
            border: 4px solid var(--mickey-white);
            z-index: -1;
            opacity: 0.3;
        }
        
        @keyframes float {
            0% { transform: translateY(0) rotate(0deg); }
            100% { transform: translateY(-100vh) rotate(360deg); }
        }
        
        @keyframes bounceIn {
            0% { transform: scale(0.5); opacity: 0; }
            70% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        /* RESPONSIVE DESIGN */
        @media (max-width: 768px) {
            body {
                padding-top: 160px; /* More padding for mobile */
            }
            
            .fixed-header {
                padding: 10px;
            }
            
            .header-container {
                flex-direction: column;
                gap: 10px;
            }
            
            .header-nav {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .nav-tab {
                padding: 8px 15px;
                font-size: 0.9rem;
            }
            
            .accessibility-toolbar {
                top: 160px;
                right: 20px;
                flex-wrap: wrap;
                justify-content: center;
                width: fit-content;
            }
            
            .side-collapsible {
                bottom: 20px;
                right: 20px;
            }
            
            .collapsible-controls {
                top: 160px;
                right: 20px;
            }
            
            .learning-hub {
                padding: 15px;
            }
            
            .modules-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .game-options {
                grid-template-columns: 1fr;
            }
            
            .empathic-agent {
                width: 90vw;
                left: 50%;
                transform: translateX(-50%);
            }
            
            .intervention-modal {
                width: 90vw;
            }
            
            .break-timer {
                width: 90vw;
            }
            
            .module-content-area {
                margin: 20px 10px;
                padding: 20px;
            }
            
            .capability-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    
    <!-- FIXED HEADER -->
    <header class="fixed-header">
        <div class="header-container">
            <div class="header-logo">
                <div class="logo-icon">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <span>Mickey's Learning Hub</span>
            </div>
            
            <nav class="header-nav">
                <a href="#" class="nav-tab active" id="game-tab">
                    <i class="fas fa-gamepad"></i> Game Center
                </a>
                <a href="#" class="nav-tab" id="profile-tab">
                    <i class="fas fa-user"></i> Profile
                </a>
                <a href="#" class="nav-tab" id="about-tab">
                    <i class="fas fa-info-circle"></i> About Us
                </a>
                <a href="#" class="nav-tab" id="settings-tab">
                    <i class="fas fa-cog"></i> Settings
                </a>
            </nav>
        </div>
    </header>
    
    <!-- MOVABLE ACCESSIBILITY TOOLBAR -->
    <div class="accessibility-toolbar" id="accessibility-toolbar">
        <button class="accessibility-btn" id="dyslexia-btn" title="Dyslexia-friendly mode">
            <i class="fas fa-book-reader"></i>
        </button>
        <button class="accessibility-btn" id="high-contrast-btn" title="High contrast mode">
            <i class="fas fa-adjust"></i>
        </button>
        <button class="accessibility-btn" id="font-size-btn" title="Increase font size">
            <i class="fas fa-font"></i>
        </button>
        <button class="accessibility-btn" id="text-to-speech-btn" title="Text to speech">
            <i class="fas fa-volume-up"></i>
        </button>
    </div>
    
    <!-- SIDE COLLAPSIBLE FOR AGENT AND CAMERA -->
    <div class="side-collapsible" id="side-collapsible">
        <div class="side-toggle" id="side-toggle">
            <i class="fas fa-plus"></i>
        </div>
        <div class="side-bubbles" id="side-bubbles">
            <div class="side-bubble agent" id="side-agent" title="Mickey Mouse Helper">
                <i class="fas fa-robot"></i>
            </div>
            <div class="side-bubble camera" id="side-camera" title="Camera Controls">
                <i class="fas fa-camera"></i>
            </div>
            <div class="side-bubble accessibility" id="side-accessibility" title="Accessibility Tools">
                <i class="fas fa-universal-access"></i>
            </div>
        </div>
    </div>
    
    <!-- Camera Status Indicator (shows when camera is running in background) -->
    <div class="camera-status-indicator" id="camera-status-indicator" title="Camera & Emotion Detection Active"></div>

    <!-- CAMERA COLLAPSIBLE CONTENT -->
    <div class="collapsible-controls" id="collapsible-controls">
        <div class="collapsible-content" id="camera-content">
            <button class="collapsible-close-btn" id="close-camera-content" title="Close camera panel (detection continues)">
                <i class="fas fa-times"></i>
            </button>
            <div class="camera-container">
                <div class="face-detection-container">
                    <video id="face-video" playsinline></video>
                    <canvas id="face-canvas"></canvas>
                </div>
                <div id="face-status">
                    <div style="color: var(--mickey-red); font-weight: bold; margin-bottom: 15px; font-size: 16px;">
                        <i class="fas fa-magic"></i> ENHANCED MEDIAPIPE FACE DETECTION
                        <span id="camera-status-badge" style="background: #00cc00; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; margin-left: 10px;">ACTIVE</span>
                    </div>
                    <div id="status-text" style="color: var(--mickey-blue);">
                        Click START to begin ENHANCED 468-point face landmark detection!
                    </div>
                </div>
                <button class="module-btn start-btn" id="start-face-detection" style="width: 100%; margin-top: 15px;">
                    <i class="fas fa-play-circle" id="btn-icon"></i>
                    <span id="btn-text">START ENHANCED MEDIAPIPE</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- GAME CENTER CONTENT AREA (DEFAULT ACTIVE) -->
    <div class="content-area active" id="game-center-content-area">
        <!-- LEARNING HUB (ONLY APPEARS IN GAME CENTER) -->
        <main class="learning-hub">
            <!-- MICKEY MOUSE DECORATIONS -->
            <div class="polka-dot" style="top: 10%; left: 5%;"></div>
            <div class="polka-dot" style="top: 20%; right: 10%;"></div>
            <div class="polka-dot" style="bottom: 30%; left: 15%;"></div>
            <div class="mickey-dot" style="top: 15%; right: 20%; animation-delay: -5s;"></div>
            <div class="mickey-dot" style="top: 40%; left: 8%; animation-delay: -10s;"></div>
            
            <!-- MICKEY MOUSE HEADER -->
            <div class="mickey-header">
                <div class="mickey-ears">
                    <div class="ear ear-left">
                        <div class="ear-inner"></div>
                    </div>
                    <div class="ear ear-right">
                        <div class="ear-inner"></div>
                    </div>
                </div>
                <h1>MICKEY'S EMPATHIC LEARNING HUB</h1>
            </div>
            
            <p class="subtitle">
                <i class="fas fa-heart"></i> 
                Oh boy! Mickey and friendsare here to support your learning journey!
                <i class="fas fa-robot"></i>
                <br>
            </p>
            
            <div class="modules-grid">
                <!-- MATH MODULE -->
                <div class="module-card" data-module="math">
                    <div class="module-title">
                        <i class="fas fa-calculator"></i>
                        Mickey's Math Magic
                    </div>
                    <div class="module-desc">
                        <strong>Dyslexia Support:</strong> Visual counting, step-by-step problems, 
                        number lines, and hands-on activities. Break math into manageable pieces!                    
                    </div>

                    <!-- DYSLEXIA-FRIENDLY CONTROLS -->
                    <div class="dyslexia-options" style="margin: 15px 0; padding: 10px; background: #f0f8ff; border-radius: 10px; border: 2px solid #0066cc;">
                        <div style="font-size: 12px; color: var(--mickey-blue); margin-bottom: 8px; display: flex; align-items: center; gap: 5px;">
                            <i class="fas fa-universal-access"></i> Dyslexia Support:
                        </div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button class="dyslexia-option" onclick="toggleDyslexiaText('math')" title="Switch to dyslexia-friendly font">
                                <i class="fas fa-font"></i> Easy-Read Font
                            </button>
                            <button class="dyslexia-option" onclick="enableColorOverlay('math')" title="Color overlay for reading">
                                <i class="fas fa-highlighter"></i> Color Overlay
                            </button>
                            <button class="dyslexia-option" onclick="enableLineReader('math')" title="Line reader tool">
                                <i class="fas fa-text-width"></i> Line Reader
                            </button>
                        </div>
                    </div>

                    <div class="module-controls">
                        <button class="module-btn start-btn" onclick="startGame('math')">
                            <i class="fas fa-gamepad"></i> Play Math Game
                        </button>
                        <button class="module-btn view-btn" onclick="viewModule('math')">
                            <i class="fas fa-info-circle"></i> Learn More
                        </button>
                    </div>
                </div>
                
                <!-- READING MODULE -->
                <div class="module-card" data-module="reading">
                    <div class="module-title">
                        <i class="fas fa-book-reader"></i>
                        Disney Story Time
                    </div>
                    <div class="module-desc">
                        <strong>Dyslexia Support:</strong> Simplified text, syllable breakdown, 
                        phonics support, line readers, and multi-sensory reading tools.
                    </div>

                    <!-- DYSLEXIA-FRIENDLY CONTROLS -->
                    <div class="dyslexia-options" style="margin: 15px 0; padding: 10px; background: #f0f8ff; border-radius: 10px; border: 2px solid #0066cc;">
                        <div style="font-size: 12px; color: var(--mickey-blue); margin-bottom: 8px; display: flex; align-items: center; gap: 5px;">
                            <i class="fas fa-universal-access"></i> Dyslexia Support:
                        </div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button class="dyslexia-option" onclick="toggleDyslexiaText('read')" title="Switch to dyslexia-friendly font">
                                <i class="fas fa-font"></i> Easy-Read Font
                            </button>
                            <button class="dyslexia-option" onclick="enableColorOverlay('read')" title="Color overlay for reading">
                                <i class="fas fa-highlighter"></i> Color Overlay
                            </button>
                            <button class="dyslexia-option" onclick="enableLineReader('read')" title="Line reader tool">
                                <i class="fas fa-text-width"></i> Line Reader
                            </button>
                        </div>
                    </div>

                    <div class="module-controls">
                        <button class="module-btn start-btn" onclick="startGame('reading')">
                            <i class="fas fa-gamepad"></i> Play Reading Game
                        </button>
                        <button class="module-btn view-btn" onclick="viewModule('reading')">
                            <i class="fas fa-info-circle"></i> Learn More
                        </button>
                    </div>
                </div>
                
                <!-- SCIENCE MODULE -->
                <div class="module-card" data-module="science">
                    <div class="module-title">
                        <i class="fas fa-flask"></i>
                        Goofy's Science Lab
                    </div>
                    <div class="module-desc">
                        Join Goofy for fun science experiments and discoveries! Learn about plants, animals, and simple machines.
                    </div>

                    <!-- DYSLEXIA-FRIENDLY CONTROLS -->
                    <div class="dyslexia-options" style="margin: 15px 0; padding: 10px; background: #f0f8ff; border-radius: 10px; border: 2px solid #0066cc;">
                        <div style="font-size: 12px; color: var(--mickey-blue); margin-bottom: 8px; display: flex; align-items: center; gap: 5px;">
                            <i class="fas fa-universal-access"></i> Dyslexia Support:
                        </div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button class="dyslexia-option" onclick="toggleDyslexiaText('read')" title="Switch to dyslexia-friendly font">
                                <i class="fas fa-font"></i> Easy-Read Font
                            </button>
                            <button class="dyslexia-option" onclick="enableColorOverlay('read')" title="Color overlay for reading">
                                <i class="fas fa-highlighter"></i> Color Overlay
                            </button>
                            <button class="dyslexia-option" onclick="enableLineReader('read')" title="Line reader tool">
                                <i class="fas fa-text-width"></i> Line Reader
                            </button>
                        </div>
                    </div>

                    <div class="module-controls">
                        <button class="module-btn start-btn" onclick="startGame('science')">
                            <i class="fas fa-gamepad"></i> Play Science Game
                        </button>
                        <button class="module-btn view-btn" onclick="viewModule('science')">
                            <i class="fas fa-info-circle"></i> Learn More
                        </button>
                    </div>
                </div>
                
                <!-- MUSIC MODULE -->
                <div class="module-card" data-module="music">
                    <div class="module-title">
                        <i class="fas fa-music"></i>
                        Donald's Music Class
                    </div>
                    <div class="module-desc">
                        Learn about music, rhythm, and instruments with Donald Duck! No quacking required! Discover notes and melodies.
                    </div>

                    <!-- DYSLEXIA-FRIENDLY CONTROLS -->
                    <div class="dyslexia-options" style="margin: 15px 0; padding: 10px; background: #f0f8ff; border-radius: 10px; border: 2px solid #0066cc;">
                        <div style="font-size: 12px; color: var(--mickey-blue); margin-bottom: 8px; display: flex; align-items: center; gap: 5px;">
                            <i class="fas fa-universal-access"></i> Dyslexia Support:
                        </div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button class="dyslexia-option" onclick="toggleDyslexiaText('read')" title="Switch to dyslexia-friendly font">
                                <i class="fas fa-font"></i> Easy-Read Font
                            </button>
                            <button class="dyslexia-option" onclick="enableColorOverlay('read')" title="Color overlay for reading">
                                <i class="fas fa-highlighter"></i> Color Overlay
                            </button>
                            <button class="dyslexia-option" onclick="enableLineReader('read')" title="Line reader tool">
                                <i class="fas fa-text-width"></i> Line Reader
                            </button>
                        </div>
                    </div>

                    <div class="module-controls">
                        <button class="module-btn start-btn" onclick="startGame('music')">
                            <i class="fas fa-gamepad"></i> Play Music Game
                        </button>
                        <button class="module-btn view-btn" onclick="viewModule('music')">
                            <i class="fas fa-info-circle"></i> Learn More
                        </button>
                    </div>
                </div>
                
                <!-- ART MODULE -->
                <div class="module-card" data-module="art">
                    <div class="module-title">
                        <i class="fas fa-paint-brush"></i>
                        Art with Mickey
                    </div>
                    <div class="module-desc">
                        Paint and draw with Mickey Mouse! Create your own Disney masterpiece! Learn colors, shapes, and creativity.
                    </div>

                    <!-- DYSLEXIA-FRIENDLY CONTROLS -->
                    <div class="dyslexia-options" style="margin: 15px 0; padding: 10px; background: #f0f8ff; border-radius: 10px; border: 2px solid #0066cc;">
                        <div style="font-size: 12px; color: var(--mickey-blue); margin-bottom: 8px; display: flex; align-items: center; gap: 5px;">
                            <i class="fas fa-universal-access"></i> Dyslexia Support:
                        </div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button class="dyslexia-option" onclick="toggleDyslexiaText('read')" title="Switch to dyslexia-friendly font">
                                <i class="fas fa-font"></i> Easy-Read Font
                            </button>
                            <button class="dyslexia-option" onclick="enableColorOverlay('read')" title="Color overlay for reading">
                                <i class="fas fa-highlighter"></i> Color Overlay
                            </button>
                            <button class="dyslexia-option" onclick="enableLineReader('read')" title="Line reader tool">
                                <i class="fas fa-text-width"></i> Line Reader
                            </button>
                        </div>
                    </div>

                    <div class="module-controls">
                        <button class="module-btn start-btn" onclick="startGame('art')">
                            <i class="fas fa-gamepad"></i> Play Art Game
                        </button>
                        <button class="module-btn view-btn" onclick="viewModule('art')">
                            <i class="fas fa-info-circle"></i> Learn More
                        </button>
                    </div>
                </div>
                
                <!-- GEOGRAPHY MODULE -->
                <div class="module-card" data-module="geography">
                    <div class="module-title">
                        <i class="fas fa-globe-americas"></i>
                        Pluto's World Tour
                    </div>
                    <div class="module-desc">
                        Travel around the world with Pluto! Learn about different countries, cultures, and famous landmarks.
                    </div>

                    <!-- DYSLEXIA-FRIENDLY CONTROLS -->
                    <div class="dyslexia-options" style="margin: 15px 0; padding: 10px; background: #f0f8ff; border-radius: 10px; border: 2px solid #0066cc;">
                        <div style="font-size: 12px; color: var(--mickey-blue); margin-bottom: 8px; display: flex; align-items: center; gap: 5px;">
                            <i class="fas fa-universal-access"></i> Dyslexia Support:
                        </div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button class="dyslexia-option" onclick="toggleDyslexiaText('read')" title="Switch to dyslexia-friendly font">
                                <i class="fas fa-font"></i> Easy-Read Font
                            </button>
                            <button class="dyslexia-option" onclick="enableColorOverlay('read')" title="Color overlay for reading">
                                <i class="fas fa-highlighter"></i> Color Overlay
                            </button>
                            <button class="dyslexia-option" onclick="enableLineReader('read')" title="Line reader tool">
                                <i class="fas fa-text-width"></i> Line Reader
                            </button>
                        </div>
                    </div>
                    
                    <div class="module-controls">
                        <button class="module-btn start-btn" onclick="startGame('geography')">
                            <i class="fas fa-gamepad"></i> Play Geography Game
                        </button>
                        <button class="module-btn view-btn" onclick="viewModule('geography')">
                            <i class="fas fa-info-circle"></i> Learn More
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- MICKEY MOUSE SIGNATURE -->
            <div style="text-align: center; margin-top: 50px; padding: 20px;">
                <div style="display: inline-block; background: var(--mickey-white); padding: 15px 30px; border-radius: 50px; border: 5px solid var(--mickey-black);">
                    <span style="color: var(--mickey-red); font-family: 'Comic Neue', cursive; font-size: 1.2rem;">
                        <i class="fas fa-heartbeat"></i> 
                        Enhanced Empathic Learning with Mickey  
                        <i class="fas fa-robot"></i> 
                        AI Helper Bot Included 
                        <i class="fab fa-google"></i>
                        ENHANCED MediaPipe Face Detection
                    </span>
                </div>
            </div>
        </main>
    </div>
    
    <!-- PROFILE CONTENT AREA -->
    <div class="content-area" id="profile-content-area">
        <div class="profile-content">
            <h2 style="color: var(--mickey-red); text-align: center; margin-bottom: 30px;">
                <i class="fas fa-user-graduate"></i> Student Profile
            </h2>
            
            <div class="student-profile">
                <div class="profile-header">
                    <div class="avatar">
                        <i class="fas fa-graduation-cap"></i>
                    </div>
                    <div>
                        <h3 style="margin: 0; color: var(--mickey-red);">Student Progress</h3>
                        <p style="margin: 5px 0; color: var(--mickey-blue); font-family: 'Comic Neue', cursive;">
                            <i class="fas fa-star"></i> 
                            <span id="student-points">150</span> Mickey Points
                        </p>
                    </div>
                </div>
                
                <div class="game-progress">
                    <div class="progress-bar" id="overall-progress" style="width: 40%"></div>
                    <div class="progress-text">40% Complete</div>
                </div>
                
                <!-- CAPABILITY MODULES SECTION -->
                <div style="margin-top: 30px;">
                    <h3 style="color: var(--mickey-red); border-bottom: 3px solid var(--mickey-yellow); padding-bottom: 10px;">
                        <i class="fas fa-chart-line"></i> Learning Capabilities
                    </h3>
                    
                    <div class="capability-grid">
                        <div class="capability-card">
                            <div class="module-header">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="width: 40px; height: 40px; background: var(--mickey-red); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-calculator" style="color: white;"></i>
                                    </div>
                                    <div>
                                        <h4 style="margin: 0; color: var(--mickey-black);">Mathematics</h4>
                                        <p style="margin: 5px 0 0 0; color: var(--mickey-blue); font-size: 0.9em;">Grade 5</p>
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 1.8rem; font-weight: bold; color: var(--mickey-red);">92%</div>
                                    <div style="font-size: 0.8em; color: var(--mickey-black);">Mastery</div>
                                </div>
                            </div>
                            <div style="background: var(--mickey-white); height: 8px; border-radius: 4px; overflow: hidden; margin: 15px 0;">
                                <div style="background: var(--mickey-red); height: 100%; width: 92%;"></div>
                            </div>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 15px;">
                                <span class="skill-tag">Algebra</span>
                                <span class="skill-tag">Geometry</span>
                                <span class="skill-tag">Statistics</span>
                                <span class="skill-tag">Calculus</span>
                            </div>
                        </div>
                        
                        <div class="capability-card blue">
                            <div class="module-header">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="width: 40px; height: 40px; background: var(--mickey-white); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-book" style="color: var(--mickey-blue);"></i>
                                    </div>
                                    <div>
                                        <h4 style="margin: 0; color: var(--mickey-white);">Language Arts</h4>
                                        <p style="margin: 5px 0 0 0; color: var(--mickey-yellow); font-size: 0.9em;">Grade 5</p>
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 1.8rem; font-weight: bold; color: var(--mickey-white);">88%</div>
                                    <div style="font-size: 0.8em; color: var(--mickey-white);">Mastery</div>
                                </div>
                            </div>
                            <div style="background: var(--mickey-white); height: 8px; border-radius: 4px; overflow: hidden; margin: 15px 0;">
                                <div style="background: var(--mickey-yellow); height: 100%; width: 88%;"></div>
                            </div>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 15px;">
                                <span class="skill-tag yellow">Reading</span>
                                <span class="skill-tag yellow">Writing</span>
                                <span class="skill-tag yellow">Grammar</span>
                                <span class="skill-tag yellow">Vocabulary</span>
                            </div>
                        </div>
                        
                        <div class="capability-card red">
                            <div class="module-header">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="width: 40px; height: 40px; background: var(--mickey-yellow); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-flask" style="color: var(--mickey-red);"></i>
                                    </div>
                                    <div>
                                        <h4 style="margin: 0; color: var(--mickey-white);">Science</h4>
                                        <p style="margin: 5px 0 0 0; color: var(--mickey-yellow); font-size: 0.9em;">Grade 5</p>
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 1.8rem; font-weight: bold; color: var(--mickey-white);">85%</div>
                                    <div style="font-size: 0.8em; color: var(--mickey-white);">Mastery</div>
                                </div>
                            </div>
                            <div style="background: var(--mickey-white); height: 8px; border-radius: 4px; overflow: hidden; margin: 15px 0;">
                                <div style="background: var(--mickey-yellow); height: 100%; width: 85%;"></div>
                            </div>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 15px;">
                                <span class="skill-tag yellow">Physics</span>
                                <span class="skill-tag yellow">Chemistry</span>
                                <span class="skill-tag yellow">Biology</span>
                                <span class="skill-tag yellow">Earth Science</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 30px;">
                    <h4 style="color: var(--mickey-blue); margin-bottom: 10px;">Badges Earned</h4>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <div style="background: var(--mickey-yellow); padding: 10px; border-radius: 10px; border: 3px solid var(--mickey-black);">
                            <i class="fas fa-calculator" style="color: var(--mickey-red);"></i>
                        </div>
                        <div style="background: var(--mickey-yellow); padding: 10px; border-radius: 10px; border: 3px solid var(--mickey-black);">
                            <i class="fas fa-book" style="color: var(--mickey-red);"></i>
                        </div>
                        <div style="background: var(--mickey-yellow); padding: 10px; border-radius: 10px; border: 3px solid var(--mickey-black);">
                            <i class="fas fa-music" style="color: var(--mickey-red);"></i>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 30px;">
                    <h4 style="color: var(--mickey-blue); margin-bottom: 10px;">Recent Activity</h4>
                    <div style="background: var(--mickey-white); padding: 15px; border-radius: 15px; border: 3px solid var(--mickey-black);">
                        <p style="color: var(--mickey-black); font-family: 'Comic Neue', cursive; margin: 0;">
                            <i class="fas fa-check-circle" style="color: #00cc00;"></i> 
                            Completed Math Game - 20 points
                        </p>
                        <p style="color: var(--mickey-black); font-family: 'Comic Neue', cursive; margin: 10px 0 0 0;">
                            <i class="fas fa-star" style="color: var(--mickey-yellow);"></i> 
                            Current focus level: <span id="profile-focus-level">75</span>%
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ABOUT US CONTENT AREA -->
    <div class="content-area" id="about-content-area">
        <div class="about-content">
            <h2 style="color: var(--mickey-red); text-align: center; margin-bottom: 30px;">
                <i class="fas fa-info-circle"></i> About Mickey's Learning Hub
            </h2>
            
            <div style="text-align: center; max-width: 800px; margin: 0 auto;">
                <div style="font-size: 4rem; color: var(--mickey-red); margin-bottom: 20px;">
                    <i class="fas fa-heart"></i>
                </div>
                <h3 style="color: var(--mickey-blue); margin-bottom: 20px;">Our Mission</h3>
                <p style="color: var(--mickey-black); font-family: 'Comic Neue', cursive; font-size: 1.2rem; line-height: 1.6; margin-bottom: 30px;">
                    Welcome to Mickey's Enhanced Empathic Learning Hub! We're dedicated to creating a fun, engaging, and supportive learning environment for children of all abilities.
                </p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 40px 0;">
                    <div style="background: var(--mickey-yellow); padding: 25px; border-radius: 20px; border: 4px solid var(--mickey-black);">
                        <div style="font-size: 3rem; color: var(--mickey-red); margin-bottom: 15px;">
                            <i class="fas fa-brain"></i>
                        </div>
                        <h4 style="color: var(--mickey-black); margin-bottom: 10px;">Enhanced Empathic AI</h4>
                        <p style="color: var(--mickey-black); font-family: 'Comic Neue', cursive;">
                            Using advanced Google MediaPipe technology with 468-point face detection for accurate emotion recognition.
                        </p>
                    </div>
                    
                    <div style="background: var(--mickey-blue); padding: 25px; border-radius: 20px; border: 4px solid var(--mickey-black);">
                        <div style="font-size: 3rem; color: var(--mickey-white); margin-bottom: 15px;">
                            <i class="fas fa-heartbeat"></i>
                        </div>
                        <h4 style="color: var(--mickey-white); margin-bottom: 10px;">Proactive Support</h4>
                        <p style="color: var(--mickey-white); font-family: 'Comic Neue', cursive;">
                            Our AI detects frustration, boredom, or confusion and offers immediate, personalized help.
                        </p>
                    </div>
                    
                    <div style="background: var(--mickey-red); padding: 25px; border-radius: 20px; border: 4px solid var(--mickey-black);">
                        <div style="font-size: 3rem; color: var(--mickey-white); margin-bottom: 15px;">
                            <i class="fas fa-gamepad"></i>
                        </div>
                        <h4 style="color: var(--mickey-white); margin-bottom: 10px;">Fun Learning Games</h4>
                        <p style="color: var(--mickey-white); font-family: 'Comic Neue', cursive;">
                            Disney-themed educational games across math, reading, science, music, art, and geography.
                        </p>
                    </div>
                </div>
                
                <div style="background: var(--mickey-white); padding: 25px; border-radius: 20px; border: 4px solid var(--mickey-black); margin-top: 30px;">
                    <h4 style="color: var(--mickey-red); margin-bottom: 15px;">Features</h4>
                    <ul style="text-align: left; color: var(--mickey-black); font-family: 'Comic Neue', cursive; font-size: 1.1rem; padding-left: 20px;">
                        <li> <strong>468-point facial landmark detection</strong></li>
                        <li> <strong>Multiple landmark emotion scoring system</strong></li>
                        <li> <strong>Real-time temporal smoothing</strong></li>
                        <li> <strong>Enhanced smile/frown detection</strong></li>
                        <li> <strong>Brow asymmetry analysis</strong></li>
                        <li> <strong>Eye squint detection</strong></li>
                        <li> <strong>Head tilt analysis</strong></li>
                        <li> <strong>Proactive interventions</strong></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- SETTINGS CONTENT AREA -->
    <div class="content-area" id="settings-content-area">
        <div class="settings-content">
            <h2 style="color: var(--mickey-red); text-align: center; margin-bottom: 30px;">
                <i class="fas fa-cog"></i> Settings & Preferences
            </h2>
            
            <div style="max-width: 800px; margin: 0 auto;">
                <div style="background: var(--mickey-white); padding: 30px; border-radius: 20px; border: 4px solid var(--mickey-black); margin-bottom: 30px;">
                    <h3 style="color: var(--mickey-red); margin-bottom: 20px;">Accessibility Settings</h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div style="background: var(--mickey-yellow); padding: 20px; border-radius: 15px; border: 3px solid var(--mickey-black);">
                            <h4 style="color: var(--mickey-black); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-book-reader"></i> Dyslexia Mode
                            </h4>
                            <p style="color: var(--mickey-black); font-family: 'Comic Neue', cursive; margin-bottom: 15px;">
                                Toggle dyslexia-friendly font and spacing
                            </p>
                            <button class="module-btn" id="toggle-dyslexia" style="width: 100%;">
                                <i class="fas fa-toggle-on"></i> Toggle Dyslexia Mode
                            </button>
                        </div>
                        
                        <div style="background: var(--mickey-blue); padding: 20px; border-radius: 15px; border: 3px solid var(--mickey-black);">
                            <h4 style="color: var(--mickey-white); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-adjust"></i> High Contrast
                            </h4>
                            <p style="color: var(--mickey-white); font-family: 'Comic Neue', cursive; margin-bottom: 15px;">
                                Enable high contrast mode for better visibility
                            </p>
                            <button class="module-btn" id="toggle-contrast" style="width: 100%;">
                                <i class="fas fa-toggle-on"></i> Toggle High Contrast
                            </button>
                        </div>
                    </div>
                    
                    <div style="background: var(--mickey-yellow); padding: 20px; border-radius: 15px; border: 3px solid var(--mickey-black); margin-bottom: 20px;">
                        <h4 style="color: var(--mickey-black); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-font"></i> Font Size
                        </h4>
                        <p style="color: var(--mickey-black); font-family: 'Comic Neue', cursive; margin-bottom: 15px;">
                            Adjust the text size for better readability
                        </p>
                        <button class="module-btn" id="increase-font" style="width: 100%; margin-bottom: 10px;">
                            <i class="fas fa-text-height"></i> Increase Font Size
                        </button>
                        <button class="module-btn" id="decrease-font" style="width: 100%;">
                            <i class="fas fa-text-width"></i> Decrease Font Size
                        </button>
                    </div>
                    
                    <h3 style="color: var(--mickey-red); margin-bottom: 20px;">Face Detection Settings</h3>
                    <div style="background: var(--mickey-yellow); padding: 20px; border-radius: 15px; border: 3px solid var(--mickey-black);">
                        <h4 style="color: var(--mickey-black); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-camera"></i> ENHANCED MediaPipe Detection
                        </h4>
                        <p style="color: var(--mickey-black); font-family: 'Comic Neue', cursive; margin-bottom: 15px;">
                            Status: <span id="detection-status" style="color: var(--mickey-red); font-weight: bold;">INACTIVE</span>
                        </p>
                        <button class="module-btn start-btn" id="settings-start-camera" style="width: 100%;">
                            <i class="fas fa-camera"></i> Start Camera Detection
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MICKEY MOUSE AGENT -->
    <div class="empathic-agent" id="empathic-agent">
        <button class="agent-minimize" id="agent-minimize">
            <i class="fas fa-times"></i>
        </button>
        <div class="agent-header">
            <div class="agent-avatar">
                <div class="mickey-avatar-small">
                    <div class="mickey-ears-small left"></div>
                    <div class="mickey-ears-small right"></div>
                    <div class="mickey-face-small"></div>
                </div>
            </div>
            <div>
                <h3 style="margin: 0; color: var(--mickey-white);">Mickey Mouse Helper</h3>
                <p style="margin: 5px 0 0 0; color: var(--mickey-yellow); font-family: 'Comic Neue', cursive;">
                    I'm here to help you when you feel frustrated!
                </p>
            </div>
        </div>
        <div class="agent-messages" id="agent-messages">
            <!-- Mickey messages will be added here -->
        </div>
        <div class="agent-input" style="display: none;">
            <input type="text" id="agent-input" placeholder="Type your message...">
            <button id="agent-send">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
    
    <!-- PROACTIVE INTERVENTION MODAL -->
    <div class="intervention-modal" id="intervention-modal">
        <div class="intervention-header">
            <h2 style="margin: 0; color: var(--mickey-white);">
                <i class="fas fa-heart"></i> I notice you might need help!
            </h2>
            <p style="margin: 10px 0 0 0; color: var(--mickey-yellow); font-family: 'Comic Neue', cursive;">
                Let me help you feel better!
            </p>
        </div>
        <div class="intervention-body">
            <div style="font-size: 4rem; color: var(--mickey-red); margin-bottom: 20px;">
                <div class="mickey-avatar-modal">
                    <div class="mickey-ears-modal left"></div>
                    <div class="mickey-ears-modal right"></div>
                    <div class="mickey-face-modal"></div>
                </div>
            </div>
            <h3 style="color: var(--mickey-blue); margin-bottom: 10px;" id="intervention-title">
                You seem a bit frustrated...
            </h3>
            <p style="color: var(--mickey-black); font-family: 'Comic Neue', cursive; font-size: 1.1rem;">
                How would you like me to help?
            </p>
            
            <div class="intervention-options" id="intervention-options">
                <!-- Options will be dynamically added -->
            </div>
            
            <button class="module-btn start-btn" id="close-intervention" style="margin-top: 20px;">
                <i class="fas fa-times"></i> I'm okay, continue
            </button>
        </div>
    </div>
    
    <!-- BREAK TIMER MODAL -->
    <div class="break-timer" id="break-timer">
        <div class="intervention-header">
            <h2 style="margin: 0; color: var(--mickey-white);">
                <i class="fas fa-clock"></i> Break Time!
            </h2>
            <p style="margin: 10px 0 0 0; color: var(--mickey-yellow); font-family: 'Comic Neue', cursive;">
                Take a deep breath and relax
            </p>
        </div>
        <div class="intervention-body">
            <div class="timer-display" id="timer-display">00:30</div>
            <h3 style="color: var(--mickey-blue); margin-bottom: 10px;">
                Mickey says: "Take a break!"
            </h3>
            <p style="color: var(--mickey-black); font-family: 'Comic Neue', cursive; font-size: 1.1rem;">
                Stretch, take deep breaths, and come back refreshed!
            </p>
            
            <div class="breathing-animation" id="breathing-animation">
                Breathe IN... (4 seconds)
            </div>
            
            <button class="module-btn start-btn" onclick="endMickeyBreak()" style="margin-top: 20px;">
                <i class="fas fa-play"></i> End Break Early
            </button>
        </div>
    </div>
    
    <!-- MODULE CONTENT AREA (HIDDEN BY DEFAULT) -->
    <div class="module-content-area" id="module-content">
        <div class="content-header">
            <h2 id="module-content-title" style="color: var(--mickey-red); margin: 0;"></h2>
            <button class="close-module" id="close-module">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="content-body" id="module-content-body">
            <!-- Dynamic content will be loaded here -->
        </div>
    </div>

    <!-- MAIN JAVASCRIPT -->
    <script>
        // ============================================
        // ENHANCED MEDIAPIPE FACE DETECTION
        // ============================================
        
        // Initialize MediaPipe Face Mesh
        const faceMesh = new FaceMesh({
            locateFile: (file) => {
                return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
            }
        });
        
        // Configure Face Mesh
        faceMesh.setOptions({
            maxNumFaces: 1,
            refineLandmarks: true,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });
        
        // Get video and canvas elements
        const videoElement = document.getElementById('face-video');
        const canvasElement = document.getElementById('face-canvas');
        const canvasCtx = canvasElement.getContext('2d');

        // Variables for face detection
        let isDetectionActive = false;
        let isCameraStarted = false;
        let lastEmotionUpdate = 0;
        let emotionHistory = [];
        const MAX_HISTORY = 10;
        
        // ============================================
        // GLOBAL STATE MANAGEMENT
        // ============================================
        
        // LEARNING MODULES DATA
        const learningGames = {
            math: { // This modules includes both addition and subtraction activities
                title: "Mickey's Math Magic Game",
                description: "Solve math puzzles with Mickey and friends!",
                activities: [
                    {
                        //Question 1
                        type: "quiz",
                        question: "Mickey has 3 apples. Minnie gives him 2 more.",
                        simplified_question: "Count: Mickey has 3 apples. Minnie gives 2 more.",
                        options: ["3", "5", "6", "7"],
                        options_full: ["3 apples", "5 apples", "6 apples", "7 apples"],
                        correct: 1,
                        explanation: "Great job! 3 + 2 = 5 apples!",
                        simplified_explanation: "3 + 2 = 5",
                        points: 10,
                        visual_aid: " +  = "
                    },
                    {
                        //Question 2                        
                        type: "quiz",
                        question: "Donald has 8 fish. He gives 3 to Goofy.",
                        simplified_question: "Take away: Donald has 8 fish. Gives 3 to Goofy.",
                        options: ["4", "5", "6", "7"],
                        options_full: ["4 fish", "5 fish", "6 fish", "7 fish"],
                        correct: 1,
                        explanation: "Excellent! 8 - 3 = 5 fish!",
                        simplified_explanation: "8 - 3 = 5",
                        points: 10,
                        visual_aid: " -  = "
                    },
                    {
                        //Question 3
                        type: "quiz",
                        question: "Goofy has 6 balloons. 4 fly away.",
                        simplified_question: "Take away: 6 balloons. 4 fly away.",
                        options: ["1", "2", "3", "4"],
                        options_full: ["1 balloon", "2 balloons", "3 balloons", "4 balloons"],
                        correct: 1,
                        explanation: "Nice! 6 - 4 = 2 balloons!",
                        simplified_explanation: "6 - 4 = 2",
                        points: 10,
                        visual_aid: " -  = "
                    },
                    {
                        //Question 4
                        type: "quiz",
                        question: "Minnie picks 4 flowers. Daisy gives her 3 more.",
                        simplified_question: "Add: 4 flowers + 3 flowers.",
                        options: ["6", "7", "8", "5"],
                        options_full: ["6 flowers", "7 flowers", "8 flowers", "5 flowers"],
                        correct: 1,
                        explanation: "Great! 4 + 3 = 7 flowers!",
                        simplified_explanation: "4 + 3 = 7",
                        points: 10,
                        visual_aid: " +  = "
                    },
                    {
                        //Question 5
                        type: "quiz",
                        question: "Minnie has 12 cookies. She eats 2.",
                        simplified_question: "12 cookies - 2 cookies.",
                        options: ["9", "10", "11", "12"],
                        correct: 1,
                        explanation: "Correct! 12  2 = 10.",
                        simplified_explanation: "12 - 2 = 10",
                        points: 10,
                        visual_aid: " -  = "
                    }, 

                ],
                dyslexia_tips: [
                    "Use number lines for counting",
                    "Break problems into smaller steps",
                    "Use physical objects to count"
                ],
                currentActivity: 0,
                completed: false
            },
            
            reading: { // This modules includes both story and rhyme activities
                title: "Disney Story Time Game",
                description: "Read along with Mickey, Minnie, and all your favorite Disney characters!",
                activities: [
                    {   // Question 1 
                        type: "story",
                        title: "Mickey's Big Day",
                        story: "Mickey woke up early. He put on his red shorts. He ate breakfast. Then he went to see Minnie.",
                        simplified_story: "Mickey woke up. He put on red shorts. He ate. He went to see Minnie.",
                        questions: [
                            {   // Sub Question 1
                                question: "What did Mickey put on?",
                                simplified_question: "What did Mickey wear?",
                                options: ["Blue hat", "Red shorts", "Green shoes", "Black gloves"],
                                correct: 1,
                                explanation: "Correct! Mickey put on his red shorts!",
                                visual_aid: ""
                            },
                            {   // Sub Question 2
                                question: "Who did Mickey go to see?",
                                simplified_question: "Who did Mickey visit?",
                                options: ["Donald", "Goofy", "Pluto", "Minnie"],
                                correct: 3,
                                explanation: "Great! Mickey went to see Minnie!",
                                visual_aid: ""
                            }
                        ],
                        points: 10
                    },
                    {   // Question 2
                        type: "rhyme",
                        question: "Which word rhymes with 'mouse'?",
                        simplified_question: "Find the rhyming word for 'mouse'",
                        options: ["House", "Dog", "Cat", "Bird"],
                        options_rhymes: ["mouse/house", "dog/frog", "cat/hat", "bird/word"],
                        correct: 0,
                        explanation: "Great! Mouse rhymes with house!",
                        simplified_explanation: "mouse  house",
                        points: 10,
                        audio_clue: " 'mouse' sounds like 'house'"
                    },
                    {   // Question 3
                        type: "story",
                        title: "Goofy's New Shoes",
                        story: "Goofy bought new shoes. He tried them on. He walked happily.",
                        simplified_story: "Goofy got new shoes. He tried them. He walked.",
                        questions: [
                            {   // Sub Question 1
                                question: "What did Goofy buy?",
                                simplified_question: "What did he get?",
                                options: ["Shoes", "Hat", "Gloves", "Socks"],
                                correct: 0,
                                explanation: "Correct! Goofy bought shoes!",
                                visual_aid: ""
                            }
                        ],
                        points: 10
                    },
                    {   // Question 4
                        type: "rhyme",
                        question: "Which word rhymes with 'cat'?",
                        simplified_question: "Find rhyme for 'cat'",
                        options: ["Hat", "Dog", "Fish", "Car"],
                        options_rhymes: ["cat/hat", "dog/frog", "fish/dish", "car/star"],
                        correct: 0,
                        explanation: "Correct! Cat rhymes with hat.",
                        simplified_explanation: "cat  hat",
                        points: 10,
                        audio_clue: " cat / hat"
                    },
                    {   // Question 5
                        type: "story",
                        title: "Minnie's Garden",
                        story: "Minnie planted seeds. She watered them every day. Soon, green leaves appeared.",
                        simplified_story: "Minnie planted seeds. She watered them. Leaves grew.",
                        questions: [
                            {
                                question: "What did Minnie water?",
                                simplified_question: "What did she water?",
                                options: ["Seeds", "Clothes", "Shoes", "Books"],
                                correct: 0,
                                explanation: "Yes! She watered the seeds!",
                                visual_aid: ""
                            }
                        ],
                        points: 10
                    },
                ],
                dyslexia_tips: [
                    "Break words into syllables",
                    "Use phonics sounds",
                    "Highlight rhyming patterns"
                ],
                currentActivity: 0,
                completed: false
            },
            
            science: {
                title: "Goofy's Science Lab Game",
                description: "Fun science experiments with Goofy!",
                activities: [
                    {   // Question 1
                        type: "quiz",
                        question: "What do plants need to grow?",
                        simplified_question: "Plants need what to grow?",
                        options: ["Water, sun, air", "Candy, soda", "TV, games", "Toys, games"],
                        visual_options: [
                            "",
                            "",
                            "",
                            ""
                        ],
                        correct: 0,
                        explanation: "Correct! Plants need water, sunlight, and air to grow!",
                        simplified_explanation: "Plants need: water + sun + air",
                        points: 10,
                        mnemonic: "Water the plant, Give it sun, Air for everyone!"
                    },
                    {   // Question 2
                        type: "quiz",
                        question: "What do we drink to stay healthy?",
                        simplified_question: "What do we drink?",
                        options: ["Water", "Oil", "Juice", "Soda"],
                        visual_options: ["", "", "", ""],
                        correct: 0,
                        explanation: "Correct! Water keeps us healthy!",
                        simplified_explanation: "Water = healthy",
                        points: 10,
                        mnemonic: "Drink water every day!"
                    },
                    {   // Question 3
                        type: "quiz",
                        question: "What do bees make?",
                        simplified_question: "Bees make what?",
                        options: ["Honey", "Milk", "Bread", "Water"],
                        visual_options: ["", "", "", ""],
                        correct: 0,
                        explanation: "Yes! Bees make honey!",
                        simplified_explanation: "Bees  honey",
                        points: 10,
                        mnemonic: "Buzz buzz honey!"
                    },
                    {   // Question 4
                        type: "quiz",
                        question: "What gives us light during the day?",
                        simplified_question: "Light daytime = ?",
                        options: ["Sun", "Moon", "Stars", "Firefly"],
                        visual_options: ["", "", "", ""],
                        correct: 0,
                        explanation: "Correct! The sun gives us light!",
                        simplified_explanation: "Sun = day light",
                        points: 10,
                        mnemonic: "Sun shines bright!"
                    },
                    {   // Question 5
                        type: "quiz",
                        question: "Which animal lives in water?",
                        simplified_question: "Lives in water?",
                        options: ["Fish", "Cat", "Dog", "Bird"],
                        visual_options: ["", "", "", ""],
                        correct: 0,
                        explanation: "Correct! Fish live in water!",
                        simplified_explanation: "Fish = water",
                        points: 10,
                        mnemonic: "Fish swim!"
                    }
                ],
                dyslexia_tips: [
                    "Use visual diagrams",
                    "Create memory aids",
                    "Break processes into steps"
                ],
                currentActivity: 0,
                completed: false
            },
            
            music: {
                title: "Donald's Music Class Game",
                description: "Learn about music with Donald Duck!",
                activities: [
                    {   // Question 1
                        type: "quiz",
                        question: "Which instrument makes this sound? ",
                        simplified_question: "What makes this sound? ",
                        options: ["Trumpet", "Drum", "Piano", "Guitar"],
                        audio_icons: ["", "", "", ""],
                        correct: 0,
                        explanation: "Great! The trumpet makes a trumpet sound!",
                        simplified_explanation: " = Trumpet",
                        points: 10,
                        sound_clue: "Listen for the brass sound!"
                    },
                    {   // Question 2
                        type: "quiz",
                        question: "Which instrument goes ?",
                        simplified_question: "What makes this sound? ",
                        options: ["Drum", "Piano", "Flute", "Guitar"],
                        audio_icons: ["", "", "", ""],
                        correct: 0,
                        explanation: "Yes! Drums make that beat!",
                        simplified_explanation: " = Drum",
                        points: 10
                    },
                    {   // Question 3
                        type: "quiz",
                        question: "Which instrument has strings? ",
                        simplified_question: "Which has strings?",
                        options: ["Guitar", "Flute", "Drum", "Trumpet"],
                        audio_icons: ["", "", "", ""],
                        correct: 0,
                        explanation: "Correct! A guitar has strings!",
                        simplified_explanation: " = strings",
                        points: 10
                    },
                    {   // Question 4
                        type: "quiz",
                        question: "Which instrument do you blow into? ",
                        simplified_question: "Blow into which?",
                        options: ["Trumpet", "Piano", "Drum", "Violin"],
                        audio_icons: ["", "", "", ""],
                        correct: 0,
                        explanation: "Yes! You blow into a trumpet!",
                        simplified_explanation: " = blow",
                        points: 10
                    },
                    {   // Question 5
                        type: "quiz",
                        question: "Which one plays high notes? ",
                        simplified_question: "High notes?",
                        options: ["Violin", "Drum", "Guitar", "Piano"],
                        correct: 0,
                        explanation: "Correct! Violins play high sounds.",
                        simplified_explanation: " = high notes",
                        points: 10
                    },
                ],
                dyslexia_tips: [
                    "Associate sounds with visuals",
                    "Use rhythm patterns",
                    "Connect music to movement"
                ],
                currentActivity: 0,
                completed: false
            },
            
            art: { // This modules involves colour combination and general art knowledge
                title: "Art with Mickey Game",
                description: "Create art with Mickey Mouse!",
                activities: [
                    {   // Question 1
                        type: "color_mixing",
                        question: "What color do you get when you mix red and yellow?",
                        simplified_question: "Red + Yellow = ?",
                        color_visuals: [
                            " +  = ",
                            " +  = ",
                            " +  = ",
                            " +  = "
                        ],
                        options: ["Orange", "Green", "Purple", "Blue"],
                        correct: 0,
                        explanation: "Correct! Red + Yellow = Orange!",
                        simplified_explanation: " +  = ",
                        points: 10,
                        hands_on: "Try mixing red and yellow paint!"
                    },
                    {   // Question 2
                        type: "color_mixing",
                        question: "What color comes from blue + red?",
                        simplified_question: "Blue + Red = ?",
                        options: ["Purple", "Green", "Orange", "Pink"],
                        correct: 0,
                        explanation: "Correct! Blue + red = purple!",
                        simplified_explanation: " +  = ",
                        points: 10
                    },
                    {   // Question 3
                        type: "color_mixing",
                        question: "What do you get when you mix yellow and blue?",
                        simplified_question: "Yellow + Blue = ?",
                        options: ["Green", "Purple", "Pink", "Grey"],
                        correct: 0,
                        explanation: "Yes! Blue + yellow = green!",
                        simplified_explanation: " +  = ",
                        points: 10
                    },
                    {   // Question 4
                        type: "quiz",
                        question: "Which tool is used for painting?",
                        simplified_question: "Tool for painting?",
                        options: ["Brush", "Spoon", "Pencil", "Hammer"],
                        visual_aid: "",
                        correct: 0,
                        explanation: "Correct! A brush is used for painting!",
                        simplified_explanation: " = painting",
                        points: 10
                    },
                    {   // Question 5
                        type: "quiz",
                        question: "Which shape has 3 sides?",
                        simplified_question: "3 sides?",
                        options: ["Triangle", "Circle", "Square", "Star"],
                        correct: 0,
                        explanation: "Correct! Triangle has 3 sides!",
                        simplified_explanation: " = 3 sides",
                        points: 10
                    },
                ],
                dyslexia_tips: [
                    "Use color coding",
                    "Visual step-by-step guides",
                    "Hands-on activities"
                ],
                currentActivity: 0,
                completed: false
            },
            
            geography: {
                title: "Pluto's World Tour Game",
                description: "Travel the world with Pluto!",
                activities: [
                    {   // Question 1
                        type: "quiz",
                        question: "Which continent is the largest?",
                        simplified_question: "Biggest continent?",
                        options: ["Asia", "Africa", "Europe", "Australia"],
                        visual_map: " (Asia is the biggest!)",
                        correct: 0,
                        explanation: "Correct! Asia is the largest continent!",
                        simplified_explanation: "Asia = Biggest",
                        points: 10,
                        memory_tip: "Asia has the most people and land!"
                    },
                    {   // Question 2
                        type: "quiz",
                        question: "Which place is very cold?",
                        simplified_question: "Coldest place?",
                        options: ["Arctic", "Desert", "Jungle", "City"],
                        visual_map: "",
                        correct: 0,
                        explanation: "Correct! The Arctic is very cold!",
                        simplified_explanation: "Arctic = cold",
                        points: 10
                    },
                    {   // Question 3
                        type: "quiz",
                        question: "Where do camels live?",
                        simplified_question: "Camels live where?",
                        options: ["Desert", "Ocean", "Forest", "City"],
                        correct: 0,
                        explanation: "Yes! Camels live in the desert!",
                        simplified_explanation: "Camel  desert",
                        points: 10
                    },
                    {   // Question 4
                        type: "quiz",
                        question: "Which one is an ocean?",
                        simplified_question: "Which is ocean?",
                        options: ["Pacific", "Asia", "Paris", "Africa"],
                        correct: 0,
                        explanation: "Correct! Pacific is an ocean!",
                        simplified_explanation: "Pacific = ocean",
                        points: 10
                    },
                    {   // Question 5
                        type: "quiz",
                        question: "Which direction does the sun rise?",
                        simplified_question: "Sun rises where?",
                        options: ["East", "West", "North", "South"],
                        correct: 0,
                        explanation: "Correct! The sun rises in the east!",
                        simplified_explanation: "Sunrise = East",
                        points: 10
                    },
                ],
                dyslexia_tips: [
                    "Use maps and visuals",
                    "Create mental images",
                    "Associate with personal experiences"
                ],
                currentActivity: 0,
                completed: false
            }
        };
        
        // Empathic Agent Configuration
        const empathicAgent = {
            currentEmotion: "neutral",
            previousEmotion: "neutral",
            focusLevel: 75,
            engagementScore: 50,
            lastInteractionTime: Date.now(),
            isCameraActive: false,
            faceDetected: false,
            landmarksDetected: 0,
            emotionConfidence: 0,
            consecutiveNegativeFrames: 0,
            
            // Emotion thresholds for proactive interventions
            emotionThresholds: {
                frustrated: { frames: 3, confidence: 0.6 },
                sad: { frames: 3, confidence: 0.5 },
                bored: { frames: 5, confidence: 0.4 },
                confused: { frames: 3, confidence: 0.5 }
            }
        };
        
        // ============================================
        // MICKEY MOUSE AGENT STATE
        // ============================================
        
        let mickeyAgentVisible = false;
        let breakTimerActive = false;
        let breakTimeLeft = 30; // 30 seconds break
        let breakInterval = null;
        let breathingInterval = null;
        let studentEmotion = 'neutral';
        let frustrationLevel = 0;
        const FRUSTRATION_THRESHOLD = 5;
        
        // Game State
        let currentGame = null;
        let isGameActive = false;  // Add this
        let currentActivityIndex = 0;
        let studentScore = 150;
        let isEasyMode = false;
        
        // ============================================
        // INITIALIZATION FUNCTIONS
        // ============================================
        
        // Initialize everything when page loads
        function initializeAll() {
            console.log(" Initializing Mickey's Learning Hub...");
            
            // Initialize header navigation
            initHeaderNavigation();
            
            // Initialize side toggle
            initSideToggle();
            
            // Initialize movable toolbar
            initMovableToolbar();
            
            // Initialize accessibility functions
            initAccessibilityFunctions();
            
            // Initialize MediaPipe
            initMediaPipeFaceDetection();
            
            // Initialize game functions
            initGameFunctions();
            
            // Initialize agent functions
            initAgentFunctions();
            
            // Initialize camera status indicator
            initCameraStatusIndicator();
            
            // Add Mickey avatar styles
            addMickeyAvatarStyles();
            
            // MAKE ACCESSIBILITY TOOLBAR VISIBLE ON LOAD
            setTimeout(() => {
                const toolbar = document.getElementById('accessibility-toolbar');
                if (toolbar) {
                    toolbar.style.display = 'flex';
                }
            }, 100);
            
            // Start emotion checking (simulated for demo)
            // setTimeout(checkForNegativeEmotion, 5000);
            
            // Show welcome notification
            setTimeout(() => {
                showNotification("Welcome to Mickey's Learning Hub!", "Have fun learning with Mickey!", "info");
            }, 1000);
            
            console.log(" Mickey's Learning Hub initialized successfully!");
        }
        
        // ============================================
        // HEADER NAVIGATION
        // ============================================
        
        function initHeaderNavigation() {
            // Game Center tab (default active)
            document.getElementById('game-tab').addEventListener('click', function(e) {
                e.preventDefault();
                switchContent('game-center');
                setActiveNavTab('game-tab');
            });
            
            // Profile tab
            document.getElementById('profile-tab').addEventListener('click', function(e) {
                e.preventDefault();
                switchContent('profile');
                setActiveNavTab('profile-tab');
            });
            
            // About Us tab
            document.getElementById('about-tab').addEventListener('click', function(e) {
                e.preventDefault();
                switchContent('about');
                setActiveNavTab('about-tab');
            });
            
            // Settings tab
            document.getElementById('settings-tab').addEventListener('click', function(e) {
                e.preventDefault();
                switchContent('settings');
                setActiveNavTab('settings-tab');
            });
        }
        
        function setActiveNavTab(tabId) {
            // Remove active class from all tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Add active class to clicked tab
            const activeTab = document.getElementById(tabId);
            if (activeTab) {
                activeTab.classList.add('active');
            }
        }
        
        function switchContent(contentType) {
            // Hide all content areas
            document.querySelectorAll('.content-area').forEach(area => {
                area.classList.remove('active');
            });

            // If leaving game center and a game is active
            if (contentType !== 'game-center' && currentGame && isCameraStarted) {
                stopCameraDetection();
                currentGame = null;
            }
            
            // Show selected content area
            const targetArea = document.getElementById(`${contentType}-content-area`);
            if (targetArea) {
                targetArea.classList.add('active');
            }
            
            // Close module content if open
            const moduleContent = document.getElementById('module-content');
            if (moduleContent) {
                moduleContent.classList.remove('active');
            }
            
            // Update profile if showing profile
            if (contentType === 'profile') {
                updateProfileDisplay();
            }
            
            // Update settings if showing settings
            if (contentType === 'settings') {
                updateSettingsDisplay();
            }
        }
        
        // ============================================
        // SIDE TOGGLE FUNCTIONS
        // ============================================
        
        function initSideToggle() {
            const sideToggle = document.getElementById('side-toggle');
            const sideBubbles = document.getElementById('side-bubbles');
            let sideOpen = false;
            
            // Toggle side bubbles
            sideToggle.addEventListener('click', function(event) {
                event.stopPropagation();
                sideOpen = !sideOpen;
                
                if (sideOpen) {
                    sideBubbles.classList.add('show');
                    sideToggle.innerHTML = '<i class="fas fa-times"></i>';
                    sideToggle.style.background = 'var(--mickey-blue)';
                } else {
                    sideBubbles.classList.remove('show');
                    sideToggle.innerHTML = '<i class="fas fa-plus"></i>';
                    sideToggle.style.background = 'var(--mickey-red)';
                }
            });
            
            // Initialize bubble click handlers
            initBubbleHandlers();
            
            // Close side bubbles when clicking outside
            document.addEventListener('click', function(event) {
                if (!event.target.closest('#side-collapsible') && sideOpen) {
                    sideBubbles.classList.remove('show');
                    sideOpen = false;
                    sideToggle.innerHTML = '<i class="fas fa-plus"></i>';
                    sideToggle.style.background = 'var(--mickey-red)';
                }
            });
        }
        
        function initBubbleHandlers() {
            // Agent bubble (Mickey Mouse)
            const agentBubble = document.getElementById('side-agent');
            if (agentBubble) {
                agentBubble.addEventListener('click', function() {
                    showMickeyAgent();
                    
                    // Close side bubbles
                    const sideBubbles = document.getElementById('side-bubbles');
                    if (sideBubbles) {
                        sideBubbles.classList.remove('show');
                    }
                    
                    // Reset toggle
                    const sideToggle = document.getElementById('side-toggle');
                    if (sideToggle) {
                        sideToggle.innerHTML = '<i class="fas fa-plus"></i>';
                        sideToggle.style.background = 'var(--mickey-red)';
                    }
                });
            }
            
            // Camera bubble
            const cameraBubble = document.getElementById('side-camera');
            if (cameraBubble) {
                cameraBubble.addEventListener('click', function(event) {
                    event.stopPropagation();
                    
                    // CHECK IF A GAME IS ACTIVE
                    if (!currentGame) {
                        alert("Please start a game first to use camera detection! ");
                        return;
                    }
                    
                    // Close other collapsible contents first
                    document.querySelectorAll('.collapsible-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    // Toggle camera content
                    const cameraContent = document.getElementById('camera-content');
                    if (cameraContent) {
                        cameraContent.classList.add('active');
                        
                        // Auto-start camera detection if not already started
                        if (!isCameraStarted && currentGame) {
                            setTimeout(() => {
                                startRealMediaPipeDetection();
                            }, 500);
                        }
                    }
                    
                    // Close side bubbles
                    const sideBubbles = document.getElementById('side-bubbles');
                    if (sideBubbles) {
                        sideBubbles.classList.remove('show');
                    }
                    
                    // Reset toggle
                    const sideToggle = document.getElementById('side-toggle');
                    if (sideToggle) {
                        sideToggle.innerHTML = '<i class="fas fa-plus"></i>';
                        sideToggle.style.background = 'var(--mickey-red)';
                    }
                });
            }
            
            // Accessibility bubble
            const accessibilityBubble = document.getElementById('side-accessibility');
            if (accessibilityBubble) {
                accessibilityBubble.addEventListener('click', function(event) {
                    event.stopPropagation();
                    
                    // Create or get accessibility content
                    let accessibilityContent = document.getElementById('accessibility-content');
                    
                    if (!accessibilityContent) {
                        // Create new accessibility content panel
                        accessibilityContent = document.createElement('div');
                        accessibilityContent.id = 'accessibility-content';
                        accessibilityContent.className = 'collapsible-content';
                        accessibilityContent.innerHTML = `
                            <button class="collapsible-close-btn" id="close-accessibility-content" title="Close accessibility tools">
                                <i class="fas fa-times"></i>
                            </button>
                            <div style="padding: 10px;">
                                <h3 style="color: var(--mickey-red); margin-bottom: 15px; text-align: center;">
                                    <i class="fas fa-universal-access"></i> Accessibility Tools
                                </h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                                    <button class="accessibility-tool-btn" id="collapsible-dyslexia" title="Dyslexia-friendly mode">
                                        <i class="fas fa-book-reader"></i>
                                        <span>Dyslexia Mode</span>
                                    </button>
                                    <button class="accessibility-tool-btn" id="collapsible-contrast" title="High contrast mode">
                                        <i class="fas fa-adjust"></i>
                                        <span>High Contrast</span>
                                    </button>
                                    <button class="accessibility-tool-btn" id="collapsible-font-plus" title="Increase font size">
                                        <i class="fas fa-text-height"></i>
                                        <span>Bigger Text</span>
                                    </button>
                                    <button class="accessibility-tool-btn" id="collapsible-font-minus" title="Decrease font size">
                                        <i class="fas fa-text-width"></i>
                                        <span>Smaller Text</span>
                                    </button>
                                    <button class="accessibility-tool-btn" id="collapsible-tts" title="Text to speech" style="grid-column: span 2;">
                                        <i class="fas fa-volume-up"></i>
                                        <span>Read Aloud</span>
                                    </button>
                                </div>
                                <div style="background: var(--mickey-yellow); padding: 10px; border-radius: 10px; border: 2px solid var(--mickey-black); margin-top: 10px;">
                                    <p style="margin: 0; color: var(--mickey-black); font-size: 12px; text-align: center;">
                                        <i class="fas fa-info-circle"></i> Tools apply to all content
                                    </p>
                                </div>
                            </div>
                        `;
                        
                        // Add to collapsible controls container
                        const collapsibleControls = document.getElementById('collapsible-controls');
                        if (collapsibleControls) {
                            collapsibleControls.appendChild(accessibilityContent);
                        }
                        
                        // Add close button handler
                        setTimeout(() => {
                            const closeBtn = document.getElementById('close-accessibility-content');
                            if (closeBtn) {
                                closeBtn.addEventListener('click', function(e) {
                                    e.stopPropagation();
                                    accessibilityContent.classList.remove('active');
                                });
                            }
                            
                            // Add button handlers
                            document.getElementById('collapsible-dyslexia').addEventListener('click', function() {
                                document.getElementById('dyslexia-btn').click();
                                this.classList.toggle('active');
                            });
                            
                            document.getElementById('collapsible-contrast').addEventListener('click', function() {
                                document.getElementById('high-contrast-btn').click();
                                this.classList.toggle('active');
                            });
                            
                            document.getElementById('collapsible-font-plus').addEventListener('click', function() {
                                document.getElementById('font-size-btn').click();
                            });
                            
                            document.getElementById('collapsible-font-minus').addEventListener('click', function() {
                                const currentSize = parseFloat(getComputedStyle(document.body).fontSize);
                                document.body.style.fontSize = (currentSize * 0.9) + 'px';
                            });
                            
                            document.getElementById('collapsible-tts').addEventListener('click', function() {
                                document.getElementById('text-to-speech-btn').click();
                            });
                        }, 100);
                    }
                    
                    // Toggle visibility
                    const isActive = accessibilityContent.classList.contains('active');
                    
                    // Close other collapsible contents
                    document.querySelectorAll('.collapsible-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    if (!isActive) {
                        accessibilityContent.classList.add('active');
                        
                        // Position it near the side toggle
                        accessibilityContent.style.top = '60px';
                        accessibilityContent.style.right = '0';
                    }
                    
                    // Close side bubbles
                    const sideBubbles = document.getElementById('side-bubbles');
                    if (sideBubbles) {
                        sideBubbles.classList.remove('show');
                    }
                    
                    // Reset toggle
                    const sideToggle = document.getElementById('side-toggle');
                    if (sideToggle) {
                        sideToggle.innerHTML = '<i class="fas fa-plus"></i>';
                        sideToggle.style.background = 'var(--mickey-red)';
                    }
                });
            }

            const closeCameraBtn = document.getElementById('close-camera-content');
            if (closeCameraBtn) {
                closeCameraBtn.addEventListener('click', function(event) {
                    event.stopPropagation();
                    closeCameraContent();
                });
            }
        }
        
        // ============================================
        // MOVABLE ACCESSIBILITY TOOLBAR
        // ============================================
        
        function initMovableToolbar() {
            const toolbar = document.getElementById('accessibility-toolbar');
            if (!toolbar) return;
            
            let isDragging = false;
            let currentX;
            let currentY;
            let initialX;
            let initialY;
            let xOffset = 0;
            let yOffset = 0;
            
            toolbar.addEventListener('mousedown', dragStart);
            toolbar.addEventListener('touchstart', dragStart);
            
            function dragStart(e) {
                if (e.type === "touchstart") {
                    initialX = e.touches[0].clientX - xOffset;
                    initialY = e.touches[0].clientY - yOffset;
                } else {
                    initialX = e.clientX - xOffset;
                    initialY = e.clientY - yOffset;
                }
                
                if (e.target.classList.contains('accessibility-btn')) {
                    return;
                }
                
                isDragging = true;
                
                document.addEventListener('mousemove', drag);
                document.addEventListener('touchmove', drag);
                document.addEventListener('mouseup', dragEnd);
                document.addEventListener('touchend', dragEnd);
                
                // Add dragging class for visual feedback
                toolbar.style.opacity = '0.9';
                toolbar.style.cursor = 'grabbing';
            }
            
            function drag(e) {
                if (isDragging) {
                    e.preventDefault();
                    
                    if (e.type === "touchmove") {
                        currentX = e.touches[0].clientX - initialX;
                        currentY = e.touches[0].clientY - initialY;
                    } else {
                        currentX = e.clientX - initialX;
                        currentY = e.clientY - initialY;
                    }
                    
                    xOffset = currentX;
                    yOffset = currentY;
                    
                    setTranslate(currentX, currentY, toolbar);
                }
            }
            
            function dragEnd() {
                isDragging = false;
                
                document.removeEventListener('mousemove', drag);
                document.removeEventListener('touchmove', drag);
                document.removeEventListener('mouseup', dragEnd);
                document.removeEventListener('touchend', dragEnd);
                
                // Remove dragging class
                toolbar.style.opacity = '1';
                toolbar.style.cursor = 'move';
                
                // Save position to localStorage
                saveToolbarPosition(currentX, currentY);
            }
            
            function setTranslate(xPos, yPos, el) {
                el.style.transform = `translate3d(${xPos}px, ${yPos}px, 0)`;
                el.style.left = 'auto';
                el.style.right = 'auto';
                el.style.top = 'auto';
                el.style.bottom = 'auto';
            }
            
            function saveToolbarPosition(x, y) {
                localStorage.setItem('toolbarX', x);
                localStorage.setItem('toolbarY', y);
            }
            
            function loadToolbarPosition() {
                const savedX = localStorage.getItem('toolbarX');
                const savedY = localStorage.getItem('toolbarY');
                
                if (savedX !== null && savedY !== null) {
                    xOffset = parseInt(savedX);
                    yOffset = parseInt(savedY);
                    setTranslate(xOffset, yOffset, toolbar);
                } else {
                    // Default position
                    xOffset = -100;
                    yOffset = 0;
                    setTranslate(xOffset, yOffset, toolbar);
                }
            }
            
            // Load saved position on init
            loadToolbarPosition();
        }
        
        // ============================================
        // ACCESSIBILITY FUNCTIONS
        // ============================================
        
        function initAccessibilityFunctions() {
            // Dyslexia mode
            const dyslexiaBtn = document.getElementById('dyslexia-btn');
            if (dyslexiaBtn) {
                dyslexiaBtn.addEventListener('click', function() {
                    document.body.classList.toggle('dyslexia-mode');
                    this.classList.toggle('active');
                });
            }
            
            // High contrast mode
            const contrastBtn = document.getElementById('high-contrast-btn');
            if (contrastBtn) {
                contrastBtn.addEventListener('click', function() {
                    document.body.style.filter = document.body.style.filter === 'contrast(150%)' ? 'none' : 'contrast(150%)';
                    this.classList.toggle('active');
                });
            }
            
            // Font size
            const fontSizeBtn = document.getElementById('font-size-btn');
            if (fontSizeBtn) {
                fontSizeBtn.addEventListener('click', function() {
                    const currentSize = parseFloat(getComputedStyle(document.body).fontSize);
                    document.body.style.fontSize = (currentSize * 1.1) + 'px';
                });
            }
            
            // Text to speech
            const ttsBtn = document.getElementById('text-to-speech-btn');
            if (ttsBtn) {
                ttsBtn.addEventListener('click', function() {
                    if ('speechSynthesis' in window) {
                        const text = document.querySelector('.content-area.active').textContent;
                        const utterance = new SpeechSynthesisUtterance(text.substring(0, 200));
                        speechSynthesis.speak(utterance);
                    }
                });
            }
            
            // Settings page buttons
            const settingsDyslexiaBtn = document.getElementById('toggle-dyslexia');
            if (settingsDyslexiaBtn) {
                settingsDyslexiaBtn.addEventListener('click', function() {
                    dyslexiaBtn.click();
                    this.innerHTML = `<i class="fas fa-toggle-${document.body.classList.contains('dyslexia-mode') ? 'on' : 'off'}"></i> Dyslexia Mode ${document.body.classList.contains('dyslexia-mode') ? 'ON' : 'OFF'}`;
                });
            }
            
            const settingsContrastBtn = document.getElementById('toggle-contrast');
            if (settingsContrastBtn) {
                settingsContrastBtn.addEventListener('click', function() {
                    contrastBtn.click();
                    this.innerHTML = `<i class="fas fa-toggle-${contrastBtn.classList.contains('active') ? 'on' : 'off'}"></i> High Contrast ${contrastBtn.classList.contains('active') ? 'ON' : 'OFF'}`;
                });
            }
            
            const increaseFontBtn = document.getElementById('increase-font');
            if (increaseFontBtn) {
                increaseFontBtn.addEventListener('click', function() {
                    const currentSize = parseFloat(getComputedStyle(document.body).fontSize);
                    document.body.style.fontSize = (currentSize * 1.1) + 'px';
                });
            }
            
            const decreaseFontBtn = document.getElementById('decrease-font');
            if (decreaseFontBtn) {
                decreaseFontBtn.addEventListener('click', function() {
                    const currentSize = parseFloat(getComputedStyle(document.body).fontSize);
                    document.body.style.fontSize = (currentSize * 0.9) + 'px';
                });
            }
        }
        
        // ============================================
        // MICKEY MOUSE AGENT FUNCTIONS
        // ============================================
        
        function initAgentFunctions() {
            // Agent minimize
            const minimizeBtn = document.getElementById('agent-minimize');
            if (minimizeBtn) {
                minimizeBtn.addEventListener('click', function() {
                    document.getElementById('empathic-agent').style.display = 'none';
                    mickeyAgentVisible = false;
                });
            }
            
            // Close intervention
            const closeInterventionBtn = document.getElementById('close-intervention');
            if (closeInterventionBtn) {
                closeInterventionBtn.addEventListener('click', function() {
                    document.getElementById('intervention-modal').style.display = 'none';
                    addMickeyMessage("Glad you're okay! Let's continue! ");
                });
            }
        }
        
        // Show Mickey Mouse Agent
        function showMickeyAgent() {
            const agentContainer = document.getElementById('empathic-agent');
            if (!agentContainer) return;
            
            // Update agent messages
            const messagesContainer = document.getElementById('agent-messages');
            if (messagesContainer && messagesContainer.children.length === 0) {
                addMickeyMessage("Hi there! I'm Mickey! ");
                addMickeyMessage("I notice when you're feeling frustrated or need help!");
                addMickeyMessage("When I pop up, I'll give you options to feel better!");
            }
            
            // Show agent
            agentContainer.style.display = 'block';
            mickeyAgentVisible = true;
        }
        
        // Add message from Mickey
        function addMickeyMessage(text) {
            const messagesContainer = document.getElementById('agent-messages');
            if (!messagesContainer) return;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'agent-message bot';
            messageDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="width: 30px; height: 30px; background: var(--mickey-red); border-radius: 50%; 
                               border: 2px solid var(--mickey-black); display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-mouse-pointer" style="color: white; font-size: 12px;"></i>
                    </div>
                    <div>${text}</div>
                </div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // Check for negative emotion and trigger Mickey
        function checkForNegativeEmotion() {
            // ONLY check emotions if a game is active and camera detection is running
            if (!currentGame || !isCameraStarted) {
                // No game active, skip emotion checking
                setTimeout(checkForNegativeEmotion, 10000);
                return;
            }
            
            // Only simulate emotion detection if MediaPipe isn't providing real data
            if (!empathicAgent.faceDetected) {
                // Simulate emotion detection (fallback)
                const emotions = ['happy', 'neutral', 'frustrated', 'confused', 'bored', 'sad'];
                const randomEmotion = emotions[Math.floor(Math.random() * emotions.length)];
                studentEmotion = randomEmotion;
            } else {
                // Use real emotion from MediaPipe detection
                studentEmotion = empathicAgent.currentEmotion;
            }
            
            // Increase frustration for negative emotions
            if (['frustrated', 'confused', 'bored', 'sad'].includes(studentEmotion)) {
                frustrationLevel++;
                
                // Trigger Mickey if frustration threshold reached AND game is active
                if (frustrationLevel >= FRUSTRATION_THRESHOLD && !mickeyAgentVisible && !breakTimerActive && currentGame) {
                    triggerMickeyIntervention(studentEmotion);
                    frustrationLevel = 0; // Reset after intervention
                }
            } else {
                frustrationLevel = Math.max(0, frustrationLevel - 1);
            }
            
            // Check every 10 seconds
            setTimeout(checkForNegativeEmotion, 10000);
        }
        
        // Trigger Mickey Mouse intervention
        function triggerMickeyIntervention(emotion) {
            // Show Mickey agent
            showMickeyAgent();
            
            // Create intervention modal
            showInterventionModal(emotion);
        }
        
        // Show intervention modal
        function showInterventionModal(emotion) {
            const modal = document.getElementById('intervention-modal');
            const title = document.getElementById('intervention-title');
            const optionsContainer = document.getElementById('intervention-options');
            
            const titles = {
                frustrated: "You seem frustrated with this question...",
                sad: "I notice you're feeling a bit down...",
                bored: "This might not be engaging enough...",
                confused: "This seems confusing..."
            };
            
            title.textContent = titles[emotion] || "I notice you might need help!";
            optionsContainer.innerHTML = '';
            
            const options = [
                { type: "break", text: "Take a 30-second break", icon: "fa-coffee" },
                { type: "easier", text: "Make questions easier", icon: "fa-thumbs-up" },
                { type: "dyslexia", text: "Enable dyslexia tools", icon: "fa-universal-access" }, // NEW
                { type: "next", text: "Skip to next question", icon: "fa-forward" },
                { type: "help", text: "Explain this differently", icon: "fa-question-circle" }
            ];
            
            options.forEach(option => {
                const button = document.createElement('button');
                button.className = `intervention-btn ${option.type === 'break' ? 'break' : option.type === 'easier' ? 'easy' : option.type === 'next' ? 'next' : ''}`;
                button.innerHTML = `
                    <i class="fas ${option.icon}"></i>
                    ${option.text}
                `;
                button.onclick = () => handleInterventionChoice(option.type);
                optionsContainer.appendChild(button);
            });
            
            modal.style.display = 'block';
            addMickeyMessage(`I noticed you might be feeling ${emotion}. I've popped up some options to help! `);
        }
        
        // Handle intervention choice
        function handleInterventionChoice(choice) {
            const modal = document.getElementById('intervention-modal');
            modal.style.display = 'none';
            
            switch(choice) {
                case 'break':
                    startMickeyBreak();
                    break;
                case 'easier':
                    makeGameEasier();
                    break;
                case 'dyslexia': // NEW
                    enableAllDyslexiaTools();
                    break;
                case 'next':
                    skipToNext();
                    break;
                case 'help':
                    explainDifferently();
                    break;
            }
            
            frustrationLevel = 0;
        }
        
        // ============================================
        // BREAK TIMER FUNCTIONS
        // ============================================
        
        // Start 30-second break
        function startMickeyBreak() {
            // Close intervention modal
            document.getElementById('intervention-modal').style.display = 'none';
            
            // Hide Mickey agent
            document.getElementById('empathic-agent').style.display = 'none';
            mickeyAgentVisible = false;
            
            // Show break timer
            const breakTimer = document.getElementById('break-timer');
            breakTimer.classList.add('show');
            
            // Start timer
            breakTimerActive = true;
            breakTimeLeft = 30;
            updateBreakTimer();
            
            breakInterval = setInterval(() => {
                breakTimeLeft--;
                updateBreakTimer();
                
                if (breakTimeLeft <= 0) {
                    endMickeyBreak();
                }
            }, 1000);
            
            // Start breathing animation
            startBreathingAnimation();
            
            addMickeyMessage("Great idea! Let's take a short break. Relax and come back refreshed! ");
        }
        
        // Update break timer display
        function updateBreakTimer() {
            const timerDisplay = document.getElementById('timer-display');
            if (timerDisplay) {
                const minutes = Math.floor(breakTimeLeft / 60);
                const seconds = breakTimeLeft % 60;
                timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }
        
        // Breathing animation during break
        function startBreathingAnimation() {
            const breathingText = document.getElementById('breathing-animation');
            if (!breathingText) return;
            
            let phase = 'in';
            let count = 4;
            
            clearInterval(breathingInterval);
            
            breathingInterval = setInterval(() => {
                if (count === 0) {
                    phase = phase === 'in' ? 'hold' : phase === 'hold' ? 'out' : 'in';
                    count = phase === 'in' ? 4 : phase === 'hold' ? 4 : 6;
                }
                
                let text = '';
                let emoji = '';
                
                switch(phase) {
                    case 'in':
                        text = `Breathe IN... (${count} seconds)`;
                        emoji = '';
                        break;
                    case 'hold':
                        text = `Hold... (${count} seconds)`;
                        emoji = '';
                        break;
                    case 'out':
                        text = `Breathe OUT... (${count} seconds)`;
                        emoji = '';
                        break;
                }
                
                breathingText.innerHTML = `${emoji} ${text}`;
                count--;
                
                // Clear interval if break ended
                if (!breakTimerActive) {
                    clearInterval(breathingInterval);
                }
            }, 1000);
        }
        
        // End break
        function endMickeyBreak() {
            breakTimerActive = false;
            clearInterval(breakInterval);
            clearInterval(breathingInterval);
            
            // Hide break timer
            const breakTimer = document.getElementById('break-timer');
            breakTimer.classList.remove('show');
            
            // Show Mickey with encouragement
            setTimeout(() => {
                showMickeyAgent();
                addMickeyMessage("Break time's over! Ready to continue? ");
                addMickeyMessage("You're doing great! Let's get back to it! ");
            }, 500);
        }
        
        function enableAllDyslexiaTools() {
            toggleDyslexiaText(currentGame);
            enableColorOverlay(currentGame);
            showNotification("Dyslexia Tools", "All dyslexia support tools have been enabled", "success");
        }

        // Game helper functions
        function makeGameEasier() {
            isEasyMode = true;
            addMickeyMessage("I'll make the questions easier for you! ");
            if (currentGame) {
                document.getElementById('module-content-body').innerHTML = generateGameActivity(currentGame, currentActivityIndex);
            }
        }
        
        function skipToNext() {
            if (currentGame && currentActivityIndex < learningGames[currentGame].activities.length - 1) {
                currentActivityIndex++;
                document.getElementById('module-content-body').innerHTML = generateGameActivity(currentGame, currentActivityIndex);
                frustrationLevel = 0;
                addMickeyMessage("Let's skip to the next activity! ");
            }
        }
        
        function explainDifferently() {
            addMickeyMessage("Let me explain this in a different way! ");
            // Add explanation logic here
        }

        // ============================================
        // PROFILE FUNCTIONS
        // ============================================
        
        function updateProfileDisplay() {
            // Update points
            document.getElementById('student-points').textContent = studentScore;
            document.getElementById('profile-focus-level').textContent = empathicAgent.focusLevel;
            
            // Update progress
            const completedGames = Object.values(learningGames).filter(g => g.completed).length;
            const totalGames = Object.keys(learningGames).length;
            const progressPercent = (completedGames / totalGames) * 100;
            document.getElementById('overall-progress').style.width = `${progressPercent}%`;
        }
        
        function updateSettingsDisplay() {
            // Update camera status
            document.getElementById('detection-status').textContent = isCameraStarted ? 'ACTIVE' : 'INACTIVE';
            document.getElementById('detection-status').style.color = isCameraStarted ? '#00cc00' : 'var(--mickey-red)';
            
            // Update dyslexia mode button
            const dyslexiaBtn = document.getElementById('toggle-dyslexia');
            if (dyslexiaBtn) {
                dyslexiaBtn.innerHTML = `<i class="fas fa-toggle-${document.body.classList.contains('dyslexia-mode') ? 'on' : 'off'}"></i> Dyslexia Mode ${document.body.classList.contains('dyslexia-mode') ? 'ON' : 'OFF'}`;
            }
            
            // Update high contrast button
            const contrastBtn = document.getElementById('toggle-contrast');
            if (contrastBtn) {
                const highContrastBtn = document.getElementById('high-contrast-btn');
                contrastBtn.innerHTML = `<i class="fas fa-toggle-${highContrastBtn.classList.contains('active') ? 'on' : 'off'}"></i> High Contrast ${highContrastBtn.classList.contains('active') ? 'ON' : 'OFF'}`;
            }
        }
        
        // ============================================
        // GAME FUNCTIONS
        // ============================================
        
        function initGameFunctions() {
            // Start face detection button
            const startFaceDetectionBtn = document.getElementById('start-face-detection');
            if (startFaceDetectionBtn) {
                startFaceDetectionBtn.addEventListener('click', startRealMediaPipeDetection);
            }
            
            // In initGameFunctions() - modify settings camera button
            const settingsCameraBtn = document.getElementById('settings-start-camera');
            if (settingsCameraBtn) {
                settingsCameraBtn.addEventListener('click', function() {
                    // Only start if a game is active
                    if (currentGame) {
                        startRealMediaPipeDetection();
                    } else {
                        alert("Please start a game first to use camera detection! ");
                    }
                });
            }
            
            // Close module
            const closeModuleBtn = document.getElementById('close-module');
            if (closeModuleBtn) {
                closeModuleBtn.addEventListener('click', closeModule);
            }
        }
        
        function startGame(gameName) {
            currentGame = gameName;
            const game = learningGames[gameName];
            currentActivityIndex = 0;
            
            // ONLY START CAMERA WHEN GAME STARTS
            if (!isCameraStarted) {
                startRealMediaPipeDetection();
            }
            
            // Update UI
            document.getElementById('module-content-title').textContent = game.title;
            document.getElementById('module-content-body').innerHTML = generateGameActivity(gameName, 0);
            document.getElementById('module-content').classList.add('active');
            
            // Show Mickey agent
            showMickeyAgent();
            
            // START emotion checking when game begins
            frustrationLevel = 0; // Reset frustration
            setTimeout(checkForNegativeEmotion, 5000);
            
            console.log(` Starting ${game.title} - Camera auto-started: ${isCameraStarted}`);
        }
        
        function viewModule(moduleName) {
            const game = learningGames[moduleName];
            document.getElementById('module-content-title').textContent = `${game.title} - Information`;
            document.getElementById('module-content-body').innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 4rem; color: var(--mickey-yellow); margin-bottom: 20px;">
                        <i class="fas fa-info-circle"></i>
                    </div>
                    <h3 style="color: var(--mickey-blue);">${game.description}</h3>
                    <div style="background: var(--mickey-white); padding: 25px; border-radius: 20px; border: 4px solid var(--mickey-black); margin: 30px auto; max-width: 600px;">
                        <h4 style="color: var(--mickey-red);">Enhanced Features:</h4>
                        <ul style="text-align: left; color: var(--mickey-black); font-family: 'Comic Neue', cursive; font-size: 1.1rem;">
                            <li> <strong>468-point facial landmark detection</strong></li>
                            <li> <strong>Multiple landmark emotion scoring system</strong></li>
                            <li> <strong>Real-time temporal smoothing</strong></li>
                            <li> <strong>Enhanced smile/frown detection</strong></li>
                            <li> <strong>Brow asymmetry analysis</strong></li>
                            <li> <strong>Eye squint detection</strong></li>
                            <li> <strong>Head tilt analysis</strong></li>
                            <li> <strong>Proactive interventions</strong></li>
                        </ul>
                    </div>
                    <div style="margin-top: 30px;">
                        <button class="module-btn start-btn" onclick="startGame('${moduleName}')" 
                                style="padding: 15px 30px; font-size: 1.2rem;">
                            <i class="fas fa-play"></i> Play Game Now!
                        </button>
                    </div>
                </div>
            `;
            document.getElementById('module-content').classList.add('active');
        }
        
        function generateGameActivity(gameName, activityIndex) {
            const game = learningGames[gameName];
            const activity = game.activities[activityIndex];
            
            const easyClass = isEasyMode ? 'easy-mode' : '';
            
            let contentHTML = '';
            
            // DYSLEXIA-FRIENDLY CONTENT GENERATION
            if (activity.type === "quiz") {
                const questionText = isEasyMode ? (activity.simplified_question || activity.question) : activity.question;
                const optionsList = isEasyMode ? (activity.options || activity.options_full) : activity.options_full;
                
                contentHTML = `
                    <div class="game-container ${easyClass}">
                        <div class="game-counter">
                            Activity ${activityIndex + 1} of ${game.activities.length}
                            ${isEasyMode ? '<span style="color: #00cc00; margin-left: 10px;"><i class="fas fa-child"></i> Simple Mode</span>' : ''}
                        </div>
                        
                        <!-- DYSLEXIA SUPPORT HEADER -->
                        <div class="dyslexia-support-header" style="background: #e6f7ff; padding: 15px; border-radius: 15px; border: 3px solid var(--mickey-blue); margin-bottom: 20px;">
                            <div style="display: flex; align-items: center; gap: 10px; color: var(--mickey-blue);">
                                <i class="fas fa-lightbulb"></i>
                                <strong>Dyslexia Tips for this activity:</strong>
                            </div>
                            <ul style="margin: 10px 0 0 20px; color: var(--mickey-black); font-family: 'OpenDyslexic', sans-serif; font-size: 0.9em;">
                                ${game.dyslexia_tips.map(tip => `<li>${tip}</li>`).join('')}
                            </ul>
                        </div>
                        
                        <div class="game-question">
                            <i class="fas fa-question-circle" style="color: var(--mickey-red); margin-right: 10px;"></i>
                            ${questionText}
                            
                            ${activity.visual_aid ? `
                                <div style="margin-top: 15px; font-size: 1.5rem; text-align: center;">
                                    ${activity.visual_aid}
                                </div>
                            ` : ''}
                            
                            ${activity.visual_options ? `
                                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 20px; font-size: 2rem;">
                                    ${activity.visual_options.join(' ')}
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="game-options">
                            ${optionsList.map((option, index) => `
                                <div class="game-option" onclick="checkAnswer(${index}, '${gameName}')">
                                    ${option}
                                    ${activity.audio_icons ? `<div style="margin-top: 5px; font-size: 1.2rem;">${activity.audio_icons[index]}</div>` : ''}
                                    ${activity.color_visuals ? `<div style="margin-top: 5px; font-size: 1.5rem;">${activity.color_visuals[index]}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                        
                        <!-- MULTI-SENSORY SUPPORT -->
                        <div class="multi-sensory-support" style="background: #fff9e6; padding: 15px; border-radius: 15px; border: 3px solid var(--mickey-yellow); margin-top: 20px;">
                            <div style="display: flex; align-items: center; gap: 10px; color: var(--mickey-red);">
                                <i class="fas fa-hand-sparkles"></i>
                                <strong>Multi-Sensory Learning:</strong>
                            </div>
                            <div style="display: flex; justify-content: space-around; margin-top: 10px; flex-wrap: wrap;">
                                <button class="sensory-btn" onclick="readQuestionAloud()" title="Listen to question">
                                    <i class="fas fa-volume-up"></i> Listen
                                </button>
                                <button class="sensory-btn" onclick="showVisualClue('${gameName}', ${activityIndex})" title="Visual clue">
                                    <i class="fas fa-eye"></i> See
                                </button>
                                <button class="sensory-btn" onclick="tapToCount()" title="Tap to count">
                                    <i class="fas fa-hand-point-up"></i> Tap
                                </button>
                                <button class="sensory-btn" onclick="breakItDown('${gameName}', ${activityIndex})" title="Break it down">
                                    <i class="fas fa-puzzle-piece"></i> Steps
                                </button>
                                <button onclick="readQuestionAloud()" class="sensory-btn" title="Read question aloud">
                                    <i class="fas fa-volume-up"></i> Read Aloud
                                </button>
                                <button onclick="toggleDyslexiaText()" class="sensory-btn" title="Toggle dyslexia-friendly font">
                                    <i class="fas fa-font"></i> Easy Font
                                </button>
                                <button onclick="enableColorOverlay()" class="sensory-btn" title="Change color overlay">
                                    <i class="fas fa-highlighter"></i> Color Overlay
                                </button>
                                <button onclick="enableLineReader()" class="sensory-btn" title="Enable line reader">
                                    <i class="fas fa-text-width"></i> Line Reader
                                </button>
                                <button onclick="simplifyText()" class="sensory-btn" title="Simplify text">
                                    <i class="fas fa-child"></i> Simplify
                                </button>
                            </div>
                        </div>
                        
                        <div class="game-feedback" id="game-feedback"></div>
                        <div class="game-progress">
                            <div class="progress-bar" id="game-progress" 
                                style="width: ${((activityIndex + 1) / game.activities.length) * 100}%"></div>
                            <div class="progress-text">
                                ${activityIndex + 1} of ${game.activities.length} activities completed
                            </div>
                        </div>
                        <div class="game-navigation">
                            <button class="nav-btn" ${activityIndex === 0 ? 'disabled' : ''} 
                                    onclick="previousActivity('${gameName}')">
                                <i class="fas fa-arrow-left"></i> Previous
                            </button>
                            <button class="nav-btn" onclick="nextActivity('${gameName}')" 
                                    ${activityIndex === game.activities.length - 1 ? 'disabled' : ''}>
                                Next <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                `;
            } else if (activity.type === "story") {
                // DYSLEXIA-FRIENDLY STORY FORMAT
                const storyText = isEasyMode ? activity.simplified_story : activity.story;
                
                contentHTML = `
                    <div class="game-container ${easyClass}">
                        <div class="game-counter">
                            Story ${activityIndex + 1} of ${game.activities.length}
                            ${isEasyMode ? '<span style="color: #00cc00; margin-left: 10px;"><i class="fas fa-child"></i> Simple Story</span>' : ''}
                        </div>
                        
                        <div class="dyslexia-story-container" style="background: white; padding: 25px; border-radius: 20px; border: 4px solid var(--mickey-blue); margin-bottom: 25px;">
                            <h3 style="color: var(--mickey-red); text-align: center; margin-bottom: 20px;">
                                ${activity.title}
                            </h3>
                            
                            <!-- DYSLEXIA-FRIENDLY STORY TEXT -->
                            <div class="dyslexia-story-text" style="font-family: 'OpenDyslexic', sans-serif; line-height: 2; font-size: 1.2em; color: #000; padding: 20px; background: #f9f9f9; border-radius: 15px; border-left: 5px solid var(--mickey-red);">
                                ${storyText.split('.').map(sentence => `
                                    <div class="sentence-block" style="margin-bottom: 20px; padding: 10px; background: white; border-radius: 10px; border: 2px solid #e0e0e0;">
                                        ${sentence.trim()}.
                                    </div>
                                `).join('')}
                            </div>
                            
                            <!-- READING SUPPORT TOOLS -->
                            <div class="reading-tools" style="margin-top: 25px; padding: 15px; background: #e6f7ff; border-radius: 15px; border: 3px solid var(--mickey-blue);">
                                <div style="display: flex; justify-content: space-around; flex-wrap: wrap; gap: 10px;">
                                    <button class="reading-tool-btn" onclick="readStoryAloud('${storyText}')">
                                        <i class="fas fa-volume-up"></i> Read Story
                                    </button>
                                    <button class="reading-tool-btn" onclick="highlightSentence()">
                                        <i class="fas fa-highlighter"></i> Line Reader
                                    </button>
                                    <button class="reading-tool-btn" onclick="increaseSpacing()">
                                        <i class="fas fa-text-width"></i> More Space
                                    </button>
                                    <button class="reading-tool-btn" onclick="showPictureClues()">
                                        <i class="fas fa-images"></i> Pictures
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- STORY QUESTIONS -->
                        <div class="story-questions">
                            ${activity.questions.map((q, qIndex) => `
                                <div class="story-question" style="background: var(--mickey-yellow); padding: 20px; border-radius: 15px; border: 3px solid var(--mickey-black); margin-bottom: 20px;">
                                    <div class="question-text" style="color: var(--mickey-black); font-family: 'OpenDyslexic', sans-serif; font-size: 1.1em; margin-bottom: 15px;">
                                        <i class="fas fa-question"></i>
                                        ${isEasyMode ? q.simplified_question : q.question}
                                    </div>
                                    ${q.visual_aid ? `
                                        <div style="text-align: center; font-size: 2rem; margin-bottom: 15px;">
                                            ${q.visual_aid}
                                        </div>
                                    ` : ''}
                                    <div class="question-options" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                        ${q.options.map((option, optIndex) => `
                                            <button class="story-option" onclick="answerStoryQuestion(${qIndex}, ${optIndex}, '${gameName}')"
                                                    style="padding: 12px; background: white; border: 3px solid var(--mickey-black); border-radius: 10px; cursor: pointer; font-family: 'OpenDyslexic', sans-serif;">
                                                ${option}
                                            </button>
                                        `).join('')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="game-progress">
                            <div class="progress-bar" id="game-progress" 
                                style="width: ${((activityIndex + 1) / game.activities.length) * 100}%"></div>
                            <div class="progress-text">
                                Story ${activityIndex + 1} of ${game.activities.length}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            return contentHTML;
        }

function checkAnswer(answerIndex, gameName) {
    const game = learningGames[gameName];
    const activity = game.activities[currentActivityIndex];
    const feedback = document.getElementById('game-feedback');
    const options = document.querySelectorAll('.game-option');
    
    options.forEach(opt => {
        opt.classList.remove('correct', 'wrong');
    });
    
    if (answerIndex === activity.correct) {
        // Correct answer
        options[answerIndex].classList.add('correct');
        
        const explanation = isEasyMode ? (activity.simplified_explanation || activity.explanation) : activity.explanation;
        
        feedback.innerHTML = `
            <div style="display: flex; align-items: center; gap: 15px;">
                <i class="fas fa-check-circle" style="color: #00cc00; font-size: 2rem;"></i>
                <div>
                    <strong style="color: #00cc00; font-family: 'OpenDyslexic', sans-serif;">Oh boy! Correct!</strong>
                    <p style="margin: 5px 0; color: var(--mickey-white); font-family: 'OpenDyslexic', sans-serif;">${explanation}</p>
                    ${activity.visual_aid ? `
                        <div style="font-size: 1.5rem; margin: 10px 0; text-align: center;">
                            ${activity.visual_aid}
                        </div>
                    ` : ''}
                    <p style="margin: 5px 0; color: var(--mickey-yellow);">
                        <i class="fas fa-star"></i> +${activity.points} Mickey Points!
                    </p>
                </div>
            </div>
        `;
        
        // Award points
        studentScore += activity.points;
        document.getElementById('student-points').textContent = studentScore;
        
        // Positive emotional feedback
        studentEmotion = "happy";
        frustrationLevel = 0;
        
        // Play success sound if available
        playSuccessSound();
        
        // Auto-advance
        setTimeout(() => {
            if (currentActivityIndex < game.activities.length - 1) {
                nextActivity(gameName);
            } else {
                completeGame(gameName);
            }
        }, 2500);
        
    } else {
        // Wrong answer - DYSLEXIA-FRIENDLY FEEDBACK
        options[answerIndex].classList.add('wrong');
        options[activity.correct].classList.add('correct');
        
        const correctAnswer = isEasyMode ? 
            (activity.options ? activity.options[activity.correct] : activity.options_full[activity.correct]) : 
            activity.options_full[activity.correct];
        
        feedback.innerHTML = `
            <div style="display: flex; align-items: center; gap: 15px;">
                <i class="fas fa-times-circle" style="color: #ff3333; font-size: 2rem;"></i>
                <div>
                    <strong style="color: #ff3333; font-family: 'OpenDyslexic', sans-serif;">Let's try again!</strong>
                    <p style="margin: 5px 0; color: var(--mickey-white); font-family: 'OpenDyslexic', sans-serif;">
                        The correct answer is: ${correctAnswer}
                    </p>
                    <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 10px; margin: 10px 0;">
                        <div style="color: var(--mickey-yellow); font-family: 'OpenDyslexic', sans-serif;">
                            <i class="fas fa-lightbulb"></i> <strong>Dyslexia Tip:</strong>
                        </div>
                        <div style="color: white; font-size: 0.9em; margin-top: 5px;">
                            ${getDyslexiaTip(gameName)}
                        </div>
                    </div>
                    ${activity.mnemonic ? `
                        <div style="background: rgba(255,255,255,0.3); padding: 10px; border-radius: 10px; margin: 10px 0; text-align: center;">
                            <div style="color: var(--mickey-yellow);">Memory Aid:</div>
                            <div style="color: white; font-family: 'OpenDyslexic', sans-serif;">${activity.mnemonic}</div>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
        
        // Negative emotional feedback (but with support)
        studentEmotion = "confused";
        frustrationLevel++;
        
        // Check for intervention
        if (frustrationLevel >= FRUSTRATION_THRESHOLD) {
            triggerMickeyIntervention("confused");
        }
    }
    
    feedback.classList.add('show');
}

function getDyslexiaTip(gameName) {
    const tips = {
        math: "Use your fingers to count. Draw pictures of the problem.",
        reading: "Break long words into smaller parts. Sound them out slowly.",
        science: "Create a mental picture. Draw diagrams to help remember.",
        music: "Hum the sound first. Associate it with something familiar.",
        art: "Use color coding. Create patterns to remember combinations.",
        geography: "Draw a simple map. Create a story about the place."
    };
    
    return tips[gameName] || "Take your time. Read carefully. Use all your senses to learn.";
}

        function playSuccessSound() {
            // Create a simple success sound using the Web Audio API
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
                oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // E5
                oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2); // G5
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (e) {
                console.log("Audio not supported");
            }
        }
        
        function nextActivity(gameName) {
            if (currentActivityIndex < learningGames[gameName].activities.length - 1) {
                currentActivityIndex++;
                document.getElementById('module-content-body').innerHTML = generateGameActivity(gameName, currentActivityIndex);
                frustrationLevel = 0;
            }
        }
        
        function previousActivity(gameName) {
            if (currentActivityIndex > 0) {
                currentActivityIndex--;
                document.getElementById('module-content-body').innerHTML = generateGameActivity(gameName, currentActivityIndex);
                frustrationLevel = 0;
            }
        }
        
        function completeGame(gameName) {
            const game = learningGames[gameName];
            game.completed = true;
            
            const totalPoints = game.activities.reduce((sum, activity) => sum + activity.points, 0);
            
            // Add this line - STOP CAMERA WHEN GAME COMPLETES
            stopCameraDetection();
            
            document.getElementById('module-content-body').innerHTML = `
                <div style="text-align: center; padding: 60px 40px;">
                    <div style="font-size: 6rem; color: var(--mickey-yellow); margin-bottom: 30px;">
                        <i class="fas fa-trophy"></i>
                    </div>
                    <h2 style="color: var(--mickey-red);">Congratulations!</h2>
                    <p style="color: var(--mickey-blue); font-family: 'Comic Neue', cursive; font-size: 1.3rem;">
                        You've completed ${game.title}!
                    </p>
                    <div style="background: var(--mickey-yellow); padding: 25px; border-radius: 20px; 
                                border: 4px solid var(--mickey-black); margin: 30px auto; max-width: 400px;">
                        <h3 style="color: var(--mickey-black); margin: 0 0 15px 0;">
                            <i class="fas fa-star"></i> You earned ${totalPoints} Mickey Points!
                        </h3>
                        <p style="color: var(--mickey-red); font-size: 1.2rem;">
                            Total Score: <strong>${studentScore}</strong> points
                        </p>
                    </div>
                    <button class="module-btn start-btn" onclick="closeModule()" style="padding: 15px 30px;">
                        <i class="fas fa-check"></i> Great Job! Play Another Game
                    </button>
                </div>
            `;
            
            // Update progress
            updateProfileDisplay();
            
            // Celebration message
            setTimeout(() => {
                addMickeyMessage(" WOW! You completed the game! I'm so proud of you! ");
            }, 1500);
        }
        
        // New function to close module and stop camera
        function closeModuleAndStopCamera() {
            // Stop camera detection since game is ending
            stopCameraDetection();
            
            // Close module
            closeModule();
        }

        function closeModule() {
            // STOP CAMERA WHEN MODULE IS CLOSED
            if (currentGame && isCameraStarted) {
                stopCameraDetection();
            }
            
            // Reset frustration level since game ended
            frustrationLevel = 0;
            studentEmotion = 'neutral';
            
            document.getElementById('module-content').classList.remove('active');
            document.getElementById('status-text').innerHTML = 
                `<span style="color: var(--mickey-blue);">Ready for more learning fun!</span>`;
            
            // Reset current game
            currentGame = null;
        }

        // ============================================
        // EMPATHIC AGENT FUNCTIONS
        // ============================================
        
        function checkForProactiveIntervention() {
            const threshold = empathicAgent.emotionThresholds[empathicAgent.currentEmotion];
            
            if (threshold && 
                empathicAgent.consecutiveNegativeFrames >= threshold.frames && 
                empathicAgent.emotionConfidence >= threshold.confidence) {
                
                const timeSinceLast = Date.now() - empathicAgent.lastInteractionTime;
                if (timeSinceLast > 10000) {
                    triggerProactiveIntervention(empathicAgent.currentEmotion);
                    empathicAgent.lastInteractionTime = Date.now();
                }
            }
        }
        
        // This function triggers proactive interventions when negative emotions are detected
        function triggerProactiveIntervention(emotion) {
            console.log(` Proactive intervention for: ${emotion}`);
            
            // Just call your existing Mickey intervention system
            triggerMickeyIntervention(emotion);
            
            // Reset counters so we don't trigger again immediately
            empathicAgent.consecutiveNegativeFrames = 0;
            empathicAgent.lastInteractionTime = Date.now();
        }

        // ============================================
        // MEDIAPIPE FACE DETECTION FUNCTIONS
        // ============================================
        
        // Initialize MediaPipe
        function initMediaPipeFaceDetection() {
            console.log(" Initializing Google MediaPipe Face Detection...");
            
            // Set up Face Mesh results handler
            faceMesh.onResults((results) => {
                // Draw video frame
                canvasCtx.save();
                canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
                
                // Flip horizontally for mirror effect
                canvasCtx.scale(-1, 1);
                canvasCtx.translate(-canvasElement.width, 0);
                canvasCtx.drawImage(
                    results.image, 0, 0, canvasElement.width, canvasElement.height
                );
                
                // Process face landmarks if detected
                if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                    const landmarks = results.multiFaceLandmarks[0];
                    empathicAgent.faceDetected = true;
                    empathicAgent.landmarksDetected = landmarks.length;
                    
                    // Draw key landmarks
                    drawEnhancedMediaPipeLandmarks(landmarks);
                    
                    // Analyze emotion
                    analyzeEnhancedEmotionFromLandmarks(landmarks);
                    
                    // Update detection status
                    updateFaceDetectionStatus();
                    
                } else {
                    empathicAgent.faceDetected = false;
                    empathicAgent.landmarksDetected = 0;
                }
                
                canvasCtx.restore();
            });
            
            console.log(" Google MediaPipe initialized successfully!");
        }

        // Enhanced landmark drawing
        function drawEnhancedMediaPipeLandmarks(landmarks) {
            // More detailed landmark drawing
            const KEY_LANDMARKS = {
                // EYEBROWS
                LEFT_BROW_INNER: 70,
                LEFT_BROW_MIDDLE: 63,
                LEFT_BROW_OUTER: 105,
                RIGHT_BROW_INNER: 336,
                RIGHT_BROW_MIDDLE: 296,
                RIGHT_BROW_OUTER: 334,
                
                // EYES
                LEFT_EYE_TOP: 159,
                LEFT_EYE_BOTTOM: 145,
                LEFT_EYE_LEFT: 33,
                LEFT_EYE_RIGHT: 133,
                RIGHT_EYE_TOP: 386,
                RIGHT_EYE_BOTTOM: 374,
                RIGHT_EYE_LEFT: 362,
                RIGHT_EYE_RIGHT: 263,
                
                // MOUTH (more detailed)
                MOUTH_LEFT_CORNER: 61,
                MOUTH_RIGHT_CORNER: 291,
                MOUTH_TOP_UPPER: 0,
                MOUTH_TOP_LOWER: 13,
                MOUTH_BOTTOM_UPPER: 14,
                MOUTH_BOTTOM_LOWER: 17,
                
                // NOSE
                NOSE_TIP: 1,
                NOSE_BRIDGE: 6,
                NOSE_BOTTOM: 2
            };
            
            // Draw eyes (Mickey Blue with highlights)
            canvasCtx.fillStyle = '#0066CC';
            canvasCtx.strokeStyle = '#FFFFFF';
            canvasCtx.lineWidth = 2;
            
            // Draw eye openings
            drawLandmarkCircle(landmarks[KEY_LANDMARKS.LEFT_EYE_TOP], 3);
            drawLandmarkCircle(landmarks[KEY_LANDMARKS.LEFT_EYE_BOTTOM], 3);
            drawLandmarkCircle(landmarks[KEY_LANDMARKS.RIGHT_EYE_TOP], 3);
            drawLandmarkCircle(landmarks[KEY_LANDMARKS.RIGHT_EYE_BOTTOM], 3);
            
            // Draw eyebrows (gradient based on emotion)
            const browColor = empathicAgent.currentEmotion === 'frustrated' ? '#FF3333' : 
                            empathicAgent.currentEmotion === 'surprised' ? '#FF9900' : '#FFCC00';
            canvasCtx.fillStyle = browColor;
            drawLandmarkCircle(landmarks[KEY_LANDMARKS.LEFT_BROW_MIDDLE], 4);
            drawLandmarkCircle(landmarks[KEY_LANDMARKS.RIGHT_BROW_MIDDLE], 4);
            drawLandmarkCircle(landmarks[KEY_LANDMARKS.LEFT_BROW_OUTER], 3);
            drawLandmarkCircle(landmarks[KEY_LANDMARKS.RIGHT_BROW_OUTER], 3);
            
            // Draw mouth (color based on emotion)
            let mouthColor;
            switch(empathicAgent.currentEmotion) {
                case 'happy': mouthColor = '#00CC00'; break;
                case 'sad': mouthColor = '#0066CC'; break;
                case 'frustrated': mouthColor = '#FF3333'; break;
                case 'surprised': mouthColor = '#FF9900'; break;
                default: mouthColor = '#E60000';
            }
            canvasCtx.fillStyle = mouthColor;
            drawLandmarkCircle(landmarks[KEY_LANDMARKS.MOUTH_LEFT_CORNER], 5);
            drawLandmarkCircle(landmarks[KEY_LANDMARKS.MOUTH_RIGHT_CORNER], 5);
            drawLandmarkCircle(landmarks[KEY_LANDMARKS.MOUTH_TOP_UPPER], 4);
            drawLandmarkCircle(landmarks[KEY_LANDMARKS.MOUTH_BOTTOM_LOWER], 4);
            
            // Draw nose
            canvasCtx.fillStyle = '#FF33CC';
            drawLandmarkCircle(landmarks[KEY_LANDMARKS.NOSE_TIP], 5);
            
            // Draw emotion indicator
            drawEmotionDebug(canvasCtx, landmarks);
        }
        
        function drawLandmarkCircle(landmark, radius) {
            if (!landmark) return;
            
            const x = landmark.x * canvasElement.width;
            const y = landmark.y * canvasElement.height;
            
            canvasCtx.beginPath();
            canvasCtx.arc(x, y, radius, 0, 2 * Math.PI);
            canvasCtx.fill();
            canvasCtx.stroke();
        }
        
        function drawEmotionDebug(ctx, landmarks) {
            if (!empathicAgent.faceDetected) return;
            
            ctx.font = '14px Arial';
            ctx.fillStyle = '#FFFFFF';
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;
            
            const text = `${empathicAgent.currentEmotion} (${Math.round(empathicAgent.emotionConfidence * 100)}%)`;
            const x = 10;
            const y = 30;
            
            // Background for text
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.fillRect(x - 5, y - 20, ctx.measureText(text).width + 10, 25);
            
            // Text
            ctx.fillStyle = '#FFFFFF';
            ctx.fillText(text, x, y);
        }

        function analyzeEnhancedEmotionFromLandmarks(landmarks) {
            if (!landmarks || landmarks.length < 468) return; // If there arent 468 face points, stop.
            
            //LANDMARK INDICES
            const LANDMARK_INDICES = {
                // EYEBROWS
                LEFT_BROW_INNER: 70,
                LEFT_BROW_MIDDLE: 63,
                LEFT_BROW_OUTER: 105,
                RIGHT_BROW_INNER: 336,
                RIGHT_BROW_MIDDLE: 296,
                RIGHT_BROW_OUTER: 334,
                
                // EYES
                LEFT_EYE_TOP: 159,
                LEFT_EYE_BOTTOM: 145,
                LEFT_EYE_LEFT: 33,
                LEFT_EYE_RIGHT: 133,
                RIGHT_EYE_TOP: 386,
                RIGHT_EYE_BOTTOM: 374,
                RIGHT_EYE_LEFT: 362,
                RIGHT_EYE_RIGHT: 263,
                
                // MOUTH
                MOUTH_LEFT_CORNER: 61,
                MOUTH_RIGHT_CORNER: 291,
                MOUTH_TOP_UPPER: 0,
                MOUTH_TOP_LOWER: 13,
                MOUTH_BOTTOM_UPPER: 14,
                MOUTH_BOTTOM_LOWER: 17,
                MOUTH_CENTER_TOP: 13,
                MOUTH_CENTER_BOTTOM: 14,
                
                // NOSE
                NOSE_TIP: 1,
                NOSE_BRIDGE: 6,
                NOSE_BOTTOM: 2,
                
                // FACE CONTOUR
                CHIN: 152,
                FOREHEAD: 10,
            };
            
            const get = (index) => landmarks[index];
            
            // ============================================
            // ENHANCED FACIAL FEATURE CALCULATIONS
            // ============================================
            
            // 1. MOUTH ANALYSIS
            const mouthLeft = get(LANDMARK_INDICES.MOUTH_LEFT_CORNER);
            const mouthRight = get(LANDMARK_INDICES.MOUTH_RIGHT_CORNER);
            const mouthTop = get(LANDMARK_INDICES.MOUTH_TOP_UPPER);
            const mouthBottom = get(LANDMARK_INDICES.MOUTH_BOTTOM_LOWER);
            const mouthCenterTop = get(LANDMARK_INDICES.MOUTH_CENTER_TOP);
            const mouthCenterBottom = get(LANDMARK_INDICES.MOUTH_CENTER_BOTTOM);
            
            const mouthWidth = Math.abs(mouthRight.x - mouthLeft.x);
            const mouthHeight = Math.abs(mouthBottom.y - mouthTop.y);
            const mouthOpenness = Math.abs(mouthCenterBottom.y - mouthCenterTop.y);
            const mouthRatio = mouthHeight / (mouthWidth + 0.001);
            
            // Mouth curvature (smile/frown detection)
            const mouthCornersAvgY = (mouthLeft.y + mouthRight.y) / 2;
            const mouthCenterY = (mouthTop.y + mouthBottom.y) / 2;
            const mouthCurvature = mouthCornersAvgY - mouthCenterY; //If conrners are higher than center, it's a smile. Otherwise, a frown.
            
            // 2. EYEBROW ANALYSIS
            const leftBrowMiddle = get(LANDMARK_INDICES.LEFT_BROW_MIDDLE);
            const rightBrowMiddle = get(LANDMARK_INDICES.RIGHT_BROW_MIDDLE);
            const leftBrowInner = get(LANDMARK_INDICES.LEFT_BROW_INNER);
            const rightBrowInner = get(LANDMARK_INDICES.RIGHT_BROW_INNER);
            const leftBrowOuter = get(LANDMARK_INDICES.LEFT_BROW_OUTER);
            const rightBrowOuter = get(LANDMARK_INDICES.RIGHT_BROW_OUTER);
            
            const browHeight = (leftBrowMiddle.y + rightBrowMiddle.y) / 2;
            const browTiltLeft = leftBrowOuter.y - leftBrowInner.y;
            const browTiltRight = rightBrowOuter.y - rightBrowInner.y;
            const browAsymmetry = Math.abs(leftBrowMiddle.y - rightBrowMiddle.y);
            const browRaise = (browTiltLeft + browTiltRight) / 2;
            
            // 3. EYE ANALYSIS
            const leftEyeOpen = Math.abs(
                get(LANDMARK_INDICES.LEFT_EYE_BOTTOM).y - 
                get(LANDMARK_INDICES.LEFT_EYE_TOP).y
            );
            const rightEyeOpen = Math.abs(
                get(LANDMARK_INDICES.RIGHT_EYE_BOTTOM).y - 
                get(LANDMARK_INDICES.RIGHT_EYE_TOP).y
            );
            const eyeOpenness = (leftEyeOpen + rightEyeOpen) / 2;
            
            // Eye squint ratio
            const leftEyeWidth = Math.abs(
                get(LANDMARK_INDICES.LEFT_EYE_RIGHT).x - 
                get(LANDMARK_INDICES.LEFT_EYE_LEFT).x
            );
            const leftEyeSquint = leftEyeOpen / (leftEyeWidth + 0.001);
            
            // 4. NOSE-TO-MOUTH DISTANCE
            const noseTip = get(LANDMARK_INDICES.NOSE_TIP);
            const noseToMouth = mouthTop ? Math.abs(mouthTop.y - noseTip.y) : 0;
            
            // 5. HEAD TILT
            const chin = get(LANDMARK_INDICES.CHIN);
            const forehead = get(LANDMARK_INDICES.FOREHEAD);
            const headTilt = forehead ? Math.atan2(
                chin.y - forehead.y,
                chin.x - forehead.x
            ) : 0;
            
            // ============================================
            // ENHANCED EMOTION SCORING SYSTEM
            // ============================================
            
            const emotionScores = {
                happy: 0,
                sad: 0,
                surprised: 0,
                frustrated: 0,
                focused: 0,
                confused: 0,
                bored: 0,
                neutral: 0.5
            };
            
            // Calculate scores for each emotion based on multiple features
            console.log(` Face Metrics: 
            MouthCurve=${mouthCurvature.toFixed(3)}, 
            MouthRatio=${mouthRatio.toFixed(3)}, 
            EyeOpen=${eyeOpenness.toFixed(3)}, 
            EyeSquint=${leftEyeSquint.toFixed(3)},
            BrowHeight=${browHeight.toFixed(3)}, 
            BrowAsym=${browAsymmetry.toFixed(3)},
            HeadTilt=${headTilt.toFixed(3)}`);

            // HAPPY: Smiling mouth, raised cheeks
            if (mouthCurvature > 0.04) emotionScores.happy += 0.4;
            if (mouthRatio < 0.31) emotionScores.happy += 0.3;
            if (eyeOpenness > 0.025) emotionScores.happy += 0.2;
            if (browHeight < 0.45) emotionScores.happy += 0.1;
            
            // SAD: Downturned mouth, inner brows raised
            if (mouthCurvature < -0.015) emotionScores.sad += 0.4;
            if (browTiltLeft > 0.02 && browTiltRight > 0.02) emotionScores.sad += 0.3;
            if (eyeOpenness < 0.02) emotionScores.sad += 0.2;
            if (headTilt > 0.1) emotionScores.sad += 0.1;
            
            // SURPRISED: Wide eyes, raised brows, open mouth
            if (eyeOpenness > 0.035) emotionScores.surprised += 0.3;
            if (browHeight < 0.3) emotionScores.surprised += 0.3;
            if (mouthOpenness > 0.04) emotionScores.surprised += 0.2;
            if (mouthRatio > 0.3) emotionScores.surprised += 0.2;
            
            // FRUSTRATED: Furrowed brows, narrowed eyes, tight mouth
            if (browHeight > 0.4 && browTiltLeft > 0 && browTiltRight > 0) emotionScores.frustrated += 0.4;
            if (leftEyeSquint < 0.2) emotionScores.frustrated += 0.3;
            if (mouthRatio > 0.35 && mouthCurvature < 0) emotionScores.frustrated += 0.3;
            
            // FOCUSED: Squinted eyes, neutral mouth, slight head tilt
            if (leftEyeSquint < 0.15) emotionScores.focused += 0.4;
            if (Math.abs(mouthCurvature) < 0.01) emotionScores.focused += 0.3;
            if (Math.abs(headTilt) > 0.05) emotionScores.focused += 0.2;
            if (browAsymmetry < 0.02) emotionScores.focused += 0.1;
            
            // CONFUSED: Asymmetric brows, tilted head
            if (browAsymmetry > 0.03) emotionScores.confused += 0.4;
            if (Math.abs(headTilt) > 0.08) emotionScores.confused += 0.3;
            if (mouthOpenness > 0.02 && mouthOpenness < 0.035) emotionScores.confused += 0.2;
            
            // BORED: Droopy eyes, neutral mouth, relaxed brows
            if (eyeOpenness < 0.018) emotionScores.bored += 0.4;
            if (browHeight > 0.38) emotionScores.bored += 0.3;
            if (Math.abs(mouthCurvature) < 0.005 && mouthRatio < 0.25) emotionScores.bored += 0.3;
            
            // NEUTRAL: Everything in middle ranges
            if (Math.abs(mouthCurvature) < 0.01) emotionScores.neutral += 0.3;
            if (eyeOpenness > 0.02 && eyeOpenness < 0.03) emotionScores.neutral += 0.3;
            if (browHeight > 0.35 && browHeight < 0.4) emotionScores.neutral += 0.2;
            if (mouthRatio > 0.2 && mouthRatio < 0.3) emotionScores.neutral += 0.2;
            
            // Find highest scoring emotion
            let maxScore = 0;
            let detectedEmotion = "neutral";
            let confidence = 0.5;
            
            for (const [emote, score] of Object.entries(emotionScores)) {
                if (score > maxScore) {
                    maxScore = score;
                    detectedEmotion = emote;
                    confidence = Math.min(0.95, score);
                }
            }
            
            // Apply confidence threshold
            if (maxScore < 0.6) {
                detectedEmotion = "neutral";
                confidence = 0.5;
            }
            
            // Update with temporal smoothing
            updateEmotionWithSmoothing(detectedEmotion, confidence, {
                mouthCurvature,
                eyeOpenness,
                browHeight,
                headTilt
            });
        }
        
        function updateEmotionWithSmoothing(newEmotion, confidence, features) {
            const now = Date.now();
            
            // Add to history
            emotionHistory.push({
                emotion: newEmotion,
                confidence: confidence,
                timestamp: now,
                features: features
            });
            
            // Keep only recent history
            while (emotionHistory.length > MAX_HISTORY) {
                emotionHistory.shift();
            }
            
            // Calculate weighted emotion based on history
            if (emotionHistory.length >= 3) {
                const recentEmotions = emotionHistory.slice(-5);
                const emotionCounts = {};
                let totalWeight = 0;
                
                recentEmotions.forEach((entry, index) => {
                    const weight = 0.7 * (index / recentEmotions.length);
                    emotionCounts[entry.emotion] = (emotionCounts[entry.emotion] || 0) + weight;
                    totalWeight += weight;
                });
                
                // Find most common emotion in recent history
                let smoothedEmotion = newEmotion;
                let maxCount = 0;
                for (const [emote, count] of Object.entries(emotionCounts)) {
                    if (count > maxCount) {
                        maxCount = count;
                        smoothedEmotion = emote;
                    }
                }
                
                // Use smoothed emotion if it appears consistently
                if (maxCount > totalWeight * 0.6 && smoothedEmotion !== newEmotion) {
                    newEmotion = smoothedEmotion;
                }
            }
            
            // Update display if emotion changed
            if (empathicAgent.currentEmotion !== newEmotion) {
                empathicAgent.previousEmotion = empathicAgent.currentEmotion;
                empathicAgent.currentEmotion = newEmotion;
                empathicAgent.emotionConfidence = confidence;
                lastEmotionUpdate = now;
                
                // Track consecutive negative emotions
                if (["frustrated", "sad", "bored", "confused"].includes(newEmotion)) {
                    empathicAgent.consecutiveNegativeFrames++;
                } else {
                    empathicAgent.consecutiveNegativeFrames = Math.max(0, empathicAgent.consecutiveNegativeFrames - 1);
                }
                
                // Update focus based on emotion
                if (newEmotion === "focused") {
                    empathicAgent.focusLevel = Math.min(100, empathicAgent.focusLevel + 2);
                } else if (newEmotion === "happy") {
                    empathicAgent.focusLevel = Math.min(100, empathicAgent.focusLevel + 1);
                } else if (newEmotion === "distracted") {
                    empathicAgent.focusLevel = Math.max(10, empathicAgent.focusLevel - 3);
                }
                
                // Check for proactive interventions
                checkForProactiveIntervention();
            }
        }

        // Start ENHANCED MediaPipe face detection
        async function startRealMediaPipeDetection() {
            try {
                console.log(" Starting camera for ENHANCED Google MediaPipe detection...");
                
                // Stop any previous detection
                if (isCameraStarted && videoElement.srcObject) {
                    videoElement.srcObject.getTracks().forEach(track => track.stop());
                }
                
                // Request camera access
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user'
                    },
                    audio: false
                });
                
                // Set up video element
                videoElement.srcObject = stream;
                
                // Wait for video metadata to load
                await new Promise((resolve) => {
                    videoElement.onloadedmetadata = () => {
                        videoElement.play().then(resolve);
                    };
                });
                
                // Set canvas dimensions AFTER video is ready
                canvasElement.width = videoElement.videoWidth;
                canvasElement.height = videoElement.videoHeight;
                
                // Start detection
                isDetectionActive = true;
                isCameraStarted = true;
                empathicAgent.isCameraActive = true;
                
                // Update UI
                updateCameraStatusDisplay();
                
                document.getElementById('btn-text').textContent = "MEDIAPIPE ACTIVE";
                document.getElementById('btn-icon').className = "fas fa-check-circle";
                
                // Start detection loop
                detectionLoop();
                
                document.getElementById('status-text').innerHTML = 
                    `<span style="color: var(--mickey-red);">
                         <strong>ENHANCED MEDIAPIPE ACTIVE!</strong><br>
                        Advanced 468-point face landmark detection!<br>
                        <small style="color: var(--mickey-blue);">(${currentGame ? 'Game mode' : 'Manual mode'})</small>
                    </span>`;
                
                console.log(` ENHANCED MediaPipe detection started! (Triggered by: ${currentGame ? 'Game' : 'Manual'})`);
                
            } catch (error) {
                console.error(" Camera access error:", error);
                
                // Fallback to simulated detection
                startSimulatedDetection();
            }
        }
        
        function startSimulatedDetection() {
            console.log(" Using simulated detection (fallback)");
            
            // Create simulated face display
            const container = document.querySelector('.face-detection-container');
            if (container) {
                container.innerHTML = `
                    <div style="width: 100%; height: 100%; background: linear-gradient(145deg, #ffcc99, #ff9966); 
                                display: flex; align-items: center; justify-content: center; position: relative;">
                        <div style="text-align: center; padding: 20px; color: var(--mickey-black);">
                            <div style="font-size: 4rem; margin-bottom: 10px;">
                                <i class="fas fa-smile-beam"></i>
                            </div>
                            <div style="font-weight: bold; color: var(--mickey-red);">
                                Simulated Emotion Detection
                            </div>
                            <div style="margin-top: 10px; font-size: 0.9rem;">
                                (MediaPipe unavailable - using simulation)
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Simulate detection updates
            setInterval(() => {
                if (isDetectionActive) {
                    empathicAgent.landmarksDetected = 468;
                    empathicAgent.faceDetected = true;
                    
                    // Cycle through emotions for demonstration
                    const emotions = ['happy', 'neutral', 'focused', 'confused', 'frustrated'];
                    const randomEmotion = emotions[Math.floor(Math.random() * emotions.length)];
                    empathicAgent.currentEmotion = randomEmotion;
                    empathicAgent.emotionConfidence = 0.7 + Math.random() * 0.3;
                    empathicAgent.focusLevel = 60 + Math.random() * 30;
                    
                    updateFaceDetectionStatus();
                }
            }, 3000);
        }

        function updateCameraBubbleStatus() {
            const cameraBubble = document.getElementById('side-camera');
            if (isCameraStarted) {
                cameraBubble.style.animation = 'pulse 2s infinite';
                cameraBubble.innerHTML = '<i class="fas fa-camera" style="color: #00cc00;"></i>';
            } else {
                cameraBubble.style.animation = 'none';
                cameraBubble.innerHTML = '<i class="fas fa-camera"></i>';
            }
        }

        async function detectionLoop() {
            if (!isDetectionActive || !isCameraStarted) return;
            
            try {
                await faceMesh.send({ image: videoElement });
                requestAnimationFrame(detectionLoop);
            } catch (error) {
                console.error("Detection loop error:", error);
                requestAnimationFrame(detectionLoop);
            }
        }

        // Update face detection status display
        function updateFaceDetectionStatus() {
            const statusElement = document.getElementById('status-text');
            
            if (empathicAgent.faceDetected && empathicAgent.landmarksDetected > 0) {
                statusElement.innerHTML = `
                    <span style="color: var(--mickey-red);">
                         <strong>ENHANCED FACE DETECTED!</strong><br>
                         ${empathicAgent.landmarksDetected} MediaPipe landmarks<br>
                         ${empathicAgent.currentEmotion.toUpperCase()} (${Math.round(empathicAgent.emotionConfidence * 100)}% confidence)<br>
                         Focus Level: ${empathicAgent.focusLevel}%
                    </span>
                `;
            }
        }
        
        // Simulated face detection (fallback)
        function simulateFaceDetection() {
            console.log(" Using simulated detection (fallback)");
            
            // Simulate detection updates
            setInterval(() => {
                empathicAgent.landmarksDetected = 468;
                empathicAgent.faceDetected = true;
                updateFaceDetectionStatus();
            }, 2000);
        }
        
        // Update face detection status display
        function updateFaceDetectionStatus() {
            const statusElement = document.getElementById('status-text');
            
            if (empathicAgent.faceDetected && empathicAgent.landmarksDetected > 0) {
                statusElement.innerHTML = `
                    <span style="color: var(--mickey-red);">
                         <strong>ENHANCED FACE DETECTED!</strong><br>
                         ${empathicAgent.landmarksDetected} MediaPipe landmarks<br>
                         ${studentEmotion.toUpperCase()}<br>
                         Focus Level: ${empathicAgent.focusLevel}%
                    </span>
                `;
            }
        }

        // ============================================
        // BACKGROUND CAMERA MANAGEMENT
        // ============================================

        let isCameraRunningInBackground = false;
        let cameraStatusIndicator = null;

        // Initialize camera status indicator
        function initCameraStatusIndicator() {
            cameraStatusIndicator = document.getElementById('camera-status-indicator');
            updateCameraStatusDisplay();
        }

        // Update camera status display
        function updateCameraStatusDisplay() {
            const cameraStatusBadge = document.getElementById('camera-status-badge');
            const cameraBubble = document.getElementById('side-camera');
            
            if (isCameraStarted) {
                // Show status indicator
                if (cameraStatusIndicator) {
                    cameraStatusIndicator.style.display = 'block';
                }
                
                // Update badge in camera panel
                if (cameraStatusBadge) {
                    cameraStatusBadge.textContent = 'ACTIVE';
                    cameraStatusBadge.style.background = '#00cc00';
                }
                
                // Update camera bubble
                if (cameraBubble) {
                    cameraBubble.innerHTML = '<i class="fas fa-camera" style="color: #00cc00;"></i>';
                    cameraBubble.style.animation = 'pulse 2s infinite';
                    cameraBubble.title = 'Camera active (click to view)';
                }
                
            } else {
                // Hide status indicator
                if (cameraStatusIndicator) {
                    cameraStatusIndicator.style.display = 'none';
                }
                
                // Update badge in camera panel
                if (cameraStatusBadge) {
                    cameraStatusBadge.textContent = 'INACTIVE';
                    cameraStatusBadge.style.background = 'var(--mickey-red)';
                }
                
                // Update camera bubble
                if (cameraBubble) {
                    cameraBubble.innerHTML = '<i class="fas fa-camera"></i>';
                    cameraBubble.style.animation = 'none';
                    cameraBubble.title = 'Camera Controls';
                }
            }
            
            // Update settings display
            updateSettingsDisplay();
        }

        // Close camera content (without stopping detection)
        function closeCameraContent() {
            const cameraContent = document.getElementById('camera-content');
            if (cameraContent) {
                cameraContent.classList.remove('active');
            }
            
            console.log(" Camera panel closed (detection continues for active game)");
            // DON'T call stopCameraDetection() here!
        }

        // Stop camera detection (only when game ends)
        function stopCameraDetection() {
            if (isCameraStarted && videoElement.srcObject) {
                videoElement.srcObject.getTracks().forEach(track => track.stop());
                videoElement.srcObject = null;
                
                // Update state
                isDetectionActive = false;
                isCameraStarted = false;
                isCameraRunningInBackground = false;
                empathicAgent.isCameraActive = false;
                
                // Clear canvas
                const canvasCtx = canvasElement.getContext('2d');
                canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
                
                // Update UI
                document.getElementById('btn-text').textContent = "START ENHANCED MEDIAPIPE";
                document.getElementById('btn-icon').className = "fas fa-play-circle";
                
                document.getElementById('status-text').innerHTML = 
                    `<span style="color: var(--mickey-blue);">Click START to begin ENHANCED 468-point face landmark detection!</span>`;
                
                // Update displays
                updateCameraStatusDisplay();
                
                console.log(" Camera detection stopped (game ended)");
            }
        }

        // Start camera detection
        async function startRealMediaPipeDetection() {
            try {
                console.log(" Starting camera for ENHANCED Google MediaPipe detection...");
                
                // Stop any previous detection
                if (isCameraStarted && videoElement.srcObject) {
                    videoElement.srcObject.getTracks().forEach(track => track.stop());
                }
                
                // Request camera access
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user'
                    },
                    audio: false
                });
                
                // Set up video element
                videoElement.srcObject = stream;
                
                // Wait for video metadata to load
                await new Promise((resolve) => {
                    videoElement.onloadedmetadata = () => {
                        videoElement.play().then(resolve);
                    };
                });
                
                // Set canvas dimensions AFTER video is ready
                canvasElement.width = videoElement.videoWidth;
                canvasElement.height = videoElement.videoHeight;
                
                // Start detection
                isDetectionActive = true;
                isCameraStarted = true;
                isCameraRunningInBackground = true;
                empathicAgent.isCameraActive = true;
                
                // Update UI
                updateCameraStatusDisplay();
                
                document.getElementById('btn-text').textContent = "MEDIAPIPE ACTIVE";
                document.getElementById('btn-icon').className = "fas fa-check-circle";
                
                // Start detection loop
                detectionLoop();
                
                document.getElementById('status-text').innerHTML = 
                    `<span style="color: var(--mickey-red);">
                         <strong>ENHANCED MEDIAPIPE ACTIVE!</strong><br>
                        Advanced 468-point face landmark detection!<br>
                        <small style="color: var(--mickey-blue);">(Detection continues even when panel is closed)</small>
                    </span>`;
                
                console.log(" ENHANCED MediaPipe detection started successfully!");
                
            } catch (error) {
                console.error(" Camera access error:", error);
                
                document.getElementById('status-text').innerHTML = 
                    `<span style="color: var(--mickey-red);">
                         Camera permission denied.<br>
                        Using simulated detection for demonstration.
                    </span>`;
                
                // Fallback to simulated detection
                startSimulatedDetection();
            }
        }

        // ============================================
        // DYSLEXIA SUPPORT FUNCTIONS
        // ============================================

        // Multi-sensory learning functions
        function showVisualClue(gameName, activityIndex) {
            const game = learningGames[gameName];
            const activity = game.activities[activityIndex];
            
            let visualClue = '';
            
            if (gameName === 'math') {
                if (activity.visual_aid) {
                    visualClue = `
                        <div style="text-align: center; padding: 20px;">
                            <div style="font-size: 3rem; margin-bottom: 15px;">
                                ${activity.visual_aid}
                            </div>
                            <div style="font-family: 'OpenDyslexic', sans-serif; color: var(--mickey-blue);">
                                Count the objects together!
                            </div>
                        </div>
                    `;
                }
            } else if (gameName === 'reading') {
                visualClue = `
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 4rem; margin-bottom: 15px;">
                            
                        </div>
                        <div style="font-family: 'OpenDyslexic', sans-serif; color: var(--mickey-blue);">
                            Imagine the story like a movie!
                        </div>
                    </div>
                `;
            }
            
            if (visualClue) {
                showNotification("Visual Clue", visualClue, "info");
            }
        }

        function tapToCount() {
            // Create interactive counting interface
            const countingArea = document.createElement('div');
            countingArea.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: var(--mickey-white);
                padding: 30px;
                border-radius: 25px;
                border: 5px solid var(--mickey-black);
                z-index: 10002;
                text-align: center;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            `;
            
            countingArea.innerHTML = `
                <h3 style="color: var(--mickey-red); margin-bottom: 20px;">
                    <i class="fas fa-hand-point-up"></i> Tap to Count
                </h3>
                <div id="counting-display" style="font-size: 4rem; margin: 20px 0;">0</div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px;">
                    ${Array.from({length: 9}, (_, i) => `
                        <button class="count-btn" data-number="${i+1}" 
                                style="padding: 20px; font-size: 1.5rem; background: var(--mickey-yellow); border: 3px solid var(--mickey-black); border-radius: 10px; cursor: pointer;">
                            ${i+1}
                        </button>
                    `).join('')}
                </div>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button onclick="resetCount()" style="padding: 10px 20px; background: var(--mickey-blue); color: white; border: none; border-radius: 10px; cursor: pointer;">
                        Reset
                    </button>
                    <button onclick="document.body.removeChild(this.parentElement.parentElement)" 
                            style="padding: 10px 20px; background: var(--mickey-red); color: white; border: none; border-radius: 10px; cursor: pointer;">
                        Close
                    </button>
                </div>
            `;
            
            document.body.appendChild(countingArea);
            
            // Add counting functionality
            countingArea.querySelectorAll('.count-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const number = parseInt(this.getAttribute('data-number'));
                    const display = document.getElementById('counting-display');
                    const current = parseInt(display.textContent);
                    display.textContent = current + number;
                    
                    // Visual feedback
                    this.style.transform = 'scale(0.9)';
                    setTimeout(() => {
                        this.style.transform = 'scale(1)';
                    }, 100);
                    
                    // Audio feedback
                    if ('speechSynthesis' in window) {
                        const utterance = new SpeechSynthesisUtterance((current + number).toString());
                        utterance.rate = 0.8;
                        speechSynthesis.speak(utterance);
                    }
                });
            });
        }

        function resetCount() {
            const display = document.getElementById('counting-display');
            if (display) {
                display.textContent = '0';
            }
        }

        function breakItDown(gameName, activityIndex) {
            const game = learningGames[gameName];
            const activity = game.activities[activityIndex];
            
            let steps = [];
            
            if (gameName === 'math') {
                steps = [
                    "1. Read the problem slowly",
                    "2. Find the numbers",
                    "3. Look for key words (more, less, total)",
                    "4. Choose + or -",
                    "5. Solve step by step",
                    "6. Check your answer"
                ];
            } else if (gameName === 'reading') {
                steps = [
                    "1. Look at pictures first",
                    "2. Read one sentence at a time",
                    "3. Use your finger to track",
                    "4. Break long words into parts",
                    "5. Sound out tricky words",
                    "6. Think about what it means"
                ];
            }
            
            if (steps.length > 0) {
                const stepsHTML = steps.map(step => `
                    <div style="padding: 10px; background: white; margin-bottom: 8px; border-radius: 8px; border-left: 4px solid var(--mickey-blue);">
                        ${step}
                    </div>
                `).join('');
                
                showNotification("Step-by-Step Guide", stepsHTML, "info");
            }
        }

        function readStoryAloud(storyText) {
            if ('speechSynthesis' in window) {
                const sentences = storyText.split('.');
                let currentSentence = 0;
                
                function readNextSentence() {
                    if (currentSentence < sentences.length) {
                        const sentence = sentences[currentSentence].trim();
                        if (sentence) {
                            const utterance = new SpeechSynthesisUtterance(sentence + '.');
                            utterance.rate = 0.8;
                            utterance.pitch = 1.0;
                            
                            // Highlight current sentence being read
                            const sentenceBlocks = document.querySelectorAll('.sentence-block');
                            if (sentenceBlocks[currentSentence]) {
                                sentenceBlocks.forEach(block => block.style.background = 'white');
                                sentenceBlocks[currentSentence].style.background = '#ffffcc';
                                sentenceBlocks[currentSentence].style.borderColor = 'var(--mickey-yellow)';
                            }
                            
                            utterance.onend = function() {
                                currentSentence++;
                                setTimeout(readNextSentence, 500);
                            };
                            
                            speechSynthesis.speak(utterance);
                        } else {
                            currentSentence++;
                            readNextSentence();
                        }
                    }
                }
                
                readNextSentence();
            }
        }

        function highlightSentence() {
            const sentenceBlocks = document.querySelectorAll('.sentence-block');
            let currentHighlight = 0;
            
            sentenceBlocks.forEach(block => {
                block.style.background = 'white';
                block.style.borderColor = '#e0e0e0';
            });
            
            // Create moving highlight
            const highlightInterval = setInterval(() => {
                if (currentHighlight > 0) {
                    sentenceBlocks[currentHighlight - 1].style.background = 'white';
                    sentenceBlocks[currentHighlight - 1].style.borderColor = '#e0e0e0';
                }
                
                if (currentHighlight < sentenceBlocks.length) {
                    sentenceBlocks[currentHighlight].style.background = '#ffffcc';
                    sentenceBlocks[currentHighlight].style.borderColor = 'var(--mickey-yellow)';
                    currentHighlight++;
                } else {
                    clearInterval(highlightInterval);
                }
            }, 1500);
        }

        function increaseSpacing() {
            const storyText = document.querySelector('.dyslexia-story-text');
            if (storyText) {
                const currentSpacing = parseFloat(getComputedStyle(storyText).letterSpacing) || 0;
                storyText.style.letterSpacing = (currentSpacing + 0.05) + 'em';
                storyText.style.wordSpacing = (parseFloat(getComputedStyle(storyText).wordSpacing) || 0) + 5 + 'px';
                storyText.style.lineHeight = '2.5';
            }
        }

        function showPictureClues() {
            const storyClues = [
                " (morning)",
                " (clothing)",
                " (eating)",
                " (walking)",
                " (Minnie)"
            ];
            
            const cluesHTML = `
                <div style="text-align: center;">
                    <h4 style="color: var(--mickey-red); margin-bottom: 15px;">
                        <i class="fas fa-images"></i> Picture Clues
                    </h4>
                    <div style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
                        ${storyClues.map(clue => `
                            <div style="font-size: 2rem; padding: 15px; background: #f0f8ff; border-radius: 10px; border: 3px solid var(--mickey-blue);">
                                ${clue}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            showNotification("Story Picture Clues", cluesHTML, "info");
        }

        function answerStoryQuestion(questionIndex, answerIndex, gameName) {
            const game = learningGames[gameName];
            const activity = game.activities[currentActivityIndex];
            const question = activity.questions[questionIndex];
            
            if (answerIndex === question.correct) {
                // Correct answer
                showNotification("Correct!", `
                    <div style="text-align: center;">
                        <div style="font-size: 3rem; color: #00cc00; margin-bottom: 10px;">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div style="font-family: 'OpenDyslexic', sans-serif;">
                            ${question.explanation}
                        </div>
                    </div>
                `, "success");
                
                // Award points
                studentScore += 5;
                document.getElementById('student-points').textContent = studentScore;
            } else {
                // Incorrect answer
                showNotification("Try Again!", `
                    <div style="text-align: center;">
                        <div style="font-size: 3rem; color: #ff3333; margin-bottom: 10px;">
                            <i class="fas fa-times-circle"></i>
                        </div>
                        <div style="font-family: 'OpenDyslexic', sans-serif;">
                            The correct answer is: ${question.options[question.correct]}
                        </div>
                        ${question.visual_aid ? `
                            <div style="font-size: 2rem; margin-top: 10px;">
                                ${question.visual_aid}
                            </div>
                        ` : ''}
                    </div>
                `, "error");
            }
        }

        function trackDyslexiaProgress(gameName, difficulty, timeTaken, attempts) {
            // Store progress in localStorage
            const progressKey = `dyslexia_progress_${gameName}`;
            const currentProgress = JSON.parse(localStorage.getItem(progressKey)) || {
                attempts: 0,
                successes: 0,
                averageTime: 0,
                toolsUsed: [],
                difficulties: []
            };
            
            currentProgress.attempts++;
            currentProgress.difficulties.push(difficulty);
            
            // Calculate average time
            currentProgress.averageTime = 
                ((currentProgress.averageTime * (currentProgress.attempts - 1)) + timeTaken) / currentProgress.attempts;
            
            localStorage.setItem(progressKey, JSON.stringify(currentProgress));
            
            // Update display if on profile page
            updateDyslexiaProgressDisplay();
        }

        function updateDyslexiaProgressDisplay() {
            const progressContainer = document.getElementById('profile-content-area');
            if (progressContainer && progressContainer.classList.contains('active')) {
                // Add dyslexia progress section to profile
                let progressHTML = `
                    <div style="margin-top: 30px;">
                        <h4 style="color: var(--mickey-blue); margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-universal-access"></i> Dyslexia Progress
                        </h4>
                        <div style="background: var(--mickey-white); padding: 20px; border-radius: 15px; border: 3px solid var(--mickey-blue);">
                `;
                
                Object.keys(learningGames).forEach(gameName => {
                    const progressKey = `dyslexia_progress_${gameName}`;
                    const progress = JSON.parse(localStorage.getItem(progressKey));
                    
                    if (progress) {
                        const successRate = progress.attempts > 0 ? 
                            Math.round((progress.successes / progress.attempts) * 100) : 0;
                        
                        progressHTML += `
                            <div style="margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px dashed #e0e0e0;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div style="font-weight: bold; color: var(--mickey-red);">
                                        ${learningGames[gameName].title}
                                    </div>
                                    <div style="color: ${successRate > 70 ? '#00cc00' : successRate > 50 ? '#ff9900' : '#ff3333'};">
                                        ${successRate}% Success
                                    </div>
                                </div>
                                <div style="font-size: 0.9em; color: var(--mickey-black); margin-top: 5px;">
                                    Attempts: ${progress.attempts} | Tools used: ${progress.toolsUsed.length}
                                </div>
                            </div>
                        `;
                    }
                });
                
                progressHTML += `
                        </div>
                    </div>
                `;
                
                // Insert into profile
                const existingProgress = document.getElementById('dyslexia-progress-display');
                if (existingProgress) {
                    existingProgress.innerHTML = progressHTML;
                } else {
                    const progressDiv = document.createElement('div');
                    progressDiv.id = 'dyslexia-progress-display';
                    progressDiv.innerHTML = progressHTML;
                    progressContainer.querySelector('.student-profile').appendChild(progressDiv);
                }
            }
        }

        function toggleDyslexiaText(moduleType) {
            const activeContent = document.querySelector('.module-content-area.active .game-container');
            if (activeContent) {
                activeContent.classList.toggle('dyslexia-friendly');
                
                // Toggle dyslexia font
                if (activeContent.classList.contains('dyslexia-friendly')) {
                    document.body.classList.add('dyslexia-mode');
                    showNotification("Dyslexia Mode", "Dyslexia-friendly font enabled! ", "success");
                } else {
                    document.body.classList.remove('dyslexia-mode');
                }
            } else {
                // Apply to main content
                document.body.classList.toggle('dyslexia-mode');
                showNotification("Dyslexia Mode", 
                    document.body.classList.contains('dyslexia-mode') ? 
                    "Dyslexia-friendly font enabled globally! " : 
                    "Dyslexia-friendly font disabled.", 
                    "info");
            }
        }

        // Enable color overlay for reading
        function enableColorOverlay(moduleType) {
            const activeContent = document.querySelector('.module-content-area.active .game-container');
            if (activeContent) {
                // Remove existing overlays
                activeContent.classList.remove('color-overlay-yellow', 'color-overlay-blue', 'color-overlay-green');
                
                // Cycle through color options
                const colors = ['yellow', 'blue', 'green'];
                const currentColor = colors.find(color => 
                    activeContent.classList.contains(`color-overlay-${color}`)
                );
                
                let nextColor = 'yellow';
                if (currentColor) {
                    const currentIndex = colors.indexOf(currentColor);
                    nextColor = colors[(currentIndex + 1) % colors.length];
                }
                
                activeContent.classList.add(`color-overlay-${nextColor}`);
                showNotification("Color Overlay", `${nextColor.charAt(0).toUpperCase() + nextColor.slice(1)} overlay enabled! `, "info");
            }
        }

        // Enable line reader tool
        function enableLineReader(moduleType) {
            const activeContent = document.querySelector('.module-content-area.active .game-container');
            if (activeContent) {
                activeContent.classList.toggle('line-reader');
                
                if (activeContent.classList.contains('line-reader')) {
                    showNotification("Line Reader", "Line reader enabled! Follow the yellow line. ", "info");
                    
                    // Add click-to-move functionality
                    const questions = activeContent.querySelectorAll('.game-question, .dyslexia-story-text');
                    questions.forEach(question => {
                        question.style.cursor = 'pointer';
                        question.addEventListener('click', function(e) {
                            const line = this.querySelector('.reader-line');
                            if (line) {
                                line.remove();
                            } else {
                                const newLine = document.createElement('div');
                                newLine.className = 'reader-line';
                                newLine.style.cssText = `
                                    position: absolute;
                                    left: 0;
                                    right: 0;
                                    height: 24px;
                                    background: rgba(255, 255, 0, 0.2);
                                    border-top: 2px solid #ffcc00;
                                    border-bottom: 2px solid #ffcc00;
                                    pointer-events: none;
                                    z-index: 1;
                                `;
                                newLine.style.top = (e.offsetY - 12) + 'px';
                                this.style.position = 'relative';
                                this.appendChild(newLine);
                            }
                        });
                    });
                }
            }
        }

        // Read question aloud (Text-to-Speech)
        function readQuestionAloud() {
            if ('speechSynthesis' in window) {
                const questionElement = document.querySelector('.game-question');
                if (questionElement) {
                    // Remove any HTML tags and get clean text
                    const questionText = questionElement.textContent || questionElement.innerText;
                    
                    // Stop any ongoing speech
                    speechSynthesis.cancel();
                    
                    // Create and configure utterance
                    const utterance = new SpeechSynthesisUtterance(questionText);
                    utterance.rate = 0.8; // Slower speed for better comprehension
                    utterance.pitch = 1.0;
                    utterance.volume = 1;
                    
                    // Highlight words as they're spoken
                    const words = questionText.split(' ');
                    let currentWord = 0;
                    
                    utterance.onboundary = function(event) {
                        if (event.name === 'word') {
                            // Remove previous highlights
                            const highlighted = questionElement.querySelectorAll('.tts-highlight');
                            highlighted.forEach(el => {
                                el.classList.remove('tts-highlight');
                            });
                            
                            // Highlight current word
                            const wordElements = questionElement.textContent.split(' ');
                            // This is a simplified version - in production you'd need more sophisticated highlighting
                        }
                    };
                    
                    utterance.onend = function() {
                        // Remove all highlights when done
                        const highlighted = questionElement.querySelectorAll('.tts-highlight');
                        highlighted.forEach(el => {
                            el.classList.remove('tts-highlight');
                        });
                    };
                    
                    // Speak the question
                    speechSynthesis.speak(utterance);
                    
                    // Visual feedback
                    questionElement.classList.add('audio-playing');
                    setTimeout(() => {
                        questionElement.classList.remove('audio-playing');
                    }, 2000);
                    
                } else {
                    showNotification("Text-to-Speech", "No question found to read aloud.", "error");
                }
            } else {
                showNotification("Text-to-Speech", "Your browser doesn't support text-to-speech.", "error");
            }
        }

        // Simplify text for easier reading
        function simplifyText() {
            const questionElement = document.querySelector('.game-question');
            if (questionElement) {
                const originalText = questionElement.getAttribute('data-original') || questionElement.innerHTML;
                const currentText = questionElement.innerHTML;
                
                // Store original if not already stored
                if (!questionElement.getAttribute('data-original')) {
                    questionElement.setAttribute('data-original', currentText);
                }
                
                // Check if we're showing simplified or original
                if (questionElement.getAttribute('data-simplified') === 'true') {
                    // Show original
                    questionElement.innerHTML = originalText;
                    questionElement.setAttribute('data-simplified', 'false');
                    showNotification("Text Mode", "Showing original text", "info");
                } else {
                    // Create simplified version (this would be more sophisticated in production)
                    const simplified = currentText
                        .replace(/Mickey/g, 'Mickey Mouse')
                        .replace(/Minnie/g, 'Minnie Mouse')
                        .replace(/Donald/g, 'Donald Duck')
                        .replace(/Goofy/g, 'Goofy Dog')
                        .replace(/(\d+)/g, '<strong>$1</strong>');
                    
                    questionElement.innerHTML = `
                        <div class="simplified-text">
                            <div style="color: var(--mickey-blue); margin-bottom: 5px;">
                                <i class="fas fa-child"></i> Simplified Version:
                            </div>
                            ${simplified}
                        </div>
                    `;
                    questionElement.setAttribute('data-simplified', 'true');
                    showNotification("Text Mode", "Simplified text enabled", "success");
                }
            }
        }

        // Enhanced text highlighting for TTS
        function highlightSpokenWord(element, wordIndex) {
            const text = element.textContent;
            const words = text.split(' ');
            
            if (wordIndex < words.length) {
                let highlightedHTML = '';
                words.forEach((word, index) => {
                    if (index === wordIndex) {
                        highlightedHTML += `<span class="tts-highlight" style="
                            background: #ffff00 !important;
                            color: #000000 !important;
                            padding: 2px 5px;
                            border-radius: 3px;
                            animation: pulse-tts 1s infinite;
                        ">${word}</span> `;
                    } else {
                        highlightedHTML += `${word} `;
                    }
                });
                
                element.innerHTML = highlightedHTML;
            }
        }

        // Add missing CSS for dyslexia features
        const dyslexiaStyles = document.createElement('style');
        dyslexiaStyles.textContent = `
            @keyframes pulse-tts {
                0% { background-color: #ffff00; }
                50% { background-color: #ffcc00; }
                100% { background-color: #ffff00; }
            }
            
            .dyslexia-friendly .game-option {
                font-family: 'OpenDyslexic', sans-serif !important;
                font-size: 1.1em !important;
                line-height: 1.6 !important;
                padding: 20px 15px !important;
                text-align: left !important;
                border-left: 5px solid var(--mickey-blue) !important;
            }
            
            .dyslexia-friendly .game-question {
                font-family: 'OpenDyslexic', sans-serif !important;
                line-height: 1.8 !important;
                margin-bottom: 25px !important;
                background: #f0f8ff !important;
                padding: 20px !important;
                border-radius: 15px !important;
                border: 3px solid var(--mickey-yellow) !important;
            }
            
            .simplified-text {
                font-size: 1.2em !important;
                line-height: 1.8 !important;
                color: #000000 !important;
                background: #ffffff !important;
                padding: 15px !important;
                border-radius: 10px !important;
                border: 3px solid #0066cc !important;
            }
            
            .simplified-text p {
                margin-bottom: 15px !important;
            }
        `;
        document.head.appendChild(dyslexiaStyles);

        // Enhanced sensory buttons CSS
        const sensoryBtnStyle = document.createElement('style');
        sensoryBtnStyle.textContent = `
            .sensory-btn {
                padding: 10px 15px;
                background: var(--mickey-blue);
                color: white;
                border: 2px solid var(--mickey-black);
                border-radius: 10px;
                cursor: pointer;
                font-family: 'OpenDyslexic', sans-serif;
                font-size: 0.9em;
                display: flex;
                align-items: center;
                gap: 5px;
                transition: all 0.3s;
            }
            
            .sensory-btn:hover {
                background: var(--mickey-red);
                transform: scale(1.05);
            }
            
            .reading-tool-btn {
                padding: 10px 20px;
                background: var(--mickey-yellow);
                color: var(--mickey-black);
                border: 3px solid var(--mickey-black);
                border-radius: 10px;
                cursor: pointer;
                font-family: 'OpenDyslexic', sans-serif;
                font-weight: bold;
                transition: all 0.3s;
            }
            
            .reading-tool-btn:hover {
                background: var(--mickey-red);
                color: white;
                transform: translateY(-3px);
            }
            
            .story-option:hover {
                background: var(--mickey-blue) !important;
                color: white !important;
                transform: translateY(-3px);
            }
        `;
        document.head.appendChild(sensoryBtnStyle);

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        
        function addMickeyAvatarStyles() {
            const style = document.createElement('style');
            style.textContent = `
                .mickey-avatar-modal {
                    width: 80px;
                    height: 80px;
                    background: var(--mickey-red);
                    border-radius: 50%;
                    position: relative;
                    margin: 0 auto;
                    border: 4px solid var(--mickey-black);
                    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                }
                
                .mickey-ears-modal {
                    position: absolute;
                    top: -20px;
                    width: 30px;
                    height: 30px;
                    background: var(--mickey-red);
                    border-radius: 50%;
                    border: 3px solid var(--mickey-black);
                }
                
                .mickey-ears-modal.left {
                    left: -10px;
                }
                
                .mickey-ears-modal.right {
                    right: -10px;
                }
                
                .mickey-face-modal {
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    width: 50px;
                    height: 50px;
                    background: white;
                    border-radius: 50%;
                }
                
                .mickey-avatar-small {
                    width: 50px;
                    height: 50px;
                    background: var(--mickey-red);
                    border-radius: 50%;
                    position: relative;
                    border: 3px solid var(--mickey-white);
                }
                
                .mickey-ears-small {
                    position: absolute;
                    top: -10px;
                    width: 20px;
                    height: 20px;
                    background: var(--mickey-red);
                    border-radius: 50%;
                    border: 2px solid var(--mickey-white);
                }
                
                .mickey-ears-small.left {
                    left: -5px;
                }
                
                .mickey-ears-small.right {
                    right: -5px;
                }
                
                .mickey-face-small {
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    width: 30px;
                    height: 30px;
                    background: white;
                    border-radius: 50%;
                }
            `;
            
            document.head.appendChild(style);
        }
        
        function showNotification(title, message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 100px;
                right: 30px;
                background: var(--mickey-white);
                color: var(--mickey-black);
                padding: 15px 20px;
                border-radius: 15px;
                border: 3px solid var(--mickey-black);
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                z-index: 10000;
                font-family: 'Comic Neue', cursive;
                max-width: 300px;
                animation: slideInRight 0.3s ease;
            `;
            
            notification.innerHTML = `
                <strong style="color: var(--mickey-red); display: block; margin-bottom: 5px;">${title}</strong>
                <div>${message}</div>
            `;
            
            document.body.appendChild(notification);
            
            // Remove after 5 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 5000);
        }
        
        // ============================================
        // INITIALIZE ON LOAD
        // ============================================
        
        // Initialize when page loads
        window.addEventListener('load', initializeAll);
        
        // Make functions available globally
        window.startGame = startGame;
        window.viewModule = viewModule;
        window.checkAnswer = checkAnswer;
        window.nextActivity = nextActivity;
        window.previousActivity = previousActivity;
        window.closeModule = closeModule;
        window.startMickeyBreak = startMickeyBreak;
        window.endMickeyBreak = endMickeyBreak;
        window.makeGameEasier = makeGameEasier;
        window.skipToNext = skipToNext;
        window.explainDifferently = explainDifferently;
    </script>
</body>
</html>